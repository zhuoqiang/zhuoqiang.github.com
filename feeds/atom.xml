<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>道可叨</title><link href="http://zhuoqiang.me/" rel="alternate"></link><link href="http://zhuoqiang.me/feeds/atom.xml" rel="self"></link><id>http://zhuoqiang.me/</id><updated>2013-07-18T22:55:00+08:00</updated><entry><title>Goslate 免费谷歌翻译</title><link href="http://zhuoqiang.me/goslate-free-google-translate-api.html" rel="alternate"></link><updated>2013-07-18T22:55:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2013-07-18:goslate-free-google-translate-api.html</id><summary type="html">&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id11"&gt;起因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id12"&gt;使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id13"&gt;原理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id14"&gt;优化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id15"&gt;设计&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id8" id="id16"&gt;开源&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;起因&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;机器翻译虽然质量差，但胜在省时省力。网上常见的翻译系统中，谷歌的质量算好的。谷歌翻译不但提供在线界面，还开放了 API 让程序直接调用翻译。美中不足的是从 2012 年开始谷歌翻译 API 收费了。可这难不倒聪明的程序员，只要谷歌网站上的翻译是免费使用的，你总是可以写个爬虫自动从网站抓取翻译结果。我花了点功夫写了个爬虫，又把爬虫封装成了简单高效的 Python 库来免费使用谷歌翻译，这就是 &lt;a class="reference external" href="http://pythonhosted.org/goslate/"&gt;Goslate&lt;/a&gt; (&lt;em&gt;Go&lt;/em&gt;ogle Tran&lt;em&gt;slate&lt;/em&gt;) 。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;使用&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Goslate 支持 Python2.6 以上版本，包括 Python3！你可以通过 &lt;tt class="docutils literal"&gt;pip&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;easy_install&lt;/tt&gt; 安装&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;pip install goslate
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Goslate 目前只包含单个 python 文件，你也可以直接下载&lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/goslate/raw/tip/goslate.py"&gt;最新版本的 goslate.py&lt;/a&gt; 。使用很简单，下面是英译德的例子&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;goslate&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;goslate&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Goslate&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;gs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;translate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;hello world&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;de&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;hallo&lt;/span&gt; &lt;span class="n"&gt;welt&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;goslate.py&lt;/tt&gt; 不仅是一个 python 模块，它还是个命令行工具，你可以直接使用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;通过标准输入英译汉输出到屏幕&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;hello world&amp;quot;&lt;/span&gt; | goslate.py -t zh-CN
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;翻译两个文件，将结果用 UTF-8 编码保存到 out.txt&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;goslate.py -t zh-CN -o utf-8 src/1.txt &lt;span class="s2"&gt;&amp;quot;src 2.txt&amp;quot;&lt;/span&gt; &amp;gt; out.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多高级用法参看&lt;a class="reference external" href="http://pythonhosted.org/goslate/"&gt;文档&lt;/a&gt;。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;原理&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;要使用谷歌翻译官方 API 需要先付费获得 Key。如果 Key 非法，谷歌 API 就会返回错误禁止使用。那么 Goslate 怎么绕过 Key 的验证呢，难道走了后门？恰恰相反，Goslate 光明正大地走前门，也就是直接抓取谷歌翻译网站的结果。&lt;/p&gt;
&lt;p&gt;我们用浏览器去谷歌翻译 hello world，抓包发现，浏览器访问了这个 URL：&lt;/p&gt;
&lt;blockquote&gt;
&lt;a class="reference external" href="http://translate.google.com/translate_a/t?client=t&amp;amp;hl=en&amp;amp;sl=en&amp;amp;tl=zh-CN&amp;amp;ie=UTF-8&amp;amp;oe=UTF-8&amp;amp;multires=1&amp;amp;prev=conf&amp;amp;psl=en&amp;amp;ptl=en&amp;amp;otf=1&amp;amp;it=sel.2016&amp;amp;ssel=0&amp;amp;tsel=0&amp;amp;prev=enter&amp;amp;oc=3&amp;amp;ssel=0&amp;amp;tsel=0&amp;amp;sc=1&amp;amp;text=hello%20world"&gt;http://translate.google.com/translate_a/t?client=t&amp;amp;hl=en&amp;amp;sl=en&amp;amp;tl=zh-CN&amp;amp;ie=UTF-8&amp;amp;oe=UTF-8&amp;amp;multires=1&amp;amp;prev=conf&amp;amp;psl=en&amp;amp;ptl=en&amp;amp;otf=1&amp;amp;it=sel.2016&amp;amp;ssel=0&amp;amp;tsel=0&amp;amp;prev=enter&amp;amp;oc=3&amp;amp;ssel=0&amp;amp;tsel=0&amp;amp;sc=1&amp;amp;text=hello%20world&lt;/a&gt;&lt;/blockquote&gt;
&lt;p&gt;很容易看出源文本是作为 text 参数直接编码在 URL 中的。而相应的 tl 参数表示 translate language，这里是 zh-CN （简体中文）。&lt;/p&gt;
&lt;p&gt;谷歌翻译返回：&lt;/p&gt;
&lt;blockquote&gt;
{&amp;quot;sentences&amp;quot;:[{&amp;quot;trans&amp;quot;:&amp;quot;世界，你好！&amp;quot;,&amp;quot;orig&amp;quot;:&amp;quot;hello world!&amp;quot;,&amp;quot;translit&amp;quot;:&amp;quot;Shìjiè, nǐ hǎo!&amp;quot;,&amp;quot;src_translit&amp;quot;:&amp;quot;&amp;quot;},{&amp;quot;trans&amp;quot;:&amp;quot;认识你很高兴。&amp;quot;,&amp;quot;orig&amp;quot;:&amp;quot;nice to meet you.&amp;quot;,&amp;quot;translit&amp;quot;:&amp;quot;Rènshi nǐ hěn gāoxìng.&amp;quot;,&amp;quot;src_translit&amp;quot;:&amp;quot;&amp;quot;}],&amp;quot;src&amp;quot;:&amp;quot;en&amp;quot;,&amp;quot;server_time&amp;quot;:48}&lt;/blockquote&gt;
&lt;p&gt;格式类似 JSON，但不标准。其中不但有翻译结果，还包含汉语拼音和源文本的语言等附加信息，猜测这些可能是为了客户端的某些特殊功能。&lt;/p&gt;
&lt;p&gt;这个过程很简单，我们的爬虫逻辑是&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;先把源文本和目标语言组成类似上面的 URL&lt;/li&gt;
&lt;li&gt;再用 python 的 &lt;tt class="docutils literal"&gt;urllib2&lt;/tt&gt; 去到谷歌翻译站点上 &lt;tt class="docutils literal"&gt;HTTP GET&lt;/tt&gt; 结果&lt;/li&gt;
&lt;li&gt;拿到返回数据后再把翻译结果单独抽取出来&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;有一点要注意，谷歌很不喜欢 python 爬虫：） 它会禁掉所有 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;User-Agent&lt;/span&gt;&lt;/tt&gt; 是 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Python-urllib/2.7&lt;/span&gt;&lt;/tt&gt; 的 HTTP 请求。我们要&lt;a class="reference external" href="http://zhuoqiang.me/python-urllib2-usage.html#http-request-header"&gt;伪装成浏览器&lt;/a&gt; &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;User-Agent:&lt;/span&gt; Mozilla/4.0&lt;/tt&gt; 来让谷歌放心。另外还有一个小窍门，URL 中可将参数 &lt;tt class="docutils literal"&gt;client&lt;/tt&gt; 从 &lt;tt class="docutils literal"&gt;t&lt;/tt&gt; 改成其它值，返回的就是标准 JSON 格式，方便解析结果。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id14"&gt;优化&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;爬虫虽然工作正常，但有两个问题：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;短：受限于 URL 长度，只能翻译不超过 2000 字节的短文本。长文本需要手工分隔多次翻译&lt;/li&gt;
&lt;li&gt;慢：每次翻译都要一个 HTTP 网络应答，时间接近 1 秒，开销很大。以 8000 个短句的翻译为例，全部翻完就需要近 2 个小时&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;短的问题可用自动分拆，多次查询解决：对于长文本，Goslate 会在标点换行等分隔处把文本分拆为若干接近 2000 字节的子文本，再一一查询，最后将翻译结果拼接后返回用户。通过这种方式，Goslate 突破了文本长度的限制。&lt;/p&gt;
&lt;p&gt;慢的问题比较难，性能卡在网络延迟上。谷歌官方 API 可以一次传入多个文本进行批量翻译，大大减少了 HTTP 网络应答。Goslate 也支持批量翻译，既然一次查询最大允许 2000 字节的文本，那就尽量用足。用户传入多个文本后 Goslate 会把若干小文本尽量拼接成不超过 2000 字节的大文本，再通过一次 HTTP 请求进行翻译，最后将结果分拆成相应的若干翻译文本返回。&lt;/p&gt;
&lt;p&gt;这里可以看到，批量查询和长文本支持正好相反，批量查询是要拼接成大块后一次翻译再分拆结果，长文本支持是要拆分后多次翻译再拼接结果。如果批量查询中有某个文本过长，那它本身就要先被拆分，然后再和前后的小文本合并。看起来逻辑有些复杂，但其实只要功能合理分层实现就好了：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;最底层的 &lt;tt class="docutils literal"&gt;Goslate._basic_translate()&lt;/tt&gt; 具体负责通过 HTTP 请求翻译单个文本，不支持长文本分拆&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Goslate._translate_single_text()&lt;/tt&gt; 在 &lt;tt class="docutils literal"&gt;_basic_translate()&lt;/tt&gt; 基础上通过自动分拆多次查询支持长文本&lt;/li&gt;
&lt;li&gt;最后外部 API &lt;tt class="docutils literal"&gt;Goslate.translate()&lt;/tt&gt; 通过拼接后调用 &lt;tt class="docutils literal"&gt;_translate_single_text()&lt;/tt&gt; 来支持批量翻译&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;通过三层递进，复杂的拆分拼接逻辑就完美表达出来了。All problems in computer science can be solved by another level of indirection 额外的间接层解决一切，诚不余欺也。&lt;/p&gt;
&lt;p&gt;另一个加速方法是利用并发。Goslate 内部用线程池并发多个 HTTP 请求，大大加快查询的速度。这里没有选择重新发明轮子，而是直接用 &lt;a class="reference external" href="https://pypi.python.org/pypi/futures"&gt;futures&lt;/a&gt; 库提供的线程池。&lt;/p&gt;
&lt;p&gt;批量加并发后效果非常明显，8000 个短句的翻译时间从 2 小时缩短到 10 秒钟。速度提升了 700 倍。看来 Goslate 不但免费，还比谷歌官方 API 要高效得多。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id15"&gt;设计&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;能工作，性能高，再进一步的要求就是好用了。这就涉及到 API 设计问题。Goslate API 总的设计原则是简约但不简陋 （Make things as simple as possible, but not simpler）&lt;/p&gt;
&lt;p&gt;Goslate 功能虽然简单，但魔鬼在细节中。比如出入参数的字符编码，proxy 设定，超时处理，并发线程数等该怎么合理组织规划？按设计原则，我们把灵活性分为三大类，Goslate 区别对待：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;必需的灵活，比如待翻译的源文本，目标语言等。这些是基本功能，将做为 API 的入参&lt;/li&gt;
&lt;li&gt;高级场景下才需要的灵活，比如 proxy 地址，出错后重试的次数，并发线程数等。通常用户不会关心，但特殊场景下又希望能控制。Goslate 用参数默认值解决这个两难问题。为了进一步简化和性能考虑，这类灵活性都放在了 Goslate 对象的构造中 &lt;tt class="docutils literal"&gt;Goslate.__init__()&lt;/tt&gt; 一次性设定&lt;/li&gt;
&lt;li&gt;无意义的灵活，例如文本的编码等。对这种灵活性要敢于说不，过度设计只会增加不必要的复杂度。Goslate 的入参只支持 Unicode 字串或 UTF-8 编码的字节流，返回值一律是 Unicode 字符串，需要什么编码自己转去。为什么说这些灵活性毫无意义？因为用户本来就有更自然的方式实现同样的功能。拒绝无意义的灵活反而能让用户达到真正的灵活&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;设计上还有其它考虑点：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;消灭全局状态，所有状态都在 Goslate 对象中。如果想的话，urllib2 提供的 HTTP opener 甚至线程池你都可以替换定制。&lt;/li&gt;
&lt;li&gt;应用依赖注入原则，所有的灵活性设置都本着最少知道原则 (Law of Demeter) 依赖于直接的外部功能接口。例如，proxy 地址不直接通过参数传入 Goslate，而是需要构造一个支持 proxy 的 &lt;tt class="docutils literal"&gt;urllib2.opener&lt;/tt&gt; 传给 Goslate 的构造函数。这么做的直接好处是参数少了。更本质的好处是解耦。内部实现依赖的是 opener 的接口，而不是具体的 opener 实现，更加不是 proxy 的配置。你可以配一个支持 proxy 的 &lt;tt class="docutils literal"&gt;opener&lt;/tt&gt; 来实现 proxy 转发访问，也可以配一个支持用户认证的 &lt;tt class="docutils literal"&gt;opener&lt;/tt&gt; 来应对复杂的网络环境。极端情况下，甚至可以自己从头定制一个 opener 实现来完成特殊的需求&lt;/li&gt;
&lt;li&gt;批量查询的入参出参使用 &lt;tt class="docutils literal"&gt;generator&lt;/tt&gt; 而不是 &lt;tt class="docutils literal"&gt;list&lt;/tt&gt;。这样就可以按照 pipeline 的方式组织代码：批量翻译的源文本序列可以是 generator，翻译一条就可以通过返回的 generator 实时拿到一个结果进行后面的处理，不用等着全部批量操作完成，增加了整个流程的效率。&lt;/li&gt;
&lt;li&gt;额外提供了命令行界面，简单的翻译任务可以直接用命令行完成。命令行参数的设计也遵照 Unix 设计哲学：从标准输入读取源文本，输出到标准输出。方便与其它工具集成使用&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id8"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id16"&gt;开源&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;如果只是自己使用，API 完全不用考虑的这么周全。之所以精雕细琢，目标就是开源！Python 社区对开源支持的非常好，开源库只要按照一定的规范去操作就好了：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;选版权：挑了半天，选择了自由的 MIT&lt;/li&gt;
&lt;li&gt;代码管理: Goslate 托管在 Bitbucket 上，虽然名气没有 Github 响，但胜在可以用我喜欢的 hg&lt;/li&gt;
&lt;li&gt;单元测试: 自动化单元测试很有必要，既是对用户负责，也让自己能放手做优化。Python 标准的 &lt;tt class="docutils literal"&gt;unittest&lt;/tt&gt; 框架很好用。同时 Goslate 也在 &lt;tt class="docutils literal"&gt;docstring&lt;/tt&gt; 中加入了 &lt;tt class="docutils literal"&gt;doctest&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;文档: 使用 Python 社区标准的文档工具 sphinx 生成，它可以自动从代码中抽取信息生成文档。文档生成好了后还可以免费上传到 &lt;a class="reference external" href="http://pythonhosted.org/goslate/"&gt;pythonhosted&lt;/a&gt; 托管&lt;/li&gt;
&lt;li&gt;部署: 按规矩在 &lt;tt class="docutils literal"&gt;setup.py&lt;/tt&gt; 中写好元信息，将代码打包上传到 pypi 就成了 (&lt;a class="reference external" href="https://jamiecurle.co.uk/blog/my-first-experience-adding-package-pypi/"&gt;这里有详细步骤&lt;/a&gt;) 。这样全世界的用户就可以用 &lt;tt class="docutils literal"&gt;pip&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;easy_install&lt;/tt&gt; 安装使用了。为了让受众更广，Goslate 还花了点力气同时支持 python2，python3&lt;/li&gt;
&lt;li&gt;宣传: 酒香也怕巷深，何况我这个小小的开源库呢。这也是本文的初衷&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;回过头看，Goslate 代码共 700 行，其中只有 300 行是实际功能代码，剩下的 400 行包括 150 行的文档注释和 250 行的单元测试。库虽小，但每样都要做好的话工作量比预想的要大很多，算起来写功能代码的时间远没有做开源周边辅助工作的时间长。&lt;/p&gt;
&lt;p&gt;天下事必做于细，信哉！&lt;/p&gt;
&lt;/div&gt;
</summary><category term="python"></category><category term="design"></category><category term="opensource"></category></entry><entry><title>Personal Emacs Configuration</title><link href="http://zhuoqiang.me/personal-emacs-configuration.html" rel="alternate"></link><updated>2012-10-25T23:43:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-10-25:personal-emacs-configuration.html</id><summary type="html">&lt;p&gt;Emacs is known to be one of the most powerful editor in the world. Yet its power is hidden in the absence of good configuration.&lt;/p&gt;
&lt;p&gt;Emacs configuration is hard and fun. After quite a while hard time fighting against elisp I finally have some fun with my Emacs and I just open source my &lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/emacs_configuration"&gt;personal Emacs configuration&lt;/a&gt; hoping it's helpful to you.&lt;/p&gt;
&lt;p&gt;The functions in the configuration are minimal for the sake of simplicity:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://zhuoqiang.me/torture-emacs.html"&gt;Chinese &amp;amp; English font setting with font scale function&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;key re-mapping on Mac&lt;/li&gt;
&lt;li&gt;programming language mode setting&lt;/li&gt;
&lt;li&gt;Jump functions&lt;/li&gt;
&lt;li&gt;some emacs themes&lt;/li&gt;
&lt;li&gt;auto restore files when re-open&lt;/li&gt;
&lt;li&gt;save typing using snippet and auto insert&lt;/li&gt;
&lt;li&gt;maxmize frame when startup emacs&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It works on Emacs 24 under Mac and Windows (not tested under Linux though). All you need to do is checkout the code to &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;~/.emacs.d/&lt;/span&gt;&lt;/tt&gt;. If you already have &lt;tt class="docutils literal"&gt;.emacs&lt;/tt&gt; file under home directory, you have to remove it so that  Emacs could use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;~/.emacs.d/init.el&lt;/span&gt;&lt;/tt&gt; instead.&lt;/p&gt;
&lt;p&gt;It could be a good start to enhance your emacs further, good luck hacking!&lt;/p&gt;
</summary><category term="config"></category><category term="emacs"></category><category term="english"></category><category term="opensource"></category></entry><entry><title>ChmFox 2.7 发布</title><link href="http://zhuoqiang.me/chmfox-2.7-release.html" rel="alternate"></link><updated>2012-07-25T08:22:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-07-25:chmfox-2.7-release.html</id><summary type="html">&lt;p&gt;ChmFox 是一款让 Firefox 变身成 CHM 阅读器的扩展，目标是为所有平台提供最好的 CHM 浏览体验。（更多请看 &lt;a class="reference external" href="http://zhuoqiang.me/chmfox.html"&gt;ChmFox 介绍&lt;/a&gt; ）&lt;/p&gt;
&lt;p&gt;时隔一年，ChmFox 再次更新。新版本修复了大量用户报告的错误，功能上也做了增强。欢迎从 &lt;a class="reference external" href="https://addons.mozilla.org/firefox/addon/chmfox"&gt;这里&lt;/a&gt; 下载试用。有问题，请留言或直接到 &lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox/issues"&gt;官网&lt;/a&gt; 提 Issue。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id10"&gt;更新&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id11"&gt;回顾&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id12"&gt;小广告&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;更新&lt;/a&gt;&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;修复打开文件时标签页不正常的问题，现在打开 CHM 文件时不再显示额外的空白页&lt;/li&gt;
&lt;li&gt;修复某些情况下点击侧栏目录树跳动的问题&lt;/li&gt;
&lt;li&gt;修复切换 CHM 文件时侧栏无更新的问题&lt;/li&gt;
&lt;li&gt;记忆上次阅读位置，重新打开 CHM 文件时自动跳转到上次阅读页面&lt;/li&gt;
&lt;li&gt;浏览 CHM 文件时保持页面缩放级别&lt;/li&gt;
&lt;li&gt;侧栏快捷键改为 &lt;span class="kbd"&gt;ctrl alt m&lt;/span&gt; 以避免与其它快捷键冲突 （Mac 上的 &lt;span class="kbd"&gt;command&lt;/span&gt; 键等同 &lt;span class="kbd"&gt;ctrl&lt;/span&gt;）&lt;/li&gt;
&lt;li&gt;初步支持多文件 CHM&lt;/li&gt;
&lt;li&gt;增强 i18n。更好的处理特殊编码的 CHM 文件&lt;/li&gt;
&lt;li&gt;更新程序图标，活泼鲜亮又有爱&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;回顾&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ChmFox 从自 2011 年 6 月发布以来，到今天已经 13 个月大了。在这 1 年多时间里，依靠非常有限的宣传，ChmFox 取得了如下成绩&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;每日用户数量 6400。自发布以来用户数量一直在增长。平均每月增加 500 新用户&lt;/li&gt;
&lt;li&gt;单日下载量 100。该值从最高峰 170 下降到现在的 90。与每日用户数对比，可知大约每 6 个下载带来 1 个用户&lt;/li&gt;
&lt;li&gt;英文用户数量最多，达到用户总数的 50％，中文用户数量约为 15％&lt;/li&gt;
&lt;li&gt;Windows 虽然有原生的 CHM 阅读支持，但用户份额达到 73％ 依然最大。其次是 Linux 22％，还有约 5％ 的 Mac 用户。Mac 与 Linux 用户所占的比重与两个平台本身的市场占有率背离很大，这是否因为两个平台 Firefox 的使用率很高？&lt;/li&gt;
&lt;li&gt;居然发现 Solaris 与 BSD 的用户，估计是朋友自己编译的吧。可能的话请把编译的库发给我，添加到官方版本中可以让更多人受益&lt;/li&gt;
&lt;li&gt;火狐扩展页获得 13 位用户的评价，12 位给了 5 星，1 位朋友很直接地打了 1 星。估计是用户体验太差把他气着了。新版本修掉了很多问题，希望他能满意&lt;/li&gt;
&lt;li&gt;总共收到 10 次捐款，除去手续费共 $43。也就是每 600 个用户，或 3600 次下载会带来一次好心的捐款。捐款的都是西方朋友。其中有两位更是一次捐了 $10，慷慨！&lt;/li&gt;
&lt;li&gt;收到某英文网站主动收录测评一次&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;总的来说 ChmFox 的成绩超出了我的预期，大家的评价和捐款更是让我欢欣鼓舞，但数据也反映出一些问题：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;转化率过低，只有 17％。算上升级 2 次，这个数据依然偏低。可能是 ChmFox 一直以来的小问题影响了用户体验，猜想有些用户在第一次使用时就因为体验太差把它删了吧。新版本修了很多问题，应该能提高用户体验。&lt;/li&gt;
&lt;li&gt;下载量在下降。这恐怕是 Firefox 市场份额下降，加上 CHM 格式没落这些大环境影响造成的。现在宣传很少，大家都不知道 ChmFox。对这种小众软件，加强宣传应该能提高下载量&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;小广告&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;如果你喜欢 ChmFox，想帮助它更好的发展，你可以:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://addons.mozilla.org/firefox/addon/chmfox"&gt;捐点小钱&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://addons.mozilla.org/firefox/addon/chmfox/reviews/add"&gt;留言鼓励&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox/issues"&gt;报告问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox"&gt;贡献代码&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;还等什么，快让朋友们知道你在用着世界上最舒服的姿势看 CHM&lt;/p&gt;
&lt;p&gt;希望后面能给大家带来更好的 ChmFox，也希望更多的 Firefox 死忠享受到 ChmFox 提供的便利。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="chmfox"></category><category term="opensource"></category></entry><entry><title>Monad 最简介绍</title><link href="http://zhuoqiang.me/what-is-monad.html" rel="alternate"></link><updated>2012-06-20T23:52:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-06-20:what-is-monad.html</id><summary type="html">&lt;p&gt;Haskell 是一门特殊的编程语言，哪怕在函数语言中也很特立独行。它以彻底的纯函数和强大的类型系统闻名。Monad 概念就是由 Haskell 第一个引入编程世界的，它也许是编程领域最难理解的概念。几乎所有费心尽力最终理解了 Monad 的人都会有一种恍然顿悟的感觉，这里简单说说我悟到的 Monad。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id4"&gt;为什么 Monad&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id5"&gt;Monad 的原理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id6"&gt;Monad 是什么&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;为什么 Monad&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Haskell 为什么会引入 Monad？最大的原因是为了在纯函数语言中引入副作用。&lt;/p&gt;
&lt;p&gt;纯函数的优点是安全可靠。函数输出完全取决于输入，不存在任何隐式依赖。它的存在如同数学公式般完美无缺。可有时越是完美的东西就越没有用处，比如纯函数，因为隔绝了外部环境，纯函数连基本的输入输出都做不了。一个简单的 Hello world 就能难倒纯函数。为了引入 IO 操作，各种函数式语言八仙过海各显神通。Monad 就是 Haskell 给出的方案。并且 Monad 并不仅仅是 IO 操作的抽象，它更是多种类似操作之间共性的抽象。所以 Monad 解决的问题并不局限在 IO 上，像 Haskell 中的 &lt;tt class="docutils literal"&gt;Maybe&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;[]&lt;/tt&gt; 都是 Monad。Haskell 中漂亮的错误处理方式和灵活的列表推导式 (list comprehension) 也都算是 Monad 的贡献。&lt;/p&gt;
&lt;p&gt;我自己一直有种误解，这里需要特别说明一下： Monad 不但不是引入 IO 的唯一方法，而且可以说 Monad 并没有把副作用引入纯函数中。纯函数不能有副作用，有副作用的不叫纯函数，哪怕用了神秘难解的 Monad 也不行。那 Monad 到底做了什么呢？&lt;/p&gt;
&lt;p&gt;让我们再回想一下: 纯函数安全可靠但无用，是个无趣的好男人; 普通函数能力强但 Bug 多，对程序来说却是必不可少的。如同危险而有魅力的坏男孩。如何同时拥有两者，让它们合作无间各自发挥特点而不互相打架呢？这就是 Monad 的作用了。它将带有副作用的 IO 操作以一种可控的方式引入到 Haskell 中，让纯函数与 IO 操作能够和平相处，共同组织出既安全又有用的程序。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Monad 的原理&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;函数之间要协作，就必须以各种形式交互连接。因为 Haskell 使用静态强类型系统，函数间的连接受限于入参与返回值类型，这大大增强了程序的安全性，同时也带来一个问题：如何既充分隔离纯函数与副作用函数，又能让两类函数相互复用？&lt;/p&gt;
&lt;p&gt;我们拿 IO 操作做例子分析，Haskell 中专门有一个类型类（类型类有点象 C++ 中的 Concept） &lt;tt class="docutils literal"&gt;IO&lt;/tt&gt; 用来标示某类型附带有 IO 动作。&lt;/p&gt;
&lt;p&gt;为了充分隔离纯函数与 IO 函数，Haskell 中不能实现 &lt;tt class="docutils literal"&gt;IO Char &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; Char&lt;/tt&gt; 这样一种输入是 IO 类型返回值却是普通类型的函数。否则副作用函数就能很容易变身为纯函数了&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;Char&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Char&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;Char&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="kt"&gt;Char&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="kt"&gt;Char&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Char&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;事实上一旦参数中有 IO，返回值必有 IO，这就保证了充分隔离。&lt;/p&gt;
&lt;p&gt;那如何让纯函数与 IO 函数相互复用呢？这就要靠 IO Monad 中定义的 &lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 这两个函数了。&lt;tt class="docutils literal"&gt;return&lt;/tt&gt; （在 Haskell 中不是关键字，只是一般的函数名）的作用是将某个类型为 A 的值 a 以最自然的方式提升（装箱）为类型为 IO A 的值 &lt;tt class="docutils literal"&gt;Char &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; IO Char&lt;/tt&gt; 。后面会看到所谓“最自然”的方式是有严格定义的。有了这个函数后，纯函数就可以通过与 &lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 复合变成返回值为 &lt;tt class="docutils literal"&gt;IO&lt;/tt&gt; 带副作用的函数了，当然，实际的 IO 动作是 Haskell 内建的，&lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 的主要意义在于类型提升。&lt;/p&gt;
&lt;p&gt;有了提升可没有下降操作，怎么复合 &lt;tt class="docutils literal"&gt;putChar :: Char &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; IO()&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;getChar :: IO Char&lt;/tt&gt; 呢。 &lt;tt class="docutils literal"&gt;getChar&lt;/tt&gt; 从 IO 读取一个字符， &lt;tt class="docutils literal"&gt;putChar&lt;/tt&gt; 把字符写入 IO。但 &lt;tt class="docutils literal"&gt;getChar&lt;/tt&gt; 返回的是 &lt;tt class="docutils literal"&gt;IO Char&lt;/tt&gt; 类型，而 &lt;tt class="docutils literal"&gt;putChar&lt;/tt&gt; 需要的是普通的 &lt;tt class="docutils literal"&gt;Char&lt;/tt&gt; 类型，两者不匹配怎么办？ &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 函数出马了！ &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 的类型是&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 就可以连接 &lt;tt class="docutils literal"&gt;getChar&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;putChar&lt;/tt&gt; ，把输入复写到输出中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;echo&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;getChar&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;putChar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 操作实际上是受限的类型下降（或拆箱）操作，只有当后面的函数返回值也是 IO 类型时才进行下降操作。这样既充分隔离纯函数与副作用函数，又能让函数相互复用。&lt;/p&gt;
&lt;p&gt;通过 &lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 两个平行世界 (范畴) 就有了可控的交流通道。下图直观的反映 Monad 的作用，A 与 IO A 是分属两个不同的世界，A 是纯洁类型，IO A 是带 IO 操作的类型。为了保证整个程序的质量，两个世界的交流只能以图上的方式进行&lt;/p&gt;
&lt;img alt="|filename|/images/monad.png" src="http://zhuoqiang.me/static/images/monad.png" /&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 是最自然的类型提升函数，将 a 提升为 a'&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;a &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; b'&lt;/tt&gt; 是普通的提升函数&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 是受控的类型下降，只有当 &lt;tt class="docutils literal"&gt;b &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; c'&lt;/tt&gt; 存在时，才能将 b' 降到 b。这样 &lt;tt class="docutils literal"&gt;a &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; b'&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;b &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; c'&lt;/tt&gt; 就能复合成 &lt;tt class="docutils literal"&gt;a &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; c'&lt;/tt&gt; 了&lt;/li&gt;
&lt;li&gt;Monad 没有定义 &lt;tt class="docutils literal"&gt;c' &lt;span class="pre"&gt;-&amp;gt;&lt;/span&gt; c&lt;/tt&gt;，不存在这种不受控的下降方式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这里，IO 类型类可以是任意符合 Monad 定义的类型类。a' 可以是 &lt;tt class="docutils literal"&gt;IO a&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;Maybe a&lt;/tt&gt;, 或者 &lt;tt class="docutils literal"&gt;[a]&lt;/tt&gt;。同时 Haskell 的 do 语法糖又进一步简化了 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 复合的语法，使其成为很多类似问题的通用解决方案，这里就不展开了。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Monad 是什么&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Monad 之所以难以理解，就在于它的抽象性。这不同于面向对象，鹰是一种鸟这种程度的类比就足以让人理解子类父类继承关系这些概念了。Monad 的抽象是形而上的高度抽象。它本身是抽象代数中范畴学的一个概念，是特殊的算子。要真正消化它首先要理解抽象的对象，类型，范畴，函子这些概念。没有这些概念打底，理解 Monad 可谓是空中楼阁无根之木。如果非要单独理解 Monad，那上图就是一个很好的简化说明。&lt;/p&gt;
&lt;p&gt;前面说了，&lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 是最自然的提升方式，这里“最自然”是有明确意义的。指的是 &lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 这对函数必需满足下面的公理&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;return&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 互为逆操作&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;return&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;
&lt;span class="nf"&gt;m&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;return&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;&amp;gt;&amp;gt;=&lt;/tt&gt; 满足结合律&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;g&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;\&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;g&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些公理保证了 Monad 正常工作。但可惜，它们在 Haskell 中没法用类型系统加以检查，只能靠各个 Monad 的实现者保证，算是潜规则。正如动态语言需要大量测试覆盖代码以保障质量一样，静态类型语言也需要外在的检验来保证这些潜规则没被违反。&lt;/p&gt;
&lt;p&gt;Monad 被引入进 Haskell 用来解决 IO 操作可谓神来之笔，正如面象对象概念可以在非面象对象的语言中模拟使用一样，Monad 概念也能在其它中语言中应用 （比如 Java, C++, Python）。但只有在 Haskell 这种拥有强大类型推导系统的强类型语言中，Monad 才能发挥最大功效。Haskell 或没有跻身为主流语言的一天，但相信 Monad 会象 Lambda 概念一样，从函数语言的王谢家飞入寻常主流语言中来。&lt;/p&gt;
&lt;p&gt;编程语言进步的方向是抽象，抽象，更高层次的抽象！&lt;/p&gt;
&lt;/div&gt;
</summary><category term="design"></category><category term="haskell"></category></entry><entry><title>ftputil 简介</title><link href="http://zhuoqiang.me/ftputil-introduction.html" rel="alternate"></link><updated>2012-06-12T23:23:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-06-12:ftputil-introduction.html</id><summary type="html">&lt;p&gt;最近工作上需要定制一个 FTP 客户端工具，用来同步本地文件夹到 FTP 服务器上。这般粗活首选当然是 Python: 开发迅速，编写简洁，还能用 py2exe 打包独立分发。&lt;/p&gt;
&lt;p&gt;但 Python 标准库对 FTP 的封装太底层，很不好用。在自己动手改进之前先放狗搜了一下，果然早有人忍不住，不但封装了 FTP 客户端，而且开源了。这就是 &lt;a class="reference external" href="http://ftputil.sschwarzer.net"&gt;ftputil&lt;/a&gt; ，一个 Python 高层次接口 FTP 客户端库。&lt;/p&gt;
&lt;p&gt;ftputil 的接口非常简单易用。一个 &lt;tt class="docutils literal"&gt;ftputil.FTPHost&lt;/tt&gt; 对象就包括了 FTP 的上传下载和查询。整个接口还刻意模仿标准模块 &lt;tt class="docutils literal"&gt;os&lt;/tt&gt; 的本地文件操作接口，上手不费吹灰之力。与 &lt;tt class="docutils literal"&gt;os&lt;/tt&gt; 模块的文件操作接口保持一致还有个好处: 多态。本地文件和 FTP 远程文件操作接口一模一样，这样对已有的程序添加 FTP 存储支持，只需要把 os 模块换成 FTPHost 对象就成了。FTP 的操作对调用端代码是透明的，非常方便。&lt;/p&gt;
&lt;p&gt;ftputil 还有个隐藏功能：对本地和远程 FTP 文件夹进行同步。也许作者认为这个功能还不成熟，并没在文档中提及。不过文件夹同步恰好是我需要的，自然毫不客气直接拿来使用！ftputil 源代码中的 &lt;tt class="docutils literal"&gt;ftp_sync&lt;/tt&gt; 实现了同步功能。下面几行代码就实现了将本地文件夹同步到 FTP 服务器&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ftputil&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ftputil.ftp_error&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ftputil.ftp_sync&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sync&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;local_directory&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ftp_host&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;remote_path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;FTPHost&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ftp_host&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;remote&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;Login to FTP &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt; successfully as user &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;anonymous&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="n"&gt;local&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;LocalHost&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;syncer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Syncer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;remote&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;syncer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sync&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;local_directory&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;remote_path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;本来要自己实现的功能几行代码就搞定，真省事。&lt;/p&gt;
&lt;p&gt;虽省事，却不省心，测试时发现了两个问题:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;FTP 服务器上以 &lt;tt class="docutils literal"&gt;.&lt;/tt&gt; 开头的隐藏文件无法例出。解法是给 FTP 命令 &lt;tt class="docutils literal"&gt;LIST&lt;/tt&gt; 加上参数 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-a&lt;/span&gt;&lt;/tt&gt; 显示所有文件&lt;/li&gt;
&lt;li&gt;从 Windows 平台同步文件夹时，Windows 的文件分隔符 &lt;tt class="docutils literal"&gt;\&lt;/tt&gt; 被 FTP 服务器直接当做文件名的一部分，导制文件没有在目录下创建，而是新建另一个名为 &lt;tt class="docutils literal"&gt;dir\file.name&lt;/tt&gt; 的文件。解法是使用 FTP 命令之前，先把路径中的文件分隔符替换成通用的 &lt;tt class="docutils literal"&gt;/&lt;/tt&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这两个问题我遇到了，修好了。本着人人为我我为人人的开源精神，我给作者提了两个 bug (&lt;a class="reference external" href="http://ftputil.sschwarzer.net/trac/ticket/62"&gt;#62&lt;/a&gt;, &lt;a class="reference external" href="http://ftputil.sschwarzer.net/trac/ticket/63"&gt;#63&lt;/a&gt;)，并跟作者一起在 ftputil v2.7 中修好了这两个问题。ftputil 的作者 Stefan 很好沟通，一点举手之劳赢得他的感谢，还挺有成就感的。&lt;/p&gt;
&lt;p&gt;天下程序一大抄，看你会抄不会抄。不会抄的，键盘上的 &lt;span class="kbd"&gt;ctrl&lt;/span&gt; &lt;span class="kbd"&gt;c&lt;/span&gt; &lt;span class="kbd"&gt;v&lt;/span&gt; 键一定是饱经风霜了吧; 会抄的，在发明轮子前，先找现成的轮子，找到了，会用了，从此工具箱中又多了一件趁手的兵器。这不比毫无积累的复制粘贴大法高出不少吗; 如果能再进一步，不怕麻烦，帮着修补轮子，让它更加结实好用，利人利己，也算是抄亦有道了吧。&lt;/p&gt;
&lt;p&gt;谢谢 Stefan 给 Python 社区贡献的好轮子！&lt;/p&gt;
</summary><category term="opensource"></category><category term="python"></category></entry><entry><title>程序如何找自己</title><link href="http://zhuoqiang.me/how-program-find-self.html" rel="alternate"></link><updated>2012-06-06T19:26:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-06-06:how-program-find-self.html</id><summary type="html">&lt;p&gt;自我定位很重要，不但是对人，对程序来说也一样。如果能知道自己的路径位置，程序就可以通过相对定位找到身边的资源文件，这对于制作无需安装的绿色软件和各类插件很关键。下面列出几种程序的自我定位方法。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#windows-api" id="id2"&gt;Windows API&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#unix" id="id3"&gt;Unix 平台&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#python" id="id4"&gt;Python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#mac-ios" id="id5"&gt;Mac &amp;amp; iOS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#mozilla-gecko" id="id6"&gt;Mozilla Gecko&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="windows-api"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;Windows API&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;可利用 Win32 API &lt;tt class="docutils literal"&gt;GetModuleHandleEx&lt;/tt&gt; 来取得内存地址所在的程序路径。如果传入可执行文件自身的某个函数地址，那就能获得自己的路径。该方法如下，默认是取自身的路径:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;wstring&lt;/span&gt; &lt;span class="n"&gt;get_module_path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;get_module_path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="n"&gt;HMODULE&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;BOOL&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;GetModuleHandleExW&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="c1"&gt;//|GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT,&lt;/span&gt;
        &lt;span class="k"&gt;static_cast&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;wchar_t&lt;/span&gt;&lt;span class="o"&gt;*&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kt"&gt;wchar_t&lt;/span&gt; &lt;span class="n"&gt;path_buffer&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;MAX_PATH&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="sc"&gt;L&amp;#39;\0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
        &lt;span class="n"&gt;DWORD&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;GetModuleFileNameW&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;path_buffer&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MAX_PATH&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="c1"&gt;// We have to free it&lt;/span&gt;
        &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;FreeLibrary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;path_buffer&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;L&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="c1"&gt;// not found&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个方法也能在 DLL 中使用，让动态库也能获取自身的位置，方便插件的编写。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="unix"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;Unix 平台&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;与 Win32 类似，在 POSIX 中 &lt;tt class="docutils literal"&gt;dladdr&lt;/tt&gt; 函数也可以获取某个地址所在可执行文件的路径:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;get_module_path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;get_module_path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Dl_info&lt;/span&gt; &lt;span class="n"&gt;dl_info&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;dl_info&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dli_fname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;dladdr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;dl_info&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;dl_info&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dli_fname&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dl_info&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dli_fname&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;该方法同样能让 so 动态库找到自身的位置，方便插件的编写。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Python&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Python 内置变量 &lt;tt class="docutils literal"&gt;__file__&lt;/tt&gt; 的值就是脚本文件位置，很方便。不过一旦脚本被 py2exe 这类程序打包后，`` __file__`` 就不准确了。这时就需要用 &lt;tt class="docutils literal"&gt;sys.argv[0]&lt;/tt&gt; 甚至 &lt;tt class="docutils literal"&gt;sys.executable&lt;/tt&gt; 变量来取得打包后的程序文件的位置&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;imp&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os.path&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_frozen&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
   &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;hasattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;frozen&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="c"&gt;# new py2exe&lt;/span&gt;
           &lt;span class="nb"&gt;hasattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;importers&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c"&gt;# old py2exe&lt;/span&gt;
           &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;imp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_frozen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="c"&gt;# tools/freeze&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_self_path&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
   &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;is_frozen&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
       &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;abspath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;executable&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
   &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;abspath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mac-ios"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Mac &amp;amp; iOS&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Mac 和 iOS 平台上标准的 App 结构都是把可执行文件和资源文件打包在程序束 (bundle) 中，苹果还提供专门的 API 来取得 bundle 的路径，从这点上来说，苹果上的软件都是绿色的。不过如果需要，你还是可以取得自身的路径，&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;span class="kt"&gt;uint32_t&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;sizeof&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_NSGetExecutablePath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;printf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;executable path is %s&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;printf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;buffer too small; need size %u&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种方法不管是对传统的 Unix 可执行文件或是 Apple 自己标准的 App 都适用。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="mozilla-gecko"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;Mozilla Gecko&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Firefox 的扩展都基于 Gecko 架构提供的插件机制。要得到扩展自身的路径应该很方便才是，但实际上并非如此:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;Components&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;utils&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="kr"&gt;import&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;resource://gre/modules/AddonManager.jsm&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="nx"&gt;AddonManager&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getAddonByID&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;your@addon.name&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;addon&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;uri&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;addon&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getResourceURI&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;relative/path/to/file&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;uri&lt;/span&gt; &lt;span class="k"&gt;instanceof&lt;/span&gt; &lt;span class="nx"&gt;Components&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;interfaces&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nsIFileURL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="c1"&gt;// get the absolute path to the file inside Your@Addon.name&lt;/span&gt;
        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;absolute_file_path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;uri&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;file&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里，需要按扩展的名字去 &lt;tt class="docutils literal"&gt;AddonManager&lt;/tt&gt; 中找出扩展对象，再通过扩展对象取得扩展包内相对位置的文件路径，使用起来不太方便。&lt;/p&gt;
&lt;p&gt;其实，Gecko 中有更直接的方法。你可以在 &lt;tt class="docutils literal"&gt;manifest&lt;/tt&gt; 文件里把需要引用的文件都声明成 &lt;tt class="docutils literal"&gt;resource&lt;/tt&gt;，所有的 &lt;tt class="docutils literal"&gt;resource&lt;/tt&gt; 都可以在扩展里通过 URI 名字直接获得路径&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="na"&gt;resource YOUR-ADDON-LIB path/to/libaddon.so ABI&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;Linux_x86-gcc3&lt;/span&gt;
&lt;span class="na"&gt;resource YOUR-ADDON-LIB path/to/addon.dll ABI&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;WINNT_x86-msvc&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;const&lt;/span&gt; &lt;span class="nx"&gt;ioService&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;Cc&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;@mozilla.org/network/io-service;1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;getService&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;Ci&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nsIIOService&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;uri&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;ioService&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;newURI&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;resource://YOUR-ADDON-LIB&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;uri&lt;/span&gt; &lt;span class="k"&gt;instanceof&lt;/span&gt; &lt;span class="nx"&gt;Components&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;interfaces&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nsIFileURL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;lib&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;ctypes&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;uri&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;file&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="c1"&gt;/// ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在不同平台上，同一名字还能对应不同的资源文件，方便跨平台扩展的开发。在上面例子中，Win32 平台 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;js-ctypes&lt;/span&gt;&lt;/tt&gt; 会使用 &lt;tt class="docutils literal"&gt;addon.dll&lt;/tt&gt; 而 Linux 上则会使用 &lt;tt class="docutils literal"&gt;libaddon.so&lt;/tt&gt;，这一切都由 gecko 帮着选择定位。我在 &lt;a class="reference external" href="https://addons.mozilla.org/zh-cn/firefox/addon/chmfox/"&gt;chmfox&lt;/a&gt; 里正是使用了这个手法。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="c++"></category><category term="firefox"></category><category term="ios"></category><category term="python"></category></entry><entry><title>Programming in Lua 笔记</title><link href="http://zhuoqiang.me/programming-in-lua-notes.html" rel="alternate"></link><updated>2012-05-02T01:20:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-05-02:programming-in-lua-notes.html</id><summary type="html">&lt;p&gt;最近花了两天读完了《Programming in Lua》。本书不但教授如何使用 Lua 语言，还顺带解释了为什么 Lua 会设计成现在这样子，很有价值。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#lua" id="id4"&gt;Lua 的特点: 小快灵&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id5"&gt;Lua 的缺点: 少活简&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id6"&gt;感想&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id7"&gt;总结&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="lua"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Lua 的特点: 小快灵&lt;/a&gt;&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;小: 整个 Lua 包括标准库只有 2 万行代码，解释器大小 200 KB。占用的内存也很小&lt;/li&gt;
&lt;li&gt;快: 经过手工调优基于寄存器的虚拟机，加上增量式的标志清扫垃圾收集器。Lua 可算是运行速度最快的脚本语言了。另一方面，灵活的语法和数据结构也大大加快了开发速度&lt;/li&gt;
&lt;li&gt;灵: 使用方式灵活多样。可做为脚本语言直接使用;也可嵌入宿主程序中做脚本引擎 (如魔兽世界);还可直接调用 C 编写的扩展&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Lua 的缺点: 少活简&lt;/a&gt;&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;少: 标准库的功能太少。自限于标准 C 的框框中，导致很多基本功能缺失，例如正则表达式，系统线程，目录操作等&lt;/li&gt;
&lt;li&gt;活: 灵活的语法和数据结构固然能加快开发速度，但往往也使人容易犯下不着边际的错误。非常考验团队的编码纪律。特别是变量使用前不用定义，变量默认全局范围，类型自动协变这些设定&lt;/li&gt;
&lt;li&gt;简: Lua 的哲学之一是只提供机制，而不提供设施。导致很多用法是靠着惯例和潜规则来支撑的。对普通应用来说是简约，但对稍复杂的就显得简陋了&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;感想&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 太执着于标准 C 了，这种偏执让其保有极端的可移植性与可扩展性。例如 Lua 对库搜索路径的处理用巧妙的方式有意避开了文件路径，仅仅因为标准 C 中没有文件路径这个概念。自困于标准 C 直接导致了 Lua 的 os 库不能使用 POSIX API，几乎毫无用处。但也正是这个决定，让扩展非常方便，第三方很容易就写出 POSIX 的库供 Lua 使用。权衡得失，这个坚持还是相当大胆有效的&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;由于正则表达式的实现过于庞大 (相比 Lua 其它部分来说)，Lua 放弃了对它的支持，转而实现自己的字符串模式匹配方式。这是一个败笔。功能上的不同倒在其次，最重要的是大家要重新学习一套新的匹配规则。原有的经验知识浪费了。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;表 (table) 是 Lua 中唯一的数据结构，这也是从“小”来考虑的。带来的结果就是“活”与“简”的缺点。功能上来说，table 顶替 array, stack, map 等数据结构完全没有问题，性能上由于实现的巧妙性，也能接受。可问题在于 table 太灵活了，我们之所以使用某类数据结构，有时正是看中了它的限制。限制有利于开发者的沟通交流协同一致。极端的例子就是把表当数组使用时下标要从 1 开始，这个规矩居然只是惯例而非强制，太考验开发人员的素质了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;对于用 &lt;tt class="docutils literal"&gt;end&lt;/tt&gt; 做结束符我有天生的抵触，Ruby 也是一例。Lua 的语法太过随意。末位的分号可以省略; 代码可以没有任何分割符挤在一行里; table 元素的分割符可用分号也可用逗号; 单参数函数调用可以省略括号 ... 也只有脚本语言能用这么灵活的语法。这方面我很喜欢 Python 的设定，语法严谨简单，没有这么多的例外&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 中有两个语法设定是亮点:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;table 中末位元素允许可选的分割符&lt;/li&gt;
&lt;li&gt;多行字面字符串和多行注释可以自选括号样式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;前者方便了机器，后者方便了人。Json 规范如果当初规定末位元素可以有可选分割符的话，那 json 的模板生成代码就不用单独对最后的元素做特殊处理了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;变量不经定义就能使用，这实在是最大的败笔&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;命令行参数列表的设定很有意思，可以通过负数下标来往前找 Lua 的启动参数&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 是弱类型语言，字符串和数字之间可以隐式转换。这是个错误，好处没有坏处一堆。书的作者对此也持负面看法&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;与 Python 一样，变量只是名字，绑定的值由运行时管理&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;只有 &lt;tt class="docutils literal"&gt;false&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;nil&lt;/tt&gt; 算是假，其它的都是真，包括空表和空字符串。用惯 Python 的人会感到意外&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;数字只有 &lt;tt class="docutils literal"&gt;double&lt;/tt&gt; 类型。很漂亮的简化&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;字符串可存任意数据，包括 &lt;tt class="docutils literal"&gt;\0&lt;/tt&gt; 。象 Python 一样 Lua 的字符串也是不可变的&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;不明白为什么要加入特殊的 &lt;tt class="docutils literal"&gt;#&lt;/tt&gt; 号来取长度。加一个 &lt;tt class="docutils literal"&gt;len&lt;/tt&gt; 函数不就行了吗&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;a.name()&lt;/tt&gt; 不同于 &lt;tt class="docutils literal"&gt;a:name()&lt;/tt&gt; 而 &lt;tt class="docutils literal"&gt;a.name&lt;/tt&gt; 也不是 &lt;tt class="docutils literal"&gt;a[name]&lt;/tt&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;table 用做 array 时，可能会有洞 (hole)，所以用 &lt;tt class="docutils literal"&gt;#&lt;/tt&gt; 获取元素数量是不准的。因为下标可以跳着定义，所以用 &lt;tt class="docutils literal"&gt;table.maxn&lt;/tt&gt; 算数量也是不准的。那用什么准 ? 得看你怎么用 table 了，这就是灵活的代价！写的时候，运用之妙存乎一心。等到维护代码的时候，就该骂娘了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 对函数式编程支持的很好。函数是一级值语义，可内部嵌套定义，可绑定 lexical scoping 变量，支持尾递归优化。这比 Python 半生不熟的 lambda 要好太多了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;把乘方操作符 &lt;tt class="docutils literal"&gt;^&lt;/tt&gt; 和取余操作符 &lt;tt class="docutils literal"&gt;%&lt;/tt&gt; 的操作数都扩展到了小数，有很多有趣实用的应用&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;虽然字符串和数字之间能隐式转换，但在比较相等时，字符串和数字是绝对不等的。Lua 总算保住了最后的理性&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;基于逻辑操作符的短路机制，有 &lt;tt class="docutils literal"&gt;(x &amp;gt; y) and x or y&lt;/tt&gt; 类似 C 中三元操作符 :? 的惯例，这点类似 Python 的 &lt;tt class="docutils literal"&gt;(x&amp;gt;y) and x or y&lt;/tt&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;定义局部变量要加 &lt;tt class="docutils literal"&gt;local&lt;/tt&gt; 限定符。如果不加默认是全局变量。这是鼓励使用全局变量啊，失败!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;基于块的局部变量作用域。这点比 Python 只有全局，函数级，和 nonlocal 三种要细致好用&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;switch&lt;/tt&gt; 是必须的吗? Lua 和 Python 都不使用 &lt;tt class="docutils literal"&gt;switch&lt;/tt&gt; 而用 &lt;tt class="docutils literal"&gt;if elif&lt;/tt&gt; 代替了。编译型语言用 &lt;tt class="docutils literal"&gt;switch&lt;/tt&gt; 还可以方便编译器做优化，脚本语言确实没必要了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;for&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;iterator&lt;/tt&gt; 结合，简化遍历语法。几种语言都有这种搞法 C++, Java, Python, C#&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;如果只有一个参数，函数调用可以省略 &lt;tt class="docutils literal"&gt;()&lt;/tt&gt; 。这种为方便偷懒而定的例外，很难认同&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;比 Python 更灵活的是，Lua 不检查入参个数是否匹配。检查参数的担子落在了函数调用方和函数实现者身上&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;象 Python 一样，Lua 函数可以返回多个值。不同的是，在多个返回值的取法上，Lua 有一套复杂规则，Python 只有一个规则。高下立判&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 的 &lt;tt class="docutils literal"&gt;iterator&lt;/tt&gt; 协议中包含了不变状态和控制变量，增强了性能。Lua 可以比作脚本语言中的 C，非常贴近虚拟机&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;象其他脚本语言一样，Lua 也可以在脚本中直接执行脚本字符串。那怎么控制安全性呢? Lua 又提供了 environment 机制让你实现 sandbox。记得几年前市面上 Python 的虚拟主机非常少，一个重要的原因是 Python 的功能太强大，又没有成熟的 sandbox 机制来控制，很难限制用户&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;异常机制允许指定是哪层的问题，这个设定很新颖&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;因为 ANSI C 标准没有线程，Lua 用非对称的协程来补缺。这比 Python 半调子的 &lt;tt class="docutils literal"&gt;generator&lt;/tt&gt; 要好很多。当然，单个 Lua 没法利用多核优势&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;metatable&lt;/tt&gt; 与 &lt;tt class="docutils literal"&gt;metamethod&lt;/tt&gt; 是个因繁就简的方案。再一次体现了 Lua 通过把机制直接暴露给用户来达到小快灵的设计理念&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;每个函数都可以设置自己的私有环境，这应该是针对 Lua 变量不用定义，默认全局范围语义的一个修正。早知如此，何必当初！&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua 的对象模型与 javascript 一样，是基于 prototype 而非 class 的，非常灵活。要模拟 class 对象模型可以有多种方案。如果是编译型语言，基于 prototype 的对象模型实用吗 ?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;与 C 交互的接口使用栈来进行，简化了 C 接口模型。不过写起程序来稍微费点事。好在可以用第三方库来简化这些工作。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Lua API 总是需要显示传入一个 &lt;tt class="docutils literal"&gt;state&lt;/tt&gt; 来指明是哪一个栈环境，而没有依赖任何全局变量，这使得 Lua 的解释器并发无碍&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;在 5.1 版的 API 中，内存分配策略也可以定制。这里 API 的设计非常合理，包含了一个分配函数和一个用户数据指针。Lua 也提供了缺省的内存分配器&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;关于垃圾收集器常遇到的 finalize, weak pointer，控制 gc 避免性能波动等问题，Lua 一个都没少。习惯了 C++ RAII 还真是觉得 GC 这套太麻烦了&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;总结&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Lua 是一门局限性很大的语言，由于其小快灵的特点，在游戏脚本，编写扩展等领域是非常好的选择。可一旦程序上规模就会捉襟见肘。其极端的灵活性和简陋的设施，并不适合大团队协同开发。这年头语言层出不穷，新语言要想得到市场认可，四平八稳的设计思路是很难出头的。Lua 很多近乎偏质的设计决定，正是它得以流行的关键。&lt;/p&gt;
&lt;p&gt;当然，Lua 还远谈不上是一门好语言。我一向认为，编程语言本身需肩负起教育与规劝的责任，应该用精巧的限制和有力的规则来避免码农犯愚蠢的错误。相反，把过多的自由交给无知的键盘，只会带给世界更多的垃圾代码。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="design"></category><category term="lua"></category><category term="review"></category></entry><entry><title>用 Xcode 在 iOS 越狱设备上开发调试</title><link href="http://zhuoqiang.me/jailbroken-ios-device-debug-using-xcode.html" rel="alternate"></link><updated>2012-04-10T22:40:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-04-10:jailbroken-ios-device-debug-using-xcode.html</id><summary type="html">&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id8"&gt;目的&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#ios" id="id9"&gt;iOS 设备的设置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id10"&gt;生成私有签名&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#xcode" id="id11"&gt;设置 Xcode&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id12"&gt;告诉 Xcode 不需要签名&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id13"&gt;告诉 Xcode 不用做签发动作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#xcode-app" id="id14"&gt;指示 Xcode 使用私有签名签发 App&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id15"&gt;开始调试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id16"&gt;补充&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;目的&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;开发 iOS 程序时，如果要在真机上调试，开发者向苹果交 99 美金的年费来取得 iOS 开发者账号。钱虽不多，但有些开发者只想练练手玩一玩 iOS 开发，并不在意能否在 AppStore 上发布应用。对这些票友来说，这笔投资就有点纠结了。&lt;/p&gt;
&lt;p&gt;开发 iOS 越狱程序可以绕过这个限制，直接在真机上调试。但是要使用命令行界面。如果可以利用 Xcode 集成开发环境提供的便利性直接在真机上调试，那对开发效率的提升是巨大的。&lt;/p&gt;
&lt;p&gt;下面就介绍在不申请 iOS 开发者账号的情况下，如何使用 Xcode 在越狱的 iOS 设备上进行开发调试。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ios"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;iOS 设备的设置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;iOS 在安装运行 App 时都需要先检查它的数字签名。苹果为安全起见，只允许官方数字签名签过的 App 在真机上运行。让我们先绕过这个限制:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;越狱你的 iOS 设备。请自行放狗查找越狱教程&lt;/li&gt;
&lt;li&gt;安装越狱应用 AppSync。这需要在 Cydia 中添加源 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;http://cydia.hackulo.us&lt;/span&gt;&lt;/tt&gt;，然后选择一个适合本设备的版本安装。AppSync 能让设备绕过苹果的数字签名验证机制，从而安装我们随后用私有签名签发的 App （当然也能安装盗版 App，这不在讨论范围之内，支持正版！）&lt;/li&gt;
&lt;li&gt;重启 iOS 设备&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;每次 iOS 系统升级都要在设备上重复这一步。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;生成私有签名&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;你需要一个数字签名来签发 (codesign) App，这样 App 才能在 iOS 上运行。既然不想花 99 美金申请苹果官方的开发者签名，那就生成自己的私有签名。&lt;/p&gt;
&lt;p&gt;苹果官方文档有详细的 &lt;a class="reference external" href="https://developer.apple.com/library/mac/#documentation/Security/Conceptual/CodeSigningGuide/Procedures/Procedures.html"&gt;生成步骤&lt;/a&gt; :&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;打开 Mac OS X 操作系统自带的 &lt;tt class="docutils literal"&gt;实用工具&lt;/tt&gt; 中的 &lt;tt class="docutils literal"&gt;钥匙串访问&lt;/tt&gt; 程序&lt;/li&gt;
&lt;li&gt;在 &lt;tt class="docutils literal"&gt;钥匙串访问&lt;/tt&gt; 程序的菜单中选择 &lt;tt class="docutils literal"&gt;证书助理&lt;/tt&gt; -&amp;gt; &lt;tt class="docutils literal"&gt;创建证书&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;证书的名称一定要写 &lt;tt class="docutils literal"&gt;iPhone Developer&lt;/tt&gt;，以避免不必要的麻烦&lt;/li&gt;
&lt;li&gt;身份类型为 &lt;tt class="docutils literal"&gt;自签名根证书&lt;/tt&gt;，证书类型选 &lt;tt class="docutils literal"&gt;代码签名&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;勾选 &lt;tt class="docutils literal"&gt;让我覆盖这些默认值&lt;/tt&gt; 并继续&lt;/li&gt;
&lt;li&gt;随便输入一个的序列号。只要保证序列号和证书名称唯一就可以了&lt;/li&gt;
&lt;li&gt;输入证书信息，因为是私有证书，随便写一下就行&lt;/li&gt;
&lt;li&gt;后面选择框都用默认值就好了&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;完成后就可以在 &lt;tt class="docutils literal"&gt;钥匙串访问&lt;/tt&gt; 中看到这个刚创建的 &lt;tt class="docutils literal"&gt;iPhone Developer&lt;/tt&gt; 根证书了。它被标红警示 &lt;tt class="docutils literal"&gt;此证书不被信任&lt;/tt&gt;，表示它不是由权威机构认证生成。没关系，我们在上一步已经搞定了 iOS 设备，不再需要权威机构了。&lt;/p&gt;
&lt;p&gt;这个步骤只需一次。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="xcode"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;设置 Xcode&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我们需要告诉 Xcode 在编译调试时既不需要签名，也不用做自动的签发动作。最后还要指定使用私有签名来签发 (codesign) 我们的程序。&lt;/p&gt;
&lt;div class="section" id="id4"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id12"&gt;告诉 Xcode 不需要签名&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;因为需要更改 Xcode 的配置文件，我们首先要关闭 Xcode。为了安全起见，在修改配置文件之前请备份原始文件。&lt;/p&gt;
&lt;p&gt;以下的设置是以 Xcode 4.3 和 iOS SDK 5.0 为例。其它版本的路径略有不同，请自行修改。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS5.0.sdk/
sudo cp Info.plist Info.plist.orig
sudo vi Info.plist
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;找到&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;CODE_SIGNING_REQUIRED&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;YES&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;将 &lt;tt class="docutils literal"&gt;YES&lt;/tt&gt; 改为 &lt;tt class="docutils literal"&gt;NO&lt;/tt&gt; 。&lt;/p&gt;
&lt;p&gt;再找&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;ENTITLEMENTS_REQUIRED&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;YES&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;也将 &lt;tt class="docutils literal"&gt;YES&lt;/tt&gt; 改为 &lt;tt class="docutils literal"&gt;NO&lt;/tt&gt;&lt;/p&gt;
&lt;p&gt;再用同样方法，先备份 &lt;tt class="docutils literal"&gt;/Developer/Platforms/iPhoneOS.platform/Info.plist&lt;/tt&gt; 配置文件，然后修改其中所有的&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;CODE_SIGN_CONTEXT_CLASS&lt;span class="nt"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;string&amp;gt;&lt;/span&gt;XCiPhoneOSCodeSignContext&lt;span class="nt"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;替换其中的 &lt;tt class="docutils literal"&gt;XCiPhoneOSCodeSignContext&lt;/tt&gt; 为 &lt;tt class="docutils literal"&gt;XCCodeSignContext&lt;/tt&gt;&lt;/p&gt;
&lt;p&gt;最后，我们要修改 Xcode 的 iPhone 开发 plugin&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /Developer/Platforms/iPhoneOS.platform/Developer/Library/Xcode/PrivatePlugIns/iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support.xcplugin/Contents/MacOS/
dd &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support &lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;working &lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;500 &lt;span class="nv"&gt;count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;255
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;\xc3\x26\x00\x00&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; working
mv -n iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support.original
mv working iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support
chmod a+x iPhoneOS&lt;span class="se"&gt;\ &lt;/span&gt;Build&lt;span class="se"&gt;\ &lt;/span&gt;System&lt;span class="se"&gt;\ &lt;/span&gt;Support
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样一来，Xcode 就知道 iOS 的程序不需要签名了。&lt;/p&gt;
&lt;p&gt;该步骤对每个新安装的 Xcode 和 iOS SDK 版本都要做一遍。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id13"&gt;告诉 Xcode 不用做签发动作&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;打开任意的 Xcode 工程，选择项目文件，在 &lt;tt class="docutils literal"&gt;Build Settings&lt;/tt&gt; 中找到 &lt;tt class="docutils literal"&gt;Code Signing&lt;/tt&gt; 项，选出 &lt;tt class="docutils literal"&gt;Code Signing Identity&lt;/tt&gt; 的子条目 &lt;tt class="docutils literal"&gt;Any iOS SDK&lt;/tt&gt;，将它设置为 &lt;tt class="docutils literal"&gt;Don't Code Sign&lt;/tt&gt;。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="xcode-app"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id14"&gt;指示 Xcode 使用私有签名签发 App&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;保存下面的 python 脚本:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/env python&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;struct&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Usage: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt; appname dest_file.xcent&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;APPNAME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;DEST&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;DEST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;endswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.xml&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;DEST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;endswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.xcent&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Dest must be .xml (for ldid) or .xcent (for codesign)&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;entitlements&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;!DOCTYPE plist PUBLIC &amp;quot;-//Apple//DTD PLIST 1.0//EN&amp;quot; &amp;quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&amp;quot;&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;plist version=&amp;quot;1.0&amp;quot;&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;dict&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;    &amp;lt;key&amp;gt;application-identifier&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;    &amp;lt;string&amp;gt;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;/string&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;    &amp;lt;key&amp;gt;get-task-allow&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;    &amp;lt;true/&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;/dict&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;lt;/plist&amp;gt;&lt;/span&gt;
&lt;span class="s"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;APPNAME&lt;/span&gt;

&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;DEST&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;w&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;DEST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;endswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.xcent&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\xfa\xde\x71\x71&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;struct&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&amp;gt;L&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;entitlements&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;entitlements&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;假定脚本保存在 &lt;tt class="docutils literal"&gt;/Developer/iphoneentitlements401/gen_entitlements.py&lt;/tt&gt;，设为可执行&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;chmod 777 /Developer/iphoneentitlements401/gen_entitlements.py
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后，在每一个需要设备调试的工程里都要指定运行该脚本。选中工程文件，在 &lt;tt class="docutils literal"&gt;Build Phases&lt;/tt&gt; 页中点击右下角的 &lt;tt class="docutils literal"&gt;Add Build Phase&lt;/tt&gt; 按钮。在 &lt;tt class="docutils literal"&gt;Shell&lt;/tt&gt; 框中输入下面的脚本:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CODESIGN_ALLOCATE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/codesign_allocate
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;${PLATFORM_NAME}&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;iphoneos&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;; &lt;span class="k"&gt;then&lt;/span&gt;
/Developer/iphoneentitlements401/gen_entitlements.py &lt;span class="s2"&gt;&amp;quot;my.company.${PROJECT_NAME}&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;${BUILT_PRODUCTS_DIR}/${WRAPPER_NAME}/${PROJECT_NAME}.xcent&amp;quot;&lt;/span&gt;;
codesign -f -s &lt;span class="s2"&gt;&amp;quot;iPhone Developer&amp;quot;&lt;/span&gt; --entitlements &lt;span class="s2"&gt;&amp;quot;${BUILT_PRODUCTS_DIR}/${WRAPPER_NAME}/${PROJECT_NAME}.xcent&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;${BUILT_PRODUCTS_DIR}/${WRAPPER_NAME}/&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id15"&gt;开始调试&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;打开设置好的 Xcode 工程，连上 iOS 设备。打开 Xcode 的 &lt;tt class="docutils literal"&gt;Organizer&lt;/tt&gt; 面版，在左边的 &lt;tt class="docutils literal"&gt;Device&lt;/tt&gt; 列表中选中连接上的 iOS 设备，点击 &lt;tt class="docutils literal"&gt;Use for Development&lt;/tt&gt;，对弹出的对话框都选择 &lt;tt class="docutils literal"&gt;拒绝&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;Cancel&lt;/tt&gt;。&lt;/p&gt;
&lt;p&gt;现在点击 &lt;tt class="docutils literal"&gt;Run&lt;/tt&gt; 按钮，看看你的设备，见证奇迹的时刻到了。&lt;/p&gt;
&lt;p&gt;你也可以切换到 Debug 版本进行调试: 选择菜单 &lt;tt class="docutils literal"&gt;Product&lt;/tt&gt; -&amp;gt; &lt;tt class="docutils literal"&gt;Edit Scheme …&lt;/tt&gt; 将 &lt;tt class="docutils literal"&gt;Run YourAppName.app&lt;/tt&gt; 中的 &lt;tt class="docutils literal"&gt;Build Configuration&lt;/tt&gt; 改为 &lt;tt class="docutils literal"&gt;Debug&lt;/tt&gt;。&lt;/p&gt;
&lt;p&gt;至此，你就可以免掉 99 美金的年费尽情的在真机上调试应用了。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id16"&gt;补充&lt;/a&gt;&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;本文的方案严重参考 &lt;a class="reference external" href="http://www.alexwhittemore.com/developing-jailbroken-iphone-ios-401/"&gt;http://www.alexwhittemore.com/developing-jailbroken-iphone-ios-401/&lt;/a&gt; 向原作者致谢&lt;/li&gt;
&lt;li&gt;该方案经验证能在 Xcode 3 ~ 4, iOS 4 ~ 5 版本上运行。不同版本的配置文件路径有所不同，请自行修改&lt;/li&gt;
&lt;li&gt;要在 AppStore 上发布你的应用，99 美金的年费是无论如何省不下来的。其实价格倒也公道，毕竟 Xcode 是免费的&lt;/li&gt;
&lt;li&gt;如要正常的签发流程，请恢复备份的原始配置文件。我还没有恢复过，不保证一定能恢复成功&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</summary><category term="ios"></category><category term="mobile"></category></entry><entry><title>钢铁森林</title><link href="http://zhuoqiang.me/iron-forest.html" rel="alternate"></link><updated>2012-03-06T07:33:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2012-03-06:iron-forest.html</id><summary type="html">&lt;p&gt;树杈钢筋 &lt;br /&gt;
水泥草皮 &lt;br /&gt;
还有花朵塑料 &lt;br /&gt;
庞然大树们在阳光下低头 &lt;br /&gt;
拉出面无表情的黑影 &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;迎面走来 &lt;br /&gt;
擦肩而过 &lt;br /&gt;
低声吟唱的电波 &lt;br /&gt;
串起所有听筒 &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;所有的听筒都藏着许多 &lt;br /&gt;
许多熟悉的喧嚣 &lt;br /&gt;
许多挣扎的号码 &lt;br /&gt;
号码里住着巫王 &lt;br /&gt;
调侃誓言 &lt;br /&gt;
摆弄方向 &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;方向连着方向连着方向 &lt;br /&gt;
每一种方向都在旋转 &lt;br /&gt;
旋转着层层下降 &lt;br /&gt;
下降的森林没有不安 &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;嗅到的大地 &lt;br /&gt;
满是 &lt;br /&gt;&lt;/p&gt;
&lt;p&gt;树杈钢筋 &lt;br /&gt;
水泥草皮 &lt;br /&gt;
还有花朵塑料&lt;/p&gt;
</summary><category term="poem"></category></entry><entry><title>找自己</title><link href="http://zhuoqiang.me/find-ego.html" rel="alternate"></link><updated>2011-10-13T23:02:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-10-13:find-ego.html</id><summary type="html">&lt;p&gt;双脚开立，与肩同宽。&lt;/p&gt;
&lt;p&gt;曲膝，松胯，塌腰，坠肘，沉肩，含胸，拔背，头领。&lt;/p&gt;
&lt;p&gt;自觉动作到位，正想进一步领悟静中有动的太极境界，师父却走过来把我上身往后推了半掌: 这样才站的中正!&lt;/p&gt;
&lt;p&gt;原来自以为站正的时候，身体却是往前顷的。仔细体会一下脚底的感觉，以前的站姿前脚掌实而后脚跟虚，重心确实偏前。被师父纠正后再体味一下，全身重量平均分担在双脚之间，原来身体隐藏的紧张感也随着姿态的调整减轻了很多。&lt;/p&gt;
&lt;p&gt;继续曲膝，松胯，塌腰，坠肘，沉肩，含胸，拔背，头领。头脑放羊: 练太极缓而稳，动静之间处处在找重心，可是自己却找错了重心而不自知。&lt;/p&gt;
&lt;p&gt;身体习惯性的往前倾，是潜意识里渴望得到认同的表现吗;&lt;/p&gt;
&lt;p&gt;若是不自觉的往后躲，又是否意谓着拒绝世界?&lt;/p&gt;
&lt;p&gt;可不论是渴望融入，还是害怕进入，我们总会不自觉的被外界影响，偏了自己的重心。&lt;/p&gt;
&lt;p&gt;其实人生在世，外在的一切都是空空如也，唯一可持的就是自己钉在大地上的双脚，找到重心就是找到立足之本。&lt;/p&gt;
&lt;p&gt;乔布斯说: Your time is limited, so don't waste it living someone else's life&lt;/p&gt;
&lt;p&gt;佛陀说: 天上天下，唯我独尊&lt;/p&gt;
&lt;p&gt;Follow my heart&lt;/p&gt;
&lt;p&gt;初练太极，有悟于心，遂记之&lt;/p&gt;
</summary><category term="essay"></category><category term="life"></category></entry><entry><title>Lexing Python Indentation using Spirit.Lex</title><link href="http://zhuoqiang.me/lexing-python-indentation-using-spirit-lex.html" rel="alternate"></link><updated>2011-09-08T22:06:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-09-08:lexing-python-indentation-using-spirit-lex.html</id><summary type="html">&lt;p&gt;Python is well known for its whitespace-sensitivity grammar. The indentation level provides block scoping in python language. While it is possible to parse python using just straight Spirit.Qi, however, it looks messy to mixing the low level indentation handling in the parsing level. Fortunately Spirit.Lex could be a help here to transform the indentation to a bunch of proper &lt;tt class="docutils literal"&gt;BEGIN&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;END&lt;/tt&gt; tokens, which will simplify the parsing logic later.&lt;/p&gt;
&lt;p&gt;Here's how to deal with indentation: for each line of the input, current line's indentation level will be compared with previews one stored in a stack:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;If the indentation is increasing it is pushed into the stack and a &lt;tt class="docutils literal"&gt;BEGIN&lt;/tt&gt; token is generated&lt;/li&gt;
&lt;li&gt;If indentation is not changed, just continue and nothing happens&lt;/li&gt;
&lt;li&gt;if it is decreasing comparing with the top indentation number on the stack, the top number then will be popped off from the stack and a corresponding &lt;tt class="docutils literal"&gt;END&lt;/tt&gt; token is generated until the same indentation number appears on top of the stack. If the same indentation number cannot be found on the stack, an indentation error occurs.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;At the end of the input, an &lt;tt class="docutils literal"&gt;END&lt;/tt&gt; token is generated for each indentation level remains on the stack (until only 0 remains).&lt;/p&gt;
&lt;p&gt;For simplicity let's handle just spaces for now and ignore tabs&lt;/p&gt;
&lt;p&gt;The first shot is to match zero or more spaces at the beginning of the line and then calculate the total length of the spaces in a semantic action&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;indent_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;^[ ]*&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;identifier_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[a-zA-Z_]&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;w*&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;
    &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;indent_&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;_val&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_end&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;_begin&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;identifier_&lt;/span&gt;
    &lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However, this won't work for lines without spaces at the beginning.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;a_variable_without_any_indent&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above will only match &lt;tt class="docutils literal"&gt;identifier_&lt;/tt&gt; but not zero length &lt;tt class="docutils literal"&gt;indent_&lt;/tt&gt;. It seems there is no way to match the pseudo &lt;tt class="docutils literal"&gt;beginning of line&lt;/tt&gt; anchors with Spirit.Lex&lt;/p&gt;
&lt;p&gt;The workaround is to match newline manually and switch to another lexer state dedicating for indentation.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;Lexer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Tokens&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="k"&gt;public&lt;/span&gt; &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;lexer&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Lexer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
 &lt;span class="nl"&gt;public:&lt;/span&gt;
  &lt;span class="n"&gt;Tokens&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
      &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;indent_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[ ]*&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;newline_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;n&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;r&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;f]+&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;whitespace_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[ &lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;t]+&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;if_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;if&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;identifier_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;[a-zA-Z_]&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;w*&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;equal_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;==&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;colon_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;&amp;#39;:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;assign_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sc"&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;integer_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;d+&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;
        &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;indent_&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;HandleIndent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
        &lt;span class="p"&gt;;&lt;/span&gt;

    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;self&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;NORMAL&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;newline_&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;HandleNewline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;whitespace_&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;_pass&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_flags&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_ignore&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;if_&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;equal_&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;colon_&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;assign_&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;integer_&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;identifier_&lt;/span&gt;
        &lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

 &lt;span class="nl"&gt;private:&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;indent_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;newline_&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;whitespace_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="c1"&gt;// keywords&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;if_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;identifier_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="c1"&gt;// operators&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;equal_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="c1"&gt;// delimiters&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;colon_&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;assign_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="c1"&gt;// literal&lt;/span&gt;
  &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;token_def&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;integer_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we use the default &lt;tt class="docutils literal"&gt;INITIAL&lt;/tt&gt; lexer state for indentation handling and &lt;tt class="docutils literal"&gt;NORMAL&lt;/tt&gt; state for other token matching. Actually the indentation handling must be the &lt;tt class="docutils literal"&gt;INITIAL&lt;/tt&gt; state in order to handle the first line since there is no newline before it.&lt;/p&gt;
&lt;p&gt;We use a stack &lt;tt class="docutils literal"&gt;scopeLevels_&lt;/tt&gt; to help store indentation levels:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;enum&lt;/span&gt; &lt;span class="n"&gt;TokenIds&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="n"&gt;kTokenBegin&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;kTokenEnd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1001&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HandleIndent&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
 &lt;span class="nl"&gt;public:&lt;/span&gt;
  &lt;span class="n"&gt;HandleIndent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;{}&lt;/span&gt;

  &lt;span class="k"&gt;template&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;IdType&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="k"&gt;operator&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
      &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;BOOST_SCOPED_ENUM&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_flags&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;passFlag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;IdType&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;

    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;level&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;distance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
      &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;runtime_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Indent must start from 0!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
      &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="c1"&gt;// If the level is same, just ignore it and switch to normal state&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;top&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;passFlag&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_flags&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_ignore&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_state_name&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;NORMAL&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="c1"&gt;// If the level is larger, emit BEGIN and push the new level on stack&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;top&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
      &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;level&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
      &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kTokenBegin&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_state_name&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;NORMAL&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="c1"&gt;// If the level is smaller, emit END and pop the top level from stack&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="c1"&gt;//Dedent, end scope&lt;/span&gt;
      &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
      &lt;span class="c1"&gt;// Level must be one of the numbers occurring on the stack&lt;/span&gt;
      &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;level&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;top&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;runtime_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Dedenting failed, could not find indent matching previews &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
      &lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="c1"&gt;// make it a zero match, we can generate multiple END token by this trick&lt;/span&gt;
        &lt;span class="n"&gt;end&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kTokenEnd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

 &lt;span class="nl"&gt;private:&lt;/span&gt;
  &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HandleNewline&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
 &lt;span class="nl"&gt;public:&lt;/span&gt;
  &lt;span class="n"&gt;HandleNewline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;{}&lt;/span&gt;

  &lt;span class="k"&gt;template&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;IdType&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="k"&gt;operator&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
      &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;Iterator&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;BOOST_SCOPED_ENUM&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_flags&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;passFlag&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;IdType&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_eoi&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
      &lt;span class="c1"&gt;// If the &amp;quot;end of input&amp;quot; is reached&lt;/span&gt;
      &lt;span class="c1"&gt;// we pop up all the non-zero levels.&lt;/span&gt;
      &lt;span class="c1"&gt;// for each pop up we generate a corresponding END token&lt;/span&gt;
      &lt;span class="c1"&gt;// here we apply the zero-match trick again to emit multiple END token&lt;/span&gt;
      &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;top&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="n"&gt;end&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kTokenEnd&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;passFlag&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;lex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_flags&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;pass_ignore&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_state_name&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;INITIAL&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

 &lt;span class="nl"&gt;private:&lt;/span&gt;
  &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;scopeLevels_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice how we apply the &lt;cite&gt;zero-length matching&lt;/cite&gt; trick to generate multiple tokens.&lt;/p&gt;
&lt;p&gt;Now, let's try lex some python code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;c&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;e&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here's the result:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt;
&lt;span class="n"&gt;a&lt;/span&gt;
&lt;span class="o"&gt;==&lt;/span&gt;
&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;BEGIN&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt;
&lt;span class="n"&gt;b&lt;/span&gt;
&lt;span class="o"&gt;==&lt;/span&gt;
&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;BEGIN&lt;/span&gt;
&lt;span class="n"&gt;c&lt;/span&gt;
&lt;span class="n"&gt;END&lt;/span&gt;
&lt;span class="n"&gt;END&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt;
&lt;span class="n"&gt;d&lt;/span&gt;
&lt;span class="o"&gt;==&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;
&lt;span class="p"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;BEGIN&lt;/span&gt;
&lt;span class="n"&gt;e&lt;/span&gt;
&lt;span class="n"&gt;END&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Spirit.Qi could treat the &lt;tt class="docutils literal"&gt;BEGIN&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;END&lt;/tt&gt; tokens as block delimiters, exactly as curly braces in C/C++.&lt;/p&gt;
&lt;p&gt;There's still a limitation however: There must be a newline at the end of the input otherwise the end of input cannot be detected in the HandleNewline function. A possible workaround I could think of is to have an iterator adapter to add the missing newline in the end of the input if needed.&lt;/p&gt;
&lt;p&gt;It would make lexing python much easier if Spirit.Lex could support matching pseudo tokens like:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Begin of the line&lt;/li&gt;
&lt;li&gt;End of the line&lt;/li&gt;
&lt;li&gt;Begin of the input&lt;/li&gt;
&lt;li&gt;End of the input&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For Spirit.Lex currently there is no clear way to fail the whole lexing process inside the semantic action. Assigning &lt;tt class="docutils literal"&gt;pass_failed&lt;/tt&gt; flag won't work since it only fails current token's matching process. In the code above an exception is thrown to stop the lexing process, however I do hope there is a build-in support for this.&lt;/p&gt;
&lt;p&gt;Finally, there seems no debug support in Spirit.Lex as in Spirit.Qi. A debug support like what Spirit.Qi provides will be very handy for trouble shooting in Spirit.Lex (Spirix.Lex actually has debug support using the macro &lt;tt class="docutils literal"&gt;BOOST_SPIRIT_LEXERTL_DEBUG&lt;/tt&gt;)&lt;/p&gt;
&lt;p&gt;References:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://docs.python.org/release/3.1.3/reference/lexical_analysis.html#indentation"&gt;Python lexical analysis for indentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://boost.2283326.n4.nabble.com/lexing-python-redux-td2681157.htm"&gt;Lexing python redux discussion&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</summary><category term="boost"></category><category term="c++"></category><category term="compiler"></category><category term="english"></category><category term="python"></category><category term="spirit"></category></entry><entry><title>ChmFox 2 发布啦</title><link href="http://zhuoqiang.me/chmfox2.html" rel="alternate"></link><updated>2011-08-18T11:36:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-08-18:chmfox2.html</id><summary type="html">&lt;p&gt;如果你还不知道 ChmFox 是什么，这里是一句话介绍：ChmFox 是一款让 Firefox 变身成 CHM 文件浏览器的扩展，目标是给所有平台提供最好的 CHM 浏览体验。（更多请看 &lt;a class="reference external" href="http://zhuoqiang.me/chmfox.html"&gt;ChmFox 介绍&lt;/a&gt; ）&lt;/p&gt;
&lt;p&gt;随着 Firefox 6 正式版的发布 &lt;a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/chmfox/versions/2.2"&gt;ChmFox 新版 2.2&lt;/a&gt; 也发布了。该版本加入了对 Firefox 6 的支持，还有下面的更新：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;兼容性增强：支持 Firefox 版本 4.0 到 9.0a1，未来版本的 Firefox 也可 &lt;a class="reference external" href="http://www.google.com/search?q=firefox+%E5%BC%BA%E5%88%B6%E5%85%BC%E5%AE%B9&amp;amp;ie=utf-8&amp;amp;oe=utf-8&amp;amp;aq=t&amp;amp;rls=org.mozilla:zh-CN:official&amp;amp;client=firefox-a"&gt;强制兼容&lt;/a&gt; 。但放弃了对 Firefox 3 的支持&lt;/li&gt;
&lt;li&gt;新平台：增加对 Windows 和 Mac 的 x64 支持。完成了 Windows, Linux, Mac 的 x86 和 x64 的全平台支持&lt;/li&gt;
&lt;li&gt;本地化界面：包含简中，繁中和英语支持&lt;/li&gt;
&lt;li&gt;贴心侧栏：自动判断是否打开或关闭 CHM 侧栏，同时记住每个 CHM 文件上次侧栏的状态&lt;/li&gt;
&lt;li&gt;大幅提高侧栏性能&lt;/li&gt;
&lt;li&gt;修正若干小问题&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;现在该版本正等待 Mozilla 评审，欢迎大家从 &lt;a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/chmfox/versions/2.2"&gt;这里&lt;/a&gt; 下载试用。有任何问题，请留言或直接到 &lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox/issues"&gt;官网&lt;/a&gt; 提 Issue。&lt;/p&gt;
&lt;p&gt;简单介绍完毕，下面是一些开发者角度的吐槽。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id8"&gt;贴心侧栏&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#xpcom" id="id9"&gt;二进制 XPCOM 组件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#js-ctypes" id="id10"&gt;js-ctypes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id11"&gt;测试&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id12"&gt;关于捐赠&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;贴心侧栏&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;很多户都要求 ChmFox 自动把 CHM 目录侧栏打开。我本人习惯了用快捷键去控制，却忘了用户开始时是不会用快捷键的。&lt;/p&gt;
&lt;p&gt;如果改成自动把侧栏打开，这样会方便选取章节。可我的使用习惯是把侧栏关闭好为内容留出更多的屏幕，需要时再用快捷键把侧栏呼出。这种矛盾怎么解决？一种方案是推给用户，添加一个配置项让用户选择是否默认打开侧栏。ChmFox 在这里走了另一条路，程序智能的判断是否需要打开侧栏，贴心地帮用户做出最适合他的选择。当你切换标签栏，或打开新文件时：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;如果当前页面不是 CHM 页面，就自动关闭 CHM 侧栏，同时也禁止手工打开侧栏&lt;/li&gt;
&lt;li&gt;全新打开一个 CHM 文件，自动把目录侧栏打开&lt;/li&gt;
&lt;li&gt;当你手工开启或关闭侧栏时，ChmFox 会记住这个 CHM 文件的侧栏状态&lt;/li&gt;
&lt;li&gt;再次打开曾经的 CHM 文件，会根据上次这个文件的侧栏状态调整侧栏&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样的自动判断是否真的贴心恐怕需要大家用过才能知道。这里的理念是：针对普通用户的软件，尽量减少选项和配置。与其做一款密布选项表面专业实则难用的软件，不如做一款零配置自适应的傻瓜软件。&lt;/p&gt;
&lt;p&gt;有朋友问是否一点设置选项都不需要，我想说，不错，这正是我的目标！零配置傻瓜软件背后隐藏着复杂的智能判断逻辑。希望我的软件始终能做到这点。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="xpcom"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;二进制 XPCOM 组件&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Firefox 扩展开发以网页技术为主，如 HTML, Javascript, CSS 等。通过 Javascript 调用 Firefox 内置的众多 XPCOM 组件，大部分扩展功能都能实现。对于少数复杂应用，还可以用 C++ 实现新的二进制 XPCOM 组件，补足 Firefox 内置组件的不足。ChmFox 1.x 正是使用自定义的二进制 XPCOM 组件进行 CHM 文件的解析。&lt;/p&gt;
&lt;p&gt;它的问题在于，二进制 XPCOM 组件要分别与每个平台上的 Gecko SDK 一起编译。更坑爹的是，Firefox 大版本号升级时各平台的 Gecko SDK 都会更新，而二进制 XPCOM 组件必须与新的 Gecko SDK 重新编译才能工作。要维护这么多平台（6个平台）的同步编译升级还真是体力活，尤其是现在 Firefox 疯着和 Chrome 比拼版本号，几周就有新版本出来。这不 &lt;a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/capture-fox/"&gt;Capture Fox&lt;/a&gt; 扩展的作者因此不打算再跟着 Firefox 玩升级游戏了，明确表示不会再浪费时间支持 Firefox 5，开源程序员你伤不起啊。&lt;/p&gt;
&lt;p&gt;ChmFox 也面临同样的升级兼容困境。好在，Firefox 准备了另一条路：js-ctypes。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="js-ctypes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;js-ctypes&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;js-ctypes 简言之，就是 Javascript 版的 Python ctypes。通过这个 Javascript 库，你就能使用 Javascript 调用任意的 C 接口动态库。包括在 Javascript 中定义 C 结构体，把 Javascript 函数包装成 C 的回调函数等高级功能一个不拉都支持。底层上，js-ctypes 与 Python 的 ctypes 都是通过 libffi 实现，他们的功能也大同小异。&lt;/p&gt;
&lt;p&gt;Firefox 4 （Gecko 2） 正式支持 js-ctypes，同时 Mozilla 也建议原来使用二进制 XPCOM 组件的扩展都转到 js-ctypes 上来。这样，你只需要把复杂的功能封装在普通的 C 动态库中，剩下的都用 Javascript 就可以开发复杂的扩展了。这种方式比用 C++ 写 XPCOM 组件要简单的多。而且，你再也不用仅仅为了跟上 Firefox 大版本升级就重新编译了，一劳永逸地解决了升级时二进制兼容的问题。也许正因为如此，Firefox 才能安心的狂飙大版本号。&lt;/p&gt;
&lt;p&gt;ChmFox 2.x 升级主要的工作量就是使用 js-ctypes 替换原来的二进制 XPCOM 组件，改写了原来一大半的代码，最终的结果超过预期。实现原来所有的功能的同时，程序变的更加简洁，扩展大小减少了 1/3，性能也有一定提升。为后面添加新特性和性能调优打下了基础。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;测试&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;因为精力有限，开发时主要测试平台是我常用的 Ubuntu x86。这次上传了 ChmFox 2.1 后，又在 Windows x86 上试用了一下，侧栏居然有问题。果然发现有个平台相关的 BUG，修改完了赶快重新上传，心里不免惴惴然。应该说 ChmFox 绝大部分代码是平台无关的，而且资源和精力实在有限，很难保证每个平台的测试，特别是 Mac 平台和众多的 Linux 发行版。如果有什么意外，这里还请大家多包涵。也欢迎帮助把遇到的问题提过来。可以直接在这里留言，也可以提到 &lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox/issues"&gt;开发网站&lt;/a&gt; 上&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;关于捐赠&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ChmFox 1.x 时，我在 Mozilla 官方扩展主页放了默认 1.99 美元的爱心贡献按钮，本意是想测试爱心贡献靠不靠谱。一个月过去了，意外的收到老外的一笔 1.99 的捐款。心情之复杂堪比第一次工资到手的感觉。不禁感叹世上还是好人多，我又相信爱情了！激动之余，顺手就把默认捐款额上调到了 3.99 美元 :)&lt;/p&gt;
&lt;p&gt;其实 1.99 美元扣了手续费后也就只能吃餐盒饭，物质上并没有什么，但和大家的感谢留言一样，这些肯定让我直接体验到了做软件这件事的价值，谢谢！&lt;/p&gt;
&lt;p&gt;后面 ChmFox 改进方向将是完善搜索功能：将目录，索引和全文的搜索做到统一的界面上。也欢迎大家留言各种批评建议吐槽等。&lt;/p&gt;
&lt;p&gt;更新: 感谢 PcX 的测试反馈，现已上传 2.2 版本， 修正 Windows 平台不能打开中文文件名 CHM，和不能正确关闭文件句柄的错误。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="chmfox"></category><category term="firefox"></category><category term="opensource"></category><category term="javascript"></category></entry><entry><title>ChmFox</title><link href="http://zhuoqiang.me/chmfox.html" rel="alternate"></link><updated>2011-07-12T00:30:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-07-12:chmfox.html</id><summary type="html">&lt;p&gt;新版本 2.2 已发布，升级和新功能请看 &lt;a class="reference external" href="http://zhuoqiang.me/chmfox2.html"&gt;ChmFox2&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最近有很多朋友问 ChmFox 的问题，这里大致介绍一下，也做个推荐。&lt;/p&gt;
&lt;p&gt;ChmFox 是一款 Firefox 扩展。它可以将 Firefox 变成阅读 CHM 文件的利器。如果和 Firefox 上众多提升阅读体验的扩展配合使用，你就拥有了最好的 CHM 阅读软件。更棒的是，它和 Firefox 一样是跨平台的，你可以在 Windows，Linux，Mac 等平台上获得一致的 CHM 阅读体验。&lt;/p&gt;
&lt;img alt="|filename|/images/chmfox.png" src="http://zhuoqiang.me/static/images/chmfox.png" /&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id10"&gt;安装&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id11"&gt;使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id12"&gt;高级使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id13"&gt;编译方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id14"&gt;内幕&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id9" id="id15"&gt;未来&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;安装&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ChmFox 从 1.1 版开始就通过了 Mozilla 的官方认证，现在你可以直接在 Firefox 的菜单 附加组件 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--&amp;gt;&lt;/span&gt;&lt;/tt&gt; 获取附加组件 中搜索并安装它。当然，你也可以去 ChmFox 在 Mozilla 官网上的 &lt;a class="reference external" href="https://addons.mozilla.org/firefox/addon/chmfox/"&gt;主页&lt;/a&gt; 去下载安装。安装完后需要重启 Firefox 才能生效。安装过程中会提醒给作者捐款以支持开发，这里就悉听尊便了。当然，不捐款是完全不影响使用的。&lt;/p&gt;
&lt;p&gt;目前 ChmFox 1.1 支持以下操作系统：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Windows&lt;/li&gt;
&lt;li&gt;Linux x86_64&lt;/li&gt;
&lt;li&gt;Linux i686&lt;/li&gt;
&lt;li&gt;Mac i386&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果 ChmFox 暂时不支持你的操作系统，你又比较 geek 的话，请看后面的编译章节自行编译。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;使用&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在重启完 Firefox 后，就可以开始使用 ChmFox 了。你可以使用下面众多方式打开 CHM 文件：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;使用菜单中的 打开文件 选择要打开的 CHM 文件&lt;/li&gt;
&lt;li&gt;用鼠标将 CHM 文件拖入 Firefox 窗口中&lt;/li&gt;
&lt;li&gt;使用命令行直接打开，例如： &lt;tt class="docutils literal"&gt;firefox.exe &lt;span class="pre"&gt;c:\\hello.chm&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后一种方式也是操作系统所熟知的打开方式。这意谓着，你可以直接将 CHM 文件类型关联到 Firefox 上。以后直接双击 CHM 文件，操作系统就会用 Firefox 去打开它。&lt;/p&gt;
&lt;p&gt;一般 CHM 文件都会有目录，有些还会有索引。ChmFox 提供了专门的侧栏来显示它们。你可以通过菜单 &lt;tt class="docutils literal"&gt;查看 &lt;span class="pre"&gt;--&amp;gt;&lt;/span&gt; 侧栏 &lt;span class="pre"&gt;--&amp;gt;&lt;/span&gt; ChmFox&lt;/tt&gt; 来打开和关闭。方便起见，ChmFox 同时提供了打开侧栏的快捷键 &lt;span class="kbd"&gt;alt shift m&lt;/span&gt; 侧栏的使用也很直观，直接点击侧栏上的某个条目就可以转到相关页面。&lt;/p&gt;
&lt;p&gt;在阅读时，你也可以将页面直接加入收藏夹。下次可以直接通过收藏夹中的链接打开相应的文件的页面。&lt;/p&gt;
&lt;p&gt;ChmFox 对 CHM 使用了自定义的 URI schema, 形如：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;chm:///c:/path/to/file.chm!/page_url.html
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在命令行中，也可以使用 Firefox 直接打开这种 CHM 的 URI：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;firefox.exe chm:&lt;span class="n"&gt;///c:/hello.chm!/home.html&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果觉得字的大小不合适，还可以使用 Firefox 提供的页面缩放功能进行调整。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;高级使用&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;ChmFox 可以和众多优秀的 Firefox 扩展配合使用，提升 CHM 阅读体验。例如：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;使用 Firefox 的 NoSquint 扩展，自动调整页面和文字大小&lt;/li&gt;
&lt;li&gt;使用 Delicious Extension 将阅读页面收藏到 Delicious 上。这样就可以在不同机器间同步阅读进度。不过，这要求不同机器上的 CHM 文件路径要相同。&lt;/li&gt;
&lt;li&gt;使用 ScrapBook 对关键页面加入评注并收藏，做成读书笔记&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个列表还能继续下去。大家都有自己最爱的 Firefox 扩展，在使用 ChmFox 时你完全可以发挥想象力，通过组合不同的优秀扩展，提升自己的阅读体验。&lt;/p&gt;
&lt;p&gt;这也正是 Firefox 的魅力所在。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;编译方法&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;虽然 ChmFox 已经支持了很多平台，但因为精力有限，还是有漏网之鱼（例如问的比较多的 Mac x86_64 平台）。好在，ChmFox 是使用跨平台的 C/C++ 和 Javascript 开发的开源项目。如果有兴趣，你可以自行编译对特殊平台的支持，下面是简略的编译方式:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;安装 &lt;a class="reference external" href="http://python.org"&gt;Python&lt;/a&gt; 用来运行 SCons&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;安装 &lt;a class="reference external" href="http://www.scons.org"&gt;SCons&lt;/a&gt; 用来运行 ChmFox 的编译脚本&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;下载最新的 &lt;a class="reference external" href="https://developer.mozilla.org/en/Gecko_SDK#Downloading"&gt;Gecko SDK&lt;/a&gt; 选择合适你平台的 SDK (新版 ChmFox 已经不需要了)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;下载最新的 &lt;a class="reference external" href="https://bitbucket.org/zhuoqiang/chmfox"&gt;ChmFox 源代码&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;修改 ChmFox 源码中的 &lt;tt class="docutils literal"&gt;chrome.manifest&lt;/tt&gt; ，增加平台说明，例如&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;binary-component platform&lt;span class="n"&gt;/Darwin_x86_64-gcc3/components/libchm.dylib&lt;/span&gt; ABI&lt;span class="o"&gt;=&lt;/span&gt;Darwin_x&lt;span class="m"&gt;86&lt;/span&gt;_&lt;span class="m"&gt;64&lt;/span&gt;-gcc&lt;span class="m"&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;将 Gecko SDK 解压到某个目录，打开命令行，进入 ChmFox 源代码根目录，执行:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;GECKO_SDK&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;/full/path/to/gecko_sdk&lt;/span&gt; scons xpi
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果顺利，在 ChmFox 源代码根目录会新生成一个 xpi 文件，将它拖到 Firefox 中就可以安装了。&lt;/p&gt;
&lt;p&gt;也欢迎大家将编译的结果寄给我，我会将您的劳动加入到下一个发行包中，让更多的人受益。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id14"&gt;内幕&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;上面大致讲了 ChmFox 的使用，如果你对 ChmFox 本身感兴趣的话，下面是关于它的一些内幕。&lt;/p&gt;
&lt;p&gt;ChmFox 是本博的作品。内举不避亲，我也希望 ChmFox 能够帮到大家。每一个好软件的起因都是挠到了开发者本人的痒处，ChmFox 也不例外。几年前有一款 Firefox 扩展叫 CHM Reader，它正是 ChmFox 的前身。当时看到它确实眼前一亮，通过它，Firefox 就可以用来阅读 CHM，很多好的阅读体验也能用在 CHM 上了。而且它支持 Linux, 从此就再不用在 Linux 的众多虽勘用但都略有缺陷的 CHM 阅读软件中做选择了。连 Windows 上的 CHM 默认阅读器都可以退休了。这款扩展当时只有一个令我不爽的地方：它需要用自己单独的菜单栏打开 CHM 文件，不能直接命令行打开 CHM 文件。这样就不能进行文件关联。你需要通过变通的方式才能设置成双击 CHM 文件 Firefox 自动打开。但不管如何，这只是个小缺陷，还没有让我心痒难耐。直到 Firefox 4 发布后，似乎原作者没有要继续开发新版支持 Firefox 4 的意思，这才下决心自己挽起袖子做一款新的插件。首要的目标就是支持 Firefox 4，同时，也改进原版不能直接打开 CHM 文件的缺陷。&lt;/p&gt;
&lt;p&gt;开发从今年 ５.1 假期开始，到 ChmFox 1.1 版本被 Mozilla 审核通过，断断续续持续了两个月时间。其中真正开发的时间算下来只有３个周末。比我想象的要困难些。由于从没接触过 Firefox 扩展开发，一开始花了一周的时间用来学习 CHM Reader 等优秀扩展的代码。下面是一些流水账：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Firefox 4 是个大版本升级，Gecko SDK 2.0 包含了很多不兼容的接口升级，原来的 CHM Reader 的接口代码都要改变。这里是 &lt;a class="reference external" href="https://developer.mozilla.org/en/XPCOM/XPCOM_changes_in_Gecko_2.0"&gt;参考资料&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;增加一个自定义的 &lt;tt class="docutils literal"&gt;uriContentListener&lt;/tt&gt; ，通过它把 CHM 文件的 URI 转成上面自定义的 CHM URI，从而使 Firefox 能直接打开 CHM 文件&lt;/li&gt;
&lt;li&gt;修正了一些 CHM Reader 上原有的 Bug&lt;/li&gt;
&lt;li&gt;制作程序图标，准备提交 Mozilla 审阅的资料&lt;/li&gt;
&lt;li&gt;进一步修改程序，以符合 Mozilla 审核的标准&lt;/li&gt;
&lt;li&gt;增加对 Firefox 5 的支持&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在开发中最大的问题是 ChmFox 中使用的 binary component。它需要在每个平台上编译出各自的版本。Mozilla 又规定，Firefox 每次大版本升级，binary component 必须与最新的 Gecko SDK 一起重新编译。按现在 Firefox 一个多月出一个大版本的速度，程序编译的工作量无形增加了很多。以后 ChmFox 可能会把 binary component 干掉，用 &lt;a class="reference external" href="https://developer.mozilla.org/en/javascript_code_modules/ctypes.jsm"&gt;ctypes.jsm&lt;/a&gt; 直接操作普通的动态库减轻升级的工作量（最新版已经完成）。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id9"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id15"&gt;未来&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;虽然 ChmFox 功能简单，可细想想还是有很多可以改进的空间，下面是我的一些计划：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;持续加入对 Firefox 新版本的支持（这个要吐槽一下 Firefox 疯了似的大版本升级）&lt;/li&gt;
&lt;li&gt;增加对新平台的支持，例如 Mac x86_64&lt;/li&gt;
&lt;li&gt;增加 I18N/L10n 的支持，更加专业一些&lt;/li&gt;
&lt;li&gt;可以自定义开关侧栏的快捷键，避免与其它扩展冲突&lt;/li&gt;
&lt;li&gt;全文搜索&lt;/li&gt;
&lt;li&gt;使用 &lt;tt class="docutils literal"&gt;ctypes.jsm&lt;/tt&gt; ＋ dynamic library 取代 binary component&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;欢迎大家在使用 ChmFox 时给它多提意见。一起帮它变的更好！&lt;/p&gt;
&lt;/div&gt;
</summary><category term="chmfox"></category><category term="firefox"></category><category term="opensource"></category></entry><entry><title>推与拉</title><link href="http://zhuoqiang.me/push-and-pull.html" rel="alternate"></link><updated>2011-06-13T22:19:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-06-13:push-and-pull.html</id><summary type="html">&lt;p&gt;推与拉是两种设计风格，各有优劣。本文略述一二，抛砖引玉。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id6"&gt;如何推，怎么拉&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id7"&gt;网络编程中的推与拉&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id8"&gt;推拉转换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id9"&gt;语言的支持&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;如何推，怎么拉&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;众所周知，程序＝数据＋算法。数据和算法互相配合的方式，决定了这段程序是推模型还是拉模型。&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;推模型：数据源将数据推给算法，算法被动地等待数据的到来&lt;/li&gt;
&lt;li&gt;拉模型：数据源等待算法的访问，算法主动地将数据从数据源中拉出&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在程序世界中，推与拉经常在不同的层次出现。&lt;/p&gt;
&lt;p&gt;回调函数是典型的推模型的应用，设计模式中的 Template Method，Command，Observer，Visitor 中都有回调函数的身影，更别提 GUI 编程中无处不在的事件处理函数了。这里是好莱坞原则的天下：Don't call us, we will call you.&lt;/p&gt;
&lt;p&gt;相反，普通的循环，设计模式中的 Iterator，通常的命令行交互程序则是拉模型的应用了。&lt;/p&gt;
&lt;p&gt;有时，相同的功能还有推模型与拉模型两种 API 实现，最典型的要数 XML 解析库了，DOM 方式的 API 是拉模型的代表，而 SAX API 则可算做推模型的典范。&lt;/p&gt;
&lt;p&gt;推模型的特点是性能好，但编写不容易，经常需要自己维护系统的状态。拉模型则相反，它符合人的直觉，状态由运行时的栈自动维护，理解容易，可惜往往性能不高，同时，单个栈也很难满足复杂的应用逻辑。&lt;/p&gt;
&lt;p&gt;“長短之相形也，高下之相呈也”，推与拉也是相生相克的一对。往往系统中某一个推模型需要另一个拉模型来支持，反之亦然。或言之，没有人推送，你又怎么能拉到数据呢。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;网络编程中的推与拉&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;让我们用上面的观点来分析一下 Windows 平台上不同的网络模型对于 socket 的读请求的处理方式。&lt;/p&gt;
&lt;p&gt;最简单的是阻塞模型，对一个 socket 发起读请求后，程序会阻塞直到读请求调用完成后再返回。这是一个直白的拉模型，编写最为方便，当然，效率也是最低的。程序会经常阻塞在 IO 事件上，不能充分利用 CPU。&lt;/p&gt;
&lt;p&gt;再好一点的是 select 模型：先用 select 函数判断 socket 是否可读，如可读则可安全的调用阻塞的读函数而不用等待 IO 数据了。如果 select 判定该 socket 不可读，程序可以做些别的事情（比如读另外一个可读的 socket，或做些计算等等），不用象阻塞模型一样一直等待下去。可以看出，select 模型比阻塞模型要复杂些，但本质上，它还是一个拉模型。有趣的是，常有人把它包装成 Reactor 模式：当有事件到来时，Reactor 会调用预先注册的回调函数来处理。可以看出，推与拉在这里做了一次转换，select 做为拉模型，将数据从底层拉过来，Reactor 做为推模型，又将拉来的数据推送到相应的回调函数上。&lt;/p&gt;
&lt;p&gt;Windows 平台上性能最好的当数完成端口（IOCP）模型了。它是开发高并发网络服务器程序的不二选择。这是一个编写起来有些困难的拉模型：当网络事件完成后，系统会把事件投递到完成端口的工作队列中，等待在队列另一端的处理线程会被唤醒进行相应的处理。&lt;/p&gt;
&lt;p&gt;为什么完成端口的性能高呢？从最底层看，所有的 IO 事件都是通过网络推过来的。操作系统通过中断相量（可以理解为最底层的回调函数）响应网络包数据。系统内核在一系列协议栈解析和系统内核对象映射之后，若干 IO 事件被构建成一个 socket 句柄的上的读事件。select 模型这时就需要在用户层遍历所有的 &lt;tt class="docutils literal"&gt;fd_set&lt;/tt&gt; 中的 socket 句柄来找到可读的 socket，（没错，Windows 平台的 select 就是简单的 for 循环）这无疑浪费了 CPU 资源，如果 socket 数量成千上万的话，select 模型的大部份消耗都将花费在内部的傻瓜循环上。完成端口模型则相反，它不需要在用户空间由应用层再次遍历，反而会在内核直接把 socket 上读到的数据拷入用户缓冲区中，再唤醒一个工作线程处理读到的数据。虽然完成端口是拉模型，但从逻辑上看，它更象一个推模型（预先准备好的用户空间的缓冲区，阻塞在完成端口上等待被调度的工作线程）。事实上，它一般被封装成名为 Proactor 的推模型。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;推拉转换&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;从上面的分析可以看出，推模型与拉模型并非泾渭分明，却是互为表里。可谓“推拉之相合也”，两者各有优劣，常常需要相互转换。在上面分析网络模型里，select 的拉模型就转换成了 Reactor 的推模型。而操作系统内核的推模型也被装点成了拉模型的完成端口 API 供用户空间调用。&lt;/p&gt;
&lt;p&gt;拉模型转换成推模型比较容易，只需要将拉取数据的部分与处理数据的部分分开来。拉数据的部分还是使用拉模型，如 for 循环，阻塞调用等，而处理数据的部分变成回调函数，由下层的拉模型将数据推送给回调函数。下面是个简单例子：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// C++ 0x&lt;/span&gt;

&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;vector&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;cout&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;endl&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一个拉模型，程序将数据从 &lt;tt class="docutils literal"&gt;data&lt;/tt&gt; 数组中拉出，进行处理（这里只是简单的将之输出）。下面是相应的推模型版本&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// C++ 0x&lt;/span&gt;

&lt;span class="k"&gt;auto&lt;/span&gt; &lt;span class="n"&gt;printer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[](&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;cout&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;endl&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;for_each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;printer&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可见，如果要将原来的直白的拉模型转换为推模型，这里只需将处理数据的算法封装成单独的回调函数，另由一个驱动去专门遍历数据源即可。这还是相当容易的。不过，转换后的代码反而比之前的复杂了，有画蛇添足之嫌。它的好处是什么呢？拉模型转换成推模型的好处是数据与算法的分离。在拉模型中，数据的抽取与对数据应用的算法混在一个 &lt;tt class="docutils literal"&gt;for&lt;/tt&gt; 循环中，这样便很难单独复用数据抽取或数据算法这两部分。再来看看转换后的推模型，应用在数据上的算法被封装成了 &lt;tt class="docutils literal"&gt;printer&lt;/tt&gt; ，而数据的抽取也变成了独立的函数 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::for_each&lt;/span&gt;&lt;/tt&gt; ，这两者互不相干，可以独立的被复用。&lt;/p&gt;
&lt;p&gt;其实，通常有两种模式来分离数据的抽取，一种就是上面所示的方法，通过回调函数来进行分割的 Visitor 模式（不是 GoF 中复杂的那种 Visitor 模式）还有一种也在上面的代码中出现，那就是 STL 容器类普遍运用的 Iterator 模式。Iterator 模式的实现起来比 Visitor 模式要复杂的多，Boost 中甚至提供了专门的库 Boost.Iterator 来帮助人们实现一个合格的兼容 STL 的 Iterator。虽然实现复杂，但它的好处是：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Iterator 使用起来非常直观，不需要定义一个专门的回调，是一个典型的拉模型。&lt;/li&gt;
&lt;li&gt;Iterator 的拉模型可以很容易的转换成 Visitor 式的推模型。反过来则不然。&lt;/li&gt;
&lt;li&gt;Iterator 接口使用起来相当灵活。用户可以在使用时进一步的在 for 循环体内自由定义遍历方式。比如只处理偶数位的数据，或者遇到特殊值停止等。而 Visitor 模式在这方面就比较死板。它的遍历方式是固定的。只能通过回调函数的返回值来做细微的控制。所以 STL 中的算法会有很多种（for_each, find, find_if ...）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Visitor 式的推模型能转换成 Iterator 式的拉模型吗？答案是可以，但需要一个线程队列做辅助。在队列的一端，一个回调函数不断的将收到的数据再推送到线程队列中，而在队列另一端，通过 API 暴露一个读取并移除数据的阻塞调用。通过这样一个生产者消费者模型，就可以将生产者端的推模型转化成消费者端的拉模型。实际上，上面分析的 Windows 完成端口 API 正是这么做的。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;语言的支持&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;既然推与拉这么的普遍，为何不在语言层面给以直接的支持呢。实际上，确实有很多语言这么做了，比如 Python。Python 通过 &lt;tt class="docutils literal"&gt;yield&lt;/tt&gt; 关键字既可以方便的将数据推送给调用者，也可以从调用者那拉来数据。实际上 &lt;tt class="docutils literal"&gt;yield&lt;/tt&gt; 关键字只是协程（Coroutine）不完全实现, 而协程恰恰是实现推拉互动的所谓非抢占式协作的关键。不过，哪怕是不完整的实现，也让 Python 在数据推拉相关的程序上的表达力丰富了许多，以至于很多人觉得有必要在 Python 中实现完整的协程支持。当然，那又是另外一个话题了。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="c++"></category><category term="design"></category><category term="python"></category></entry><entry><title>瓜达尔港</title><link href="http://zhuoqiang.me/gwadar-port.html" rel="alternate"></link><updated>2011-05-23T00:49:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-05-23:gwadar-port.html</id><summary type="html">&lt;p&gt;曾经，俄国人赌上国运也没能拿到一个印度洋出海口。&lt;/p&gt;
&lt;p&gt;今天，巴基斯坦请求中国接收瓜达尔港。&lt;/p&gt;
&lt;iframe width="96%" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://ditu.google.com/maps/ms?ie=UTF8&amp;amp;hl=zh-CN&amp;amp;brcurrent=3,0x31508e64e5c642c1:0x951daa7c349f366f,0%3B5,0,0&amp;amp;msa=0&amp;amp;msid=203856847079115168968.0004a3ddfe6a93b884618&amp;amp;t=p&amp;amp;source=embed&amp;amp;ll=28.613459,88.59375&amp;amp;spn=70.474467,112.5&amp;amp;output=embed"&gt;&lt;/iframe&gt;&lt;p&gt;瓜达尔港作为印度洋出海口，靠阿富汗，伊朗，亚丁湾，霍尔木兹海峡都很近。港深足以停泊航母，巴基斯坦还希望中国能在此建军港。如接收此港，中国不但绕开了第一岛链的封堵，而且对欧亚大陆战略核心地带可以施加更为直接的影响力。中东能源也不必非走马六甲海峡仰人鼻息，以后还可以从印度洋经瓜达尔港上岸，走陆路直达新疆喀什。&lt;/p&gt;
&lt;p&gt;很明显，瓜达尔港带给中国的地缘战略意义非常巨大。可以想象假以时日，中国将它建成第一个海外军事基地时，那将带给中国带给世界更大的心理影响。&lt;/p&gt;
&lt;p&gt;中国从 2002 开始就帮助巴基斯坦修建瓜达尔港，而从瓜达尔到新疆的铁路公路和输油管线也一直在建设当中。我们的布局相当早，所谋者亦大。个人猜测，如果不是美国越境清除拉登带给巴基斯坦的压力，瓜达尔港的接收可能还要再遮遮掩掩一阵子。&lt;/p&gt;
&lt;p&gt;这将会是帝国的开始吗？我们都在见证历史！&lt;/p&gt;
</summary><category term="political"></category></entry><entry><title>RESTful Pyramid</title><link href="http://zhuoqiang.me/restful-pyramid.html" rel="alternate"></link><updated>2011-03-13T18:06:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-03-13:restful-pyramid.html</id><summary type="html">&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#english-version" id="id4"&gt;English Version (英文版)&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http-verb-based-route" id="id5"&gt;HTTP Verb Based Route&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http-method-override" id="id6"&gt;HTTP Method Override&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#mime-type-based-route" id="id7"&gt;MIME-Type Based Route&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#file-extension-based-route" id="id8"&gt;File Extension Based Route&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#something-about-client" id="id9"&gt;Something about Client&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#chinese-version" id="id10"&gt;中文版 (Chinese Version)&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http" id="id11"&gt;基于 HTTP 动词的分派&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id12"&gt;HTTP 方法覆盖&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#mime-type" id="id13"&gt;基于 MIME-Type 的分派&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id14"&gt;基于文件扩展名的分派&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id15"&gt;关于客户端&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="english-version"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;English Version (英文版)&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Recently python web framework &lt;tt class="docutils literal"&gt;Pylons&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;repoze.bfg&lt;/tt&gt; merged together as &lt;tt class="docutils literal"&gt;Pyramid&lt;/tt&gt; and release v 1.0 very soon.&lt;/p&gt;
&lt;p&gt;The first impression of Pyramid is that it is more a micro-framework than Pylons. And sometimes I found it too micro that it lacks some of the convenience utility such as build-in support for RESTful style serivce: there is no Pylons's &lt;tt class="docutils literal"&gt;RestController&lt;/tt&gt;&lt;/p&gt;
&lt;p&gt;Thanks to Pyramid's flexible design, it's easy to setup the RESTful route manually and here comes the cookbook.&lt;/p&gt;
&lt;div class="section" id="http-verb-based-route"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id5"&gt;HTTP Verb Based Route&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;RESTful style service requires different HTTP verbs mapping to different handlers. In Pyramid we can map different views to same route based on different &lt;tt class="docutils literal"&gt;request_method&lt;/tt&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyramid.view&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;view_config&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;GET post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="http-method-override"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id6"&gt;HTTP Method Override&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;RESTful web service take advantage of all HTTP methods, including &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt;. However sometimes HTTP clients could only send &lt;tt class="docutils literal"&gt;GET&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; requests because:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;HTML standard only supports &lt;tt class="docutils literal"&gt;GET&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; via link and form actions. Web browser just cannot send &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; without ajax support.&lt;/li&gt;
&lt;li&gt;Firewalls may block HTTP &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; request.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To get around this limitation, client has to tunnel the actual &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; request in a &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; request. The RESTful service is supposed to look for the real HTTP method embeded in the &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; request. There are 2 de facto standards for &lt;tt class="docutils literal"&gt;POST tunnel&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Embed HTTP method in a hidden input form parameter named &lt;tt class="docutils literal"&gt;_method&lt;/tt&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;POST&lt;/span&gt; &lt;span class="nn"&gt;/post/123&lt;/span&gt; &lt;span class="kr"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1.1&lt;/span&gt;
&lt;span class="na"&gt;Content-Length&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;19&lt;/span&gt;

a=1&amp;amp;_method=DELETE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is convenience when &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; from HTML form.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Embed the HTTP method in &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;X-HTTP-Method-Override&lt;/span&gt;&lt;/tt&gt; HTTP header&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;POST&lt;/span&gt; &lt;span class="nn"&gt;/post/123&lt;/span&gt; &lt;span class="kr"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1.1&lt;/span&gt;
&lt;span class="na"&gt;Content-Length&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;5&lt;/span&gt;
&lt;span class="na"&gt;X-HTTP-Method-Override&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;DELETE&lt;/span&gt;

{a:1}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is prefered when &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; with data format in JSON or XML&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To recognize these 2 HTTP override conversions a &lt;tt class="docutils literal"&gt;custom_predicates&lt;/tt&gt; is needed for looking for the real HTTP method:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;allowed_methods&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;allowed&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;Custom predict checking if the HTTP method in the allowed set.&lt;/span&gt;
&lt;span class="sd"&gt;    It also changes the request.method according to &amp;quot;_method&amp;quot; form parameter&lt;/span&gt;
&lt;span class="sd"&gt;    and &amp;quot;X-HTTP-Method-Override&amp;quot; header&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;predicate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str_POST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;X-HTTP-Method-Override&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;allowed&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;predicate&lt;/span&gt;


&lt;span class="c"&gt;# We use the allowed_methods to find the real HTTP method and do the route&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_methods&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above code will do the trick to override the HTTP method and dispatch the route to the correct view, Here's another more WSGI way doing it. A dedicate WSGI middleware could be applied here to override the HTTP method before the request ever goes to Pyramid application:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpMethodOverrideMiddleware&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;WSGI middleware for overriding HTTP Request Method for RESTful support&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;application&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;application&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;application&lt;/span&gt;


    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start_response&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
            &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;

            &lt;span class="c"&gt;# First check the &amp;quot;_method&amp;quot; form parameter&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;form-urlencoded&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;CONTENT_TYPE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
                &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;webob&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Request&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str_POST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

            &lt;span class="c"&gt;# If not found, then look for &amp;quot;X-HTTP-Method-Override&amp;quot; header&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;HTTP_X_HTTP_METHOD_OVERRIDE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;PUT&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;OPTIONS&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;PATCH&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="c"&gt;# Save the original HTTP method&lt;/span&gt;
                &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http_method_override.original_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
                &lt;span class="c"&gt;# Override HTTP method&lt;/span&gt;
                &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start_response&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The usage is simple, change &lt;tt class="docutils literal"&gt;main()&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;__init__.py&lt;/tt&gt; as the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;global_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;HttpMethodOverrideMiddleware&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;make_wsgi_app&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then you could just use the build-in &lt;tt class="docutils literal"&gt;request_method&lt;/tt&gt; since the &lt;tt class="docutils literal"&gt;request.method&lt;/tt&gt; is already been override by &lt;tt class="docutils literal"&gt;HttpMethodOverrideMiddleware&lt;/tt&gt; (Actually this is exactly what &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Rank::MethodOverride&lt;/span&gt;&lt;/tt&gt; does for Rails).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mime-type-based-route"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id7"&gt;MIME-Type Based Route&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For RESTful service, an URI could gives different representations for the same resource based on &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;MIME-types&lt;/span&gt;&lt;/tt&gt; (like &lt;tt class="docutils literal"&gt;application/xml&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;application/json&lt;/tt&gt;) in HTTP request's &lt;tt class="docutils literal"&gt;Accept&lt;/tt&gt; header. Pyramid has build-in support for this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# if MIME type is XML we use the xml template for render&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*/xml&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.xml.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c"&gt;# if MIME type is json, a json template is prefered&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*/json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.json.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="file-extension-based-route"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id8"&gt;File Extension Based Route&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Some RESTful services also use file extension of the URI to decide the right resource representation.&lt;/p&gt;
&lt;p&gt;For example, server gives data in the default HTML format on URI &lt;tt class="docutils literal"&gt;/post/123&lt;/tt&gt;. It will also returns HTML on the explicit request for &lt;tt class="docutils literal"&gt;/post/123.html&lt;/tt&gt; and only returns JSON on &lt;tt class="docutils literal"&gt;/post/123.json&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;We could let multiple routes mapping to the same view to support this schema:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_json, &amp;#39;&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nb"&gt;id&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="c"&gt;# The raw ID without &amp;quot;.&amp;quot; and &amp;quot;/&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id:[^/\.]+}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.html.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_html, request_method=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;GET&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;, renderer=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mako&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_json, request_method=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;GET&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;, renderer=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It is tedious to repeat so many routes, let's create a dedicate custom predicate instead:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;allowed&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;Custom predict checking if the the file extension&lt;/span&gt;
&lt;span class="sd"&gt;    of the request URI is in the allowed set.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;predicate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
        &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;splitext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path_extenstion&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;allowed&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;predicate&lt;/span&gt;

&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.html.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Another way is using regular expression to define a general extension pattern for the URI and dispatch the view manually in the view handle.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;r&amp;#39;/post/{id:[^/\.]+}{ext:(\.json|\.html)?}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c"&gt;#or config.add_route(&amp;#39;post&amp;#39;, r&amp;#39;/post/{id:[^/\.]+}{ext:(\.[^/]+)?}&amp;#39;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ext&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.html&amp;#39;&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c"&gt;# return HTML&lt;/span&gt;
    &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# return JSON&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyramid.httpexceptions&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HTTPNotFount&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;HTTPNotFount&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;not found the format for &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="something-about-client"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id9"&gt;Something about Client&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As said, you have to use the &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; tunnel to fire a &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; request in current web browser if javascript is disabled.&lt;/p&gt;
&lt;p&gt;The only way to perform an HTTP &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; with standard HTML is to use a &lt;tt class="docutils literal"&gt;&amp;lt;form&amp;gt;&lt;/tt&gt; tag. and you have to use one of &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;submit&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;image&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;button&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; tag to create the action trigger.&lt;/p&gt;
&lt;p&gt;I prefer &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;image&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; which gives you more control on how it looks (and lucky by default it just looks like a link):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;form&lt;/span&gt; &lt;span class="na"&gt;action=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;${request.route_url(&amp;#39;post&amp;#39;, id=id)}&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;method=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;post&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;delete&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;image&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Delete This Post!&amp;quot;&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;_method&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE&amp;quot;&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Actually, you could do better. You could fire a real &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; request if javascript is avalible through ajax IO.&lt;/p&gt;
&lt;p&gt;You can even use javascript to replace the &lt;tt class="docutils literal"&gt;form&lt;/tt&gt; tag with the &lt;tt class="docutils literal"&gt;link&lt;/tt&gt; tag dynamically:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;YUI&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="nx"&gt;use&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;node&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;io-base&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="c1"&gt;// Erase the parent node when DELETE success&lt;/span&gt;
  &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;onDeleteSuccess&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;parentNode&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="c1"&gt;// Replace form tag to a ajax IO link&lt;/span&gt;
  &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;changeToLink&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
     &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;action&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
     &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;setContent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;lt;a href=&amp;quot;#&amp;quot;&amp;gt;Delete&amp;lt;/a&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;#&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
         &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;click&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;preventDefault&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
            &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;cfg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
              &lt;span class="nx"&gt;method&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="nx"&gt;success&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(){&lt;/span&gt;&lt;span class="nx"&gt;onDeleteSuccess&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;);}&lt;/span&gt;
              &lt;span class="p"&gt;}&lt;/span&gt;
            &lt;span class="p"&gt;};&lt;/span&gt;
            &lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;io&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;cfg&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="c1"&gt;// Do the replacement&lt;/span&gt;
  &lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;all&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;form.delete&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
   &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
     &lt;span class="nx"&gt;changeToLink&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
   &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above javascript code is a demostration of progressive enhancement using YUI3. Users with javascript disabled will have the &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; function through plain HTML form. And users with javascript enabled will get a better Ajax no-refresh &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; experience.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;hr class="docutils" /&gt;
&lt;div class="section" id="chinese-version"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;中文版 (Chinese Version)&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;最近 python web 框架 Pylons 和 repoze.bfg 合并成了 Pyramid，很快就推出了 1.0 版本。&lt;/p&gt;
&lt;p&gt;对 Pyramid 的第一印象：相对 Pylons 来说，它更加简洁，有时甚至简洁到缺乏一些方便工具。比如对 RESTful 风格服务的内建支持: 你找不到原来 Pylons 中 &lt;tt class="docutils literal"&gt;RestController&lt;/tt&gt; 相对应的方法。好在 Pyramid 设计的很具弹性，手工搞定 RESTful 风格的 URI 分派也不是什么难事，下面就是实际的例子。&lt;/p&gt;
&lt;div class="section" id="http"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id11"&gt;基于 HTTP 动词的分派&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;RESTful 风格的服务需要根据不同的 HTTP 动词做不同的处理。在 Pyramid 中这很容易做到。只要在相同的 URI 上将不同的 &lt;tt class="docutils literal"&gt;request_method&lt;/tt&gt; 分派到不同的 &lt;tt class="docutils literal"&gt;view&lt;/tt&gt; 上就行了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyramid.view&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;view_config&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;GET post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id12"&gt;HTTP 方法覆盖&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;RESTful 服务充分利用每一个 HTTP 方法，包括 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt;。可有时，HTTP 客户端只能发出 &lt;tt class="docutils literal"&gt;GET&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 请求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;HTML 标准只通过链接和表单支持 &lt;tt class="docutils literal"&gt;GET&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 。在没有 Ajax 支持的网页浏览器中不能发出 &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 命令&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;有些防火墙会挡住 HTTP &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 请求&lt;/p&gt;
&lt;p&gt;要绕过这个限制，客户端需要把实际的 &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 请求通过 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 请求穿透过来。RESTful 服务则要负责在收到的 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 请求中找到原始的 HTTP 方法并还原。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;现在有两种常用的穿透方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;将 HTTP 方法放到表单中一个名为 &lt;tt class="docutils literal"&gt;_method&lt;/tt&gt; 的隐藏 &lt;tt class="docutils literal"&gt;input&lt;/tt&gt; 中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;POST&lt;/span&gt; &lt;span class="nn"&gt;/post/123&lt;/span&gt; &lt;span class="kr"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1.1&lt;/span&gt;
&lt;span class="na"&gt;Content-Length&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;19&lt;/span&gt;

a=1&amp;amp;_method=DELETE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在通过 HTML 表单进行 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 时这种方法很方便。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;将 HTTP 方法标注在名为 &amp;quot;X-HTTP-Method-Override&amp;quot; 的 HTTP header 中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;POST&lt;/span&gt; &lt;span class="nn"&gt;/post/123&lt;/span&gt; &lt;span class="kr"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1.1&lt;/span&gt;
&lt;span class="na"&gt;Content-Length&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;5&lt;/span&gt;
&lt;span class="na"&gt;X-HTTP-Method-Override&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;DELETE&lt;/span&gt;

{a:1}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当要传输 JSON 或 XML 数据时，只能用这种方式。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了识别这两种覆盖惯例，我们需要定义一个 &lt;tt class="docutils literal"&gt;custom_predicates&lt;/tt&gt; 用来在 HTTP &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 请求中查找真正的 HTTP 方法&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;allowed_methods&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;allowed&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;Custom predict checking if the HTTP method in the allowed set.&lt;/span&gt;
&lt;span class="sd"&gt;    It also changes the request.method according to &amp;quot;_method&amp;quot; form parameter&lt;/span&gt;
&lt;span class="sd"&gt;    and &amp;quot;X-HTTP-Method-Override&amp;quot; header&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;predicate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str_POST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;X-HTTP-Method-Override&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;allowed&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;predicate&lt;/span&gt;


&lt;span class="c"&gt;# We use the allowed_methods to find the real HTTP method and do the route&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_methods&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的代码能帮我们恢复 HTTP 的实际方法，并且根据实际的方法将请求分派到对应的 &lt;tt class="docutils literal"&gt;view&lt;/tt&gt; 中。不过，还有一种更加 WSGI 的方式来做这件事：我们可以使用专门的 WSGI 中间件，在请求到达 Pyramid 应用之前就把 HTTP 方法覆盖成检测到的实际方法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpMethodOverrideMiddleware&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;WSGI middleware for overriding HTTP Request Method for RESTful support&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;application&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;application&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;application&lt;/span&gt;


    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start_response&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;POST&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
            &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;

            &lt;span class="c"&gt;# First check the &amp;quot;_method&amp;quot; form parameter&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;form-urlencoded&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;CONTENT_TYPE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
                &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;webob&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Request&lt;/span&gt;
                &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str_POST&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

            &lt;span class="c"&gt;# If not found, then look for &amp;quot;X-HTTP-Method-Override&amp;quot; header&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;HTTP_X_HTTP_METHOD_OVERRIDE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;PUT&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;OPTIONS&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;PATCH&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="c"&gt;# Save the original HTTP method&lt;/span&gt;
                &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http_method_override.original_method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
                &lt;span class="c"&gt;# Override HTTP method&lt;/span&gt;
                &lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;override_method&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;application&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start_response&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用方式很简单，改动 &lt;tt class="docutils literal"&gt;__init__.py&lt;/tt&gt; 中的 &lt;tt class="docutils literal"&gt;main()&lt;/tt&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;global_config&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;HttpMethodOverrideMiddleware&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;make_wsgi_app&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;因为 &lt;tt class="docutils literal"&gt;reqeust.method&lt;/tt&gt; 已经被 &lt;tt class="docutils literal"&gt;HttpMethodOverrideMiddleware&lt;/tt&gt; 改写了（实际上这就是 Rails 中 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Rank::MethodOverride&lt;/span&gt;&lt;/tt&gt; 所做的事情），接下来只要使用自带的 &lt;tt class="docutils literal"&gt;request_method&lt;/tt&gt; 去做过滤就可以了&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;delete_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# Delete the post ...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE post &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mime-type"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id13"&gt;基于 MIME-Type 的分派&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;对于 RESTful 服务来说，一个 URI 背后对应的资源可以有不同的表现形式。在 HTTP 请求中可以通过 &lt;tt class="docutils literal"&gt;Accept&lt;/tt&gt; 头来表明客户端需要的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;MIME-Type&lt;/span&gt;&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;application/xml&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;application/json&lt;/tt&gt;)。Pyramid 对此支持的很好：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# if MIME type is XML we use the xml template for render&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*/xml&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.xml.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c"&gt;# if MIME type is json, a json template is prefered&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*/json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
             &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.json.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id14"&gt;基于文件扩展名的分派&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;一些 RESTful 服务还会利用 URI 路径的扩展名来决定客户端需要什么形式的回复。&lt;/p&gt;
&lt;p&gt;例如，当请求 &lt;tt class="docutils literal"&gt;/post/123&lt;/tt&gt; 时，服务器回复默认的 HTML 格式。当明确请求 &lt;tt class="docutils literal"&gt;/post/123.html&lt;/tt&gt; 时，仍然回复 HTML 格式。当请求 &lt;tt class="docutils literal"&gt;post/123.json&lt;/tt&gt; 时就会回复 JSON 格式的数据。我们可以通过定义多个 &lt;tt class="docutils literal"&gt;route&lt;/tt&gt; 来映射到同一个 &lt;tt class="docutils literal"&gt;view&lt;/tt&gt; 支持这样的模式：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_json, &amp;#39;&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nb"&gt;id&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="c"&gt;# The raw ID without &amp;quot;.&amp;quot; and &amp;quot;/&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id:[^/\.]+}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.html.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_html, request_method=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;GET&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;, renderer=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;html&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mako&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post_json, request_method=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;GET&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;, renderer=&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种做法的缺点是定义的 &lt;tt class="docutils literal"&gt;route&lt;/tt&gt; 太多，让我们自定义一个 &lt;tt class="docutils literal"&gt;predicate&lt;/tt&gt; 来代替：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;allowed&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;Custom predict checking if the the file extension&lt;/span&gt;
&lt;span class="sd"&gt;    of the request URI is in the allowed set.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;predicate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
        &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;splitext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path_extenstion&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;allowed&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;predicate&lt;/span&gt;

&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;post/{id}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post.html.mako&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;renderer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;custom_predicates&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;allowed_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),))&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;post_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;另一种方法是使用正则表达式定义 URI 中扩展名的通用格式，然后在 view 的代码中手工做分发：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;r&amp;#39;/post/{id:[^/\.]+}{ext:(\.json|\.html)?}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c"&gt;#or config.add_route(&amp;#39;post&amp;#39;, r&amp;#39;/post/{id:[^/\.]+}{ext:(\.[^/]+)?}&amp;#39;)&lt;/span&gt;

&lt;span class="nd"&gt;@view_config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;route_name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;post&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;request_method&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;show_post_view&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matchdict&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ext&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.html&amp;#39;&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c"&gt;# return HTML&lt;/span&gt;
    &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;.json&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# return JSON&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyramid.httpexceptions&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HTTPNotFount&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;HTTPNotFount&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;not found the format for &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;ext&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#id15"&gt;关于客户端&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;如前述，如果禁止 javascript 的话，在浏览器里你只能使用 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 来伪装一个 &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 的请求。&lt;/p&gt;
&lt;p&gt;在标准 HTML 中，只能通过 &lt;tt class="docutils literal"&gt;&amp;lt;form&amp;gt;&lt;/tt&gt; 标签来发送一个 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 请求。而且，你还必须使用一个 &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;submit&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;image&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;button&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt; 标签。个人喜欢使用 &lt;tt class="docutils literal"&gt;&amp;lt;input &lt;span class="pre"&gt;type=&amp;quot;image&amp;quot;&amp;gt;&lt;/span&gt;&lt;/tt&gt;, 这样可以更好地控制外观 （而且它默认也长的象普通的链接）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;form&lt;/span&gt; &lt;span class="na"&gt;action=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;${request.route_url(&amp;#39;post&amp;#39;, id=id)}&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;method=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;post&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;delete&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;image&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Delete This Post!&amp;quot;&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;_method&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;DELETE&amp;quot;&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;实际上，还能做的更好。如果支持 javascript 的话，你可以使用 Ajax IO 动作直接发送一个真正的 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 请求。你甚至可以使用 javascript 动态的用 &lt;tt class="docutils literal"&gt;link&lt;/tt&gt; 标签替换掉原来的 &lt;tt class="docutils literal"&gt;form&lt;/tt&gt; 标签：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;YUI&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="nx"&gt;use&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;node&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;io-base&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="c1"&gt;// Erase the parent node when DELETE success&lt;/span&gt;
  &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;onDeleteSuccess&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;parentNode&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="c1"&gt;// Replace form tag to a ajax IO link&lt;/span&gt;
  &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;changeToLink&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
     &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;action&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
     &lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;setContent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;lt;a href=&amp;quot;#&amp;quot;&amp;gt;Delete&amp;lt;/a&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;#&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
         &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;click&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;e&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;preventDefault&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
            &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;cfg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
              &lt;span class="nx"&gt;method&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;DELETE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="nx"&gt;success&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(){&lt;/span&gt;&lt;span class="nx"&gt;onDeleteSuccess&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;);}&lt;/span&gt;
              &lt;span class="p"&gt;}&lt;/span&gt;
            &lt;span class="p"&gt;};&lt;/span&gt;
            &lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;io&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;cfg&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="c1"&gt;// Do the replacement&lt;/span&gt;
  &lt;span class="nx"&gt;Y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;all&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;form.delete&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
   &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
     &lt;span class="nx"&gt;changeToLink&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;node&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
   &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面这段 javascript 代码就演示了使用 YUI3 怎样达到渐进增强。当 javascript 关闭时，用户可以通过普通的 HTML form 来使用 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 。当 javascript 打开后，用户将能透过 Ajax 体验到无刷新的 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 效果。&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</summary><category term="english"></category><category term="javascript"></category><category term="python"></category><category term="web"></category></entry><entry><title>python 线程，GIL 和 ctypes</title><link href="http://zhuoqiang.me/python-thread-gil-and-ctypes.html" rel="alternate"></link><updated>2011-01-10T02:21:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-01-10:python-thread-gil-and-ctypes.html</id><summary type="html">&lt;div class="section" id="gil-python"&gt;
&lt;h2&gt;GIL 与 Python 线程的纠葛&lt;/h2&gt;
&lt;p&gt;GIL 是什么东西？它对我们的 python 程序会产生什么样的影响？我们先来看一个问题。运行下面这段 python 程序，CPU 占用率是多少？&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# 请勿在工作中模仿，危险:)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;

&lt;span class="n"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;答案是什么呢，占用 100％ CPU？那是单核！还得是没有超线程的古董 CPU。在我的双核 CPU 上，这个死循环只会吃掉我一个核的工作负荷，也就是只占用 50％ CPU。那如何能让它在双核机器上占用 100％ 的 CPU 呢？答案很容易想到，用两个线程就行了，线程不正是并发分享 CPU 运算资源的吗。可惜答案虽然对了，但做起来可没那么简单。下面的程序在主线程之外又起了一个死循环的线程&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;threading&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;

&lt;span class="c"&gt;# 新起一个死循环线程&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;threading&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c"&gt;# 主线程也进入死循环&lt;/span&gt;
&lt;span class="n"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;按道理它应该能做到占用两个核的 CPU 资源，可是实际运行情况却是没有什么改变，还是只占了 50％ CPU 不到。这又是为什么呢？难道 python 线程不是操作系统的原生线程？打开 system monitor 一探究竟，这个占了 50% 的 python 进程确实是有两个线程在跑。那这两个死循环的线程为何不能占满双核 CPU 资源呢？其实幕后的黑手就是 GIL。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="gil"&gt;
&lt;h2&gt;GIL 的迷思：痛并快乐着&lt;/h2&gt;
&lt;p&gt;GIL 的全程为 &lt;a class="reference external" href="http://en.wikipedia.org/wiki/Global_Interpreter_Lock"&gt;Global Interpreter Lock&lt;/a&gt; ，意即全局解释器锁。在 Python 语言的主流实现 CPython 中，GIL 是一个货真价实的全局线程锁，在解释器解释执行任何 Python 代码时，都需要先获得这把锁才行，在遇到 I/O 操作时会释放这把锁。如果是纯计算的程序，没有 I/O 操作，解释器会每隔 100 次操作就释放这把锁，让别的线程有机会执行（这个次数可以通过 &lt;tt class="docutils literal"&gt;sys.setcheckinterval&lt;/tt&gt; 来调整）。所以虽然 CPython 的线程库直接封装操作系统的原生线程，但 CPython 进程做为一个整体，同一时间只会有一个获得了 GIL 的线程在跑，其它的线程都处于等待状态等着 GIL 的释放。这也就解释了我们上面的实验结果：虽然有两个死循环的线程，而且有两个物理 CPU 内核，但因为 GIL 的限制，两个线程只是做着分时切换，总的 CPU 占用率还略低于 50％。&lt;/p&gt;
&lt;p&gt;看起来 python 很不给力啊。GIL 直接导致 CPython 不能利用物理多核的性能加速运算。那为什么会有这样的设计呢？我猜想应该还是历史遗留问题。多核 CPU 在 1990 年代还属于类科幻，Guido van Rossum 在创造 python 的时候，也想不到他的语言有一天会被用到很可能 1000＋ 个核的 CPU 上面，一个全局锁搞定多线程安全在那个时代应该是最简单经济的设计了。简单而又能满足需求，那就是合适的设计（对设计来说，应该只有合适与否，而没有好与不好）。怪只怪硬件的发展实在太快了，摩尔定律给软件业的红利这么快就要到头了。短短 20 年不到，代码工人就不能指望仅仅靠升级 CPU 就能让老软件跑的更快了。在多核时代，编程的免费午餐没有了。如果程序不能用并发挤干每个核的运算性能，那就意谓着会被淘汰。对软件如此，对语言也是一样。那 Python 的对策呢？&lt;/p&gt;
&lt;p&gt;Python 的应对很简单，以不变应万变。在最新的 python 3 中依然有 GIL。之所以不去掉，原因嘛，不外以下几点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;欲练神功，挥刀自宫：&lt;/p&gt;
&lt;p&gt;CPython 的 GIL 本意是用来保护所有全局的解释器和环境状态变量的。如果去掉 GIL，就需要多个更细粒度的锁对解释器的众多全局状态进行保护。或者采用 Lock-Free 算法。无论哪一种，要做到多线程安全都会比单使用 GIL 一个锁要难的多。而且改动的对象还是有 20 年历史的 CPython 代码树，更不论有这么多第三方的扩展也在依赖 GIL。对 Python 社区来说，这不异于挥刀自宫，重新来过。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;就算自宫，也未必成功：&lt;/p&gt;
&lt;p&gt;有位牛人曾经做了一个验证用的 CPython，将 GIL 去掉，加入了更多的细粒度锁。但是经过实际的测试，对单线程程序来说，这个版本有很大的性能下降，只有在利用的物理 CPU 超过一定数目后，才会比 GIL 版本的性能好。这也难怪。单线程本来就不需要什么锁。单就锁管理本身来说，锁 GIL 这个粗粒度的锁肯定比管理众多细粒度的锁要快的多。而现在绝大部分的 python 程序都是单线程的。再者，从需求来说，使用 python 绝不是因为看中它的运算性能。就算能利用多核，它的性能也不可能和 C/C++ 比肩。费了大力气把 GIL 拿掉，反而让大部分的程序都变慢了，这不是南辕北辙吗。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;难道 Python 这么优秀的语言真的仅仅因为改动困难和意义不大就放弃多核时代了吗？其实，不做改动最最重要的原因还在于：不用自宫，也一样能成功！&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;其它神功&lt;/h2&gt;
&lt;p&gt;那除了切掉 GIL 外，果然还有方法让 Python 在多核时代活的滋润？让我们回到本文最初的那个问题：如何能让这个死循环的 Python 脚本在双核机器上占用 100％ 的 CPU？其实最简单的答案应该是：运行两个 python 死循环的程序！也就是说，用两个分别占满一个 CPU 内核的 python 进程来做到。确实，多进程也是利用多个 CPU 的好方法。只是进程间内存地址空间独立，互相协同通信要比多线程麻烦很多。有感于此，Python 在 2.6 里新引入了 &lt;tt class="docutils literal"&gt;multiprocessing&lt;/tt&gt; 这个多进程标准库，让多进程的 python 程序编写简化到类似多线程的程度，大大减轻了 GIL 带来的不能利用多核的尴尬。&lt;/p&gt;
&lt;p&gt;这还只是一个方法，如果不想用多进程这样重量级的解决方案，还有个更彻底的方案，放弃 Python，改用 C/C++。当然，你也不用做的这么绝，只需要把关键部分用 C/C++ 写成 Python 扩展，其它部分还是用 Python 来写，让 Python 的归 Python，C 的归 C。一般计算密集性的程序都会用 C 代码编写并通过扩展的方式集成到 Python 脚本里（如 NumPy 模块）。在扩展里就完全可以用 C 创建原生线程，而且不用锁 GIL，充分利用 CPU 的计算资源了。不过，写 Python 扩展总是让人觉得很复杂。好在 Python 还有另一种与 C 模块进行互通的机制 : ctypes&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ctypes-gil"&gt;
&lt;h2&gt;利用 ctypes 绕过 GIL&lt;/h2&gt;
&lt;p&gt;ctypes 与 Python 扩展不同，它可以让 Python 直接调用任意的 C 动态库的导出函数。你所要做的只是用 ctypes 写些 python 代码即可。最酷的是，ctypes 会在调用 C 函数前释放 GIL。所以，我们可以通过 ctypes 和 C 动态库来让 python 充分利用物理内核的计算能力。让我们来实际验证一下，这次我们用 C 写一个死循环函数&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;extern&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;C&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;DeadLoop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用上面的 C 代码编译生成动态库 &lt;tt class="docutils literal"&gt;libdead_loop.so&lt;/tt&gt; （Windows 上是 &lt;tt class="docutils literal"&gt;dead_loop.dll&lt;/tt&gt;）&lt;/p&gt;
&lt;p&gt;，接着就要利用 ctypes 来在 python 里 load 这个动态库，分别在主线程和新建线程里调用其中的 &lt;tt class="docutils literal"&gt;DeadLoop&lt;/tt&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ctypes&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;threading&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;

&lt;span class="n"&gt;lib&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cdll&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LoadLibrary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;libdead_loop.so&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeadLoop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DeadLoop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这回再看看 system monitor，Python 解释器进程有两个线程在跑，而且双核 CPU 全被占满了，ctypes 确实很给力！需要提醒的是，GIL 是被 ctypes 在调用 C 函数前释放的。但是 Python 解释器还是会在执行任意一段 Python 代码时锁 GIL 的。如果你使用 Python 的代码做为 C 函数的 callback，那么只要 Python 的 callback 方法被执行时，GIL 还是会跳出来的。比如下面的例子：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;extern&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;C&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="k"&gt;typedef&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Callback&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
  &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;Call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
  &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ctypes&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;threading&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;

&lt;span class="n"&gt;lib&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cdll&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LoadLibrary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;libcall.so&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Callback&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CFUNCTYPE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;callback&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dead_loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Call&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,))&lt;/span&gt;
&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;lib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注意这里与上个例子的不同之处，这次的死循环是发生在 Python 代码里 (&lt;tt class="docutils literal"&gt;DeadLoop&lt;/tt&gt; 函数) 而 C 代码只是负责去调用这个 callback 而已。运行这个例子，你会发现 CPU 占用率还是只有 50％ 不到。GIL 又起作用了。&lt;/p&gt;
&lt;p&gt;其实，从上面的例子，我们还能看出 ctypes 的一个应用，那就是用 Python 写自动化测试用例，通过 ctypes 直接调用 C 模块的接口来对这个模块进行黑盒测试，哪怕是有关该模块 C 接口的多线程安全方面的测试，ctypes 也一样能做到。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;虽然 CPython 的线程库封装了操作系统的原生线程，但却因为 GIL 的存在导致多线程不能利用多个 CPU 内核的计算能力。好在现在 Python 有了易经筋（multiprocessing）, 吸星大法（C 语言扩展机制）和独孤九剑（ctypes），足以应付多核时代的挑战，GIL 切还是不切已经不重要了，不是吗。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="concurrent"></category><category term="python"></category></entry><entry><title>C++ 不给力之不可继承</title><link href="http://zhuoqiang.me/ungelivable-cpp-those-who-cannot-inherit.html" rel="alternate"></link><updated>2011-01-05T00:25:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2011-01-05:ungelivable-cpp-those-who-cannot-inherit.html</id><summary type="html">&lt;p&gt;C++ 给人的印象通常是特性众多，使用复杂，性能突出。当然，它也有不怎么给力的时候。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id6"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id7"&gt;答案&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id8"&gt;名字隐藏&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id9"&gt;非依赖名字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id10"&gt;总结&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;问题&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;C++ 中有没有不能被子类继承的父类成员？（私有成员除外）&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;答案&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;有。而且至少有两种情况：名字隐藏和非依赖名字&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;名字隐藏&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;C++ 中针对子类跟父类同名的成员函数，分为两种情况处理&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;同名函数的参数签名也相同，就覆盖（override）&lt;/li&gt;
&lt;li&gt;虽然成员函数名字相同但参数签名不同，那么不管该方法是否为虚函数，父类的同名函数都被隐藏了（hide）。被隐藏起来的父类方法默认是不被继承的：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;123&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// Error, there is no Foo(int)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的代码会引发编译错误。原因就是 &lt;tt class="docutils literal"&gt;int &lt;span class="pre"&gt;Base::Foo(int)&lt;/span&gt;&lt;/tt&gt; 没有被 &lt;tt class="docutils literal"&gt;Derived&lt;/tt&gt; 继承。&lt;/p&gt;
&lt;p&gt;如果要使用父类里被隐藏的方法，需要加入显示的限定符：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="c1"&gt;// derived.Foo(123); // Error, there is no Foo(int)&lt;/span&gt;
&lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;123&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;// Use explicit scope qualifier&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样虽然可以编译，但使用太麻烦。还有一个解是在子类中显示声明使用父类的同名函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="c1"&gt;// Bring Base::Foo to this Scope&lt;/span&gt;

    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;123&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// OK. called Base::Foo&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;看起来只要使用 &lt;tt class="docutils literal"&gt;using&lt;/tt&gt; 把父类同名函数显示引入就可以了，问题解决了！但如果再想一想，就会发现新的问题：为什么要让使用者多写一个 &lt;tt class="docutils literal"&gt;using&lt;/tt&gt; ？ 为什么要引入隐藏机制？为什么不是默认把同名的父类方法继承过来？ 一句话，为什么 C++ 被设计成这样？要回答这些问题，先得说明白 C++ 众多的功能中的 3 个：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;强类型：编译器会在编译期检查参数类型，不允许类型不匹配的调用。这是对 C 语言的一个重大改进。强类型检查使得大部分错误在编译期就被发现&lt;/li&gt;
&lt;li&gt;函数重载：同名函数可以有不同的定义。编译器会根据调用方的入参类型来选择一个合适的函数实现。它简化了编程，也是最基本的一种多态方式（同一个名字在不同上下文中对应不同的东西）&lt;/li&gt;
&lt;li&gt;隐式类型转换：在调用函数时，如果形参和实参类型不一制，C++ 会先尝试将实参类型转换成形参类型再调用。它主要作用是为了兼容 C 语言。没有隐式类型转换，大部份的 C 代码就不可能不经修改就通过 C++ 的编译&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这三个功能互相配合互相影响。函数重载是以强类型检查为基础的，没有强类型检查，编译器就不能根据形参类型区分同名函数。而隐式类型转换却跟强类型是一对矛盾。这三个功能加在一起会产生什么问题呢？来看下面的程序&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3u&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的程序先用隐式类型转换将 &lt;tt class="docutils literal"&gt;3u&lt;/tt&gt; （类型为 &lt;tt class="docutils literal"&gt;unsigned int&lt;/tt&gt; ）转换成 &lt;tt class="docutils literal"&gt;3&lt;/tt&gt; （类型为 &lt;tt class="docutils literal"&gt;signed int&lt;/tt&gt; ）然后再调用到 &lt;tt class="docutils literal"&gt;void Foo(int n)&lt;/tt&gt; ，没有任何问题。但如果某天加入了另外一个函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// Just Added&lt;/span&gt;
&lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3u&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这下强类型和重载判断会认定 &lt;tt class="docutils literal"&gt;void Foo(unsigned int n)&lt;/tt&gt; 是比 &lt;tt class="docutils literal"&gt;void Foo(int n)&lt;/tt&gt; 更优的一个选择，于是调用新加入的这个函数。到现在为止都还好。但如果把类和继承加入进来呢？同名但签名不同的父类和子类方法不正是属于一个重载集合吗。如果默认父类的同名方法属于子类的重载集合会发生什么事呢？&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="n"&gt;Derived&lt;/span&gt; &lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这段代码工作的很好，可是，某天，第三方的 Base 类有了一个升级：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;Base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;runtime_error&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;原来正常工作的代码，这时候就抛出了异常（不用惊讶， &lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt; 更加匹配 &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; 类型而不是 &lt;tt class="docutils literal"&gt;void*&lt;/tt&gt; ，可恶的 C, 可爱的 &lt;tt class="docutils literal"&gt;nullptr&lt;/tt&gt; ）。只是父类中增加了一个同名的重载方法，所有原来使用子类中同名方法的代码都受到了影响。而且，这个父类和子类并不要求直接继承。也就是说，不管离你多远的父类中的一个同名方法的增删，都会影响子类代码的使用，这实在是危险！这个危险就是上面列出来的强类型，函数重载，隐式类型转换三个功能在继承时带给我们的。可这三个功能都不能去掉，那怎么办？C++ 之父给了个折中：把父类的同名函数加入子类的重载集确实很危险，所以 C++ 不会这么做，除非用户显示的要求这么做（ &lt;tt class="docutils literal"&gt;using &lt;span class="pre"&gt;Base::Foo&lt;/span&gt;&lt;/tt&gt; ）。这应该就是故事的来龙去脉了。可以说，Ｃ++ 为了保持和 C 语言的兼容性（隐式类型转换就是 C 兼容性的要求），让语言的复杂性大大增加。但与 C 兼容也是 C++ 成功的基石。真是成也是 C 败也是 C 。我仿佛看见了 C++ 之父无可奈何的表情。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;非依赖名字&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;另一个不能继承的情景是和非依赖名字（non-dependent name）相关的，下面的代码编译会出错：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;TBase&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;template&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;TDerived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// Error&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="n"&gt;TDerived&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Base&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;derived&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里， &lt;tt class="docutils literal"&gt;Foo&lt;/tt&gt; 虽然是 &lt;tt class="docutils literal"&gt;TDerived&amp;lt;Base&amp;gt;&lt;/tt&gt; 的方法，但却会引发编译错误。原因是 C++ 在引入模板时，为了要尽可能早的发现代码错误，将模板代码分为依赖名字和非依赖名字。编译器会执行二阶段查找（２ phase lookup）。所谓的依赖名字，就是所有跟模板参数类型有关的名字。非依赖名字是跟模板参数类型无关的名字。在第一阶段查找时，编译器会检查所有跟参数类型无关的名字，这时如果发现错误，就不用等模板被实例化（通常这会比较耗费资源）就给出诊断信息了。而所有依赖名字必须要等到模板实例化时，有了具体的类型才能进行检查。在我们上面的例子里， &lt;tt class="docutils literal"&gt;Foo&lt;/tt&gt; 这个名字是非依赖名字，它不依赖于模板参数 &lt;tt class="docutils literal"&gt;T&lt;/tt&gt; ，于是在模板实例化之前就被检查了。而在这个时候，编译器没有发现 &lt;tt class="docutils literal"&gt;TDerived&lt;/tt&gt; 有任何 &lt;tt class="docutils literal"&gt;Foo&lt;/tt&gt; 的定义，于是报错。如果要修正这个问题，只要将 &lt;tt class="docutils literal"&gt;Foo&lt;/tt&gt; 改为依赖名字就行了&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;TDerived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;或者:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;TDerived&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;Bar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这两种改法都将 &lt;tt class="docutils literal"&gt;Foo&lt;/tt&gt; 变成了依赖名字，会在 &lt;tt class="docutils literal"&gt;TDerived&amp;lt;Base&amp;gt;&lt;/tt&gt; 实例化时才进行检查，这时 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Base::Foo&lt;/span&gt;&lt;/tt&gt; 就能被编译器找到了。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;总结&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;C++ 恐怕是最复杂的编程语言了，没有之一。这些复杂性很大一部分来源于 C 语言的包袱。除了这里列出来的两种情况，我相信肯定还能找出不能被继承的情况，甚至用这些偶然发现的技巧去实现让一个不能被继承类（所谓的 &lt;tt class="docutils literal"&gt;final&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;sealed&lt;/tt&gt; 类）也不是没有可能。这恐怕也算得 C++ 的魅力之一了。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="c++"></category><category term="design"></category></entry><entry><title>在 C++ 中输出字符串的十六进制表示</title><link href="http://zhuoqiang.me/string-hex-format-output-in-cpp.html" rel="alternate"></link><updated>2010-12-12T23:45:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-12-12:string-hex-format-output-in-cpp.html</id><summary type="html">&lt;p&gt;在进行 i18n 相关的开发时，经常遇到字符编码转换的错误。这时如果能把相关字符串用十六进制的形式打印出来，例如，&lt;tt class="docutils literal"&gt;&amp;quot;abc&amp;quot;&lt;/tt&gt; 输出成 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;&amp;quot;\\x61\\x62\\x63&amp;quot;&lt;/span&gt;&lt;/tt&gt; 这对于 i18n 的除错来说是很有帮助的。Python 里面，只需要使用 &lt;tt class="docutils literal"&gt;repr()&lt;/tt&gt; 函数就行了。可在 C++ 中如何做到这点呢？下面是用 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 的格式化功能的一个简单的实现：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;get_raw_string&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ostringstream&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;const_iterator&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;看上去简单直接，但很可惜这段代码不能实现我们的意图。它还是按字面输出了每个字符。可我们明明指定了使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::hex&lt;/span&gt;&lt;/tt&gt; 来格式化输出啊！？问题原来是出在 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::hex&lt;/span&gt;&lt;/tt&gt; 只是一个针对整数类型的输出格式设置，当输出字符类型时，C++ 流还是按照字面输出。到 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 的文档去细查才知，原来 C++ 标准输出流对于格式化输出的控制很弱，只能提供有限的几种格式定制，而且大部分都是针对整数和浮点数类型的，对于字符类型完全没有参数可以控制。有点讽刺的是， &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 利用了 C++ 的函数重载和强类型机制做到了在表达力不输于 C 的同时，又杜绝了臭名昭著的 &lt;tt class="docutils literal"&gt;printf&lt;/tt&gt; 带来的无穷的麻烦，大大增加了安全。可在这里，强类型安全反而是我们达到目的的障碍：我就是想让 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 把字符当成整数打印啊！还好，C++ 还有类型强转这招可以让我们绕过强类型匹配这道安全闸门：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;hex&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="k"&gt;static_cast&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;好了，这下字符都按整数来输出了，而 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::hex&lt;/span&gt;&lt;/tt&gt; 又指示 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 用十六进制表示去输出整数。问题解决了。且慢，为什么输出 UTF-8 中文编码的时候会变成这样：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\xffff&lt;/span&gt;&lt;span class="s"&gt;ffe4&lt;/span&gt;&lt;span class="se"&gt;\xffff&lt;/span&gt;&lt;span class="s"&gt;ffb8&lt;/span&gt;&lt;span class="se"&gt;\xffff&lt;/span&gt;&lt;span class="s"&gt;ffad&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;// get_raw_string(&amp;quot;中&amp;quot;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这么多的 &lt;tt class="docutils literal"&gt;F&lt;/tt&gt; word 太影响市容了。能不能把它们去掉？其实原因在于，我们输出的是强制类型转换成 &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; 的整形数值，而 &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; 是 32 bit 长，所以会多出前面这么多位来。如果要去掉，只要转成 8 bit 的整数不就行了吗。可惜 C/C++ 中没有 8 bit 的整数，你唯一能做到的是&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;typedef&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="kt"&gt;int8_t&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可是用这样得来的 &lt;tt class="docutils literal"&gt;int8_t&lt;/tt&gt; 去转也还是不行，因为在 C++ 中，&lt;tt class="docutils literal"&gt;typedef&lt;/tt&gt; 并没有产生一个新的类型，而只是定义了一个原来类型的别名。而这个别名是不参与到函数重载的匹配计算当中的。换言之，&lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 说了，别以为你披上件 &lt;tt class="docutils literal"&gt;int8_t&lt;/tt&gt; 的马甲我就不认识你了，我还是把你当 &lt;tt class="docutils literal"&gt;char&lt;/tt&gt; 来输出。此路不通！&lt;/p&gt;
&lt;p&gt;那我们就放弃利用 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 了吗？且慢，其实 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 默认是不会输出前面的 0 的，那只要把最后 8 bit 之前的位都抹成 0 不就能达到我们的要求了吗。好了，下面就是无错最终版：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;get_raw_string&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ostringstream&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;const_iterator&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="c1"&gt;// AND 0xFF will remove the leading &amp;quot;ff&amp;quot; in the output,&lt;/span&gt;
        &lt;span class="c1"&gt;// So that we could get &amp;quot;\xab&amp;quot; instead of &amp;quot;\xffab&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;static_cast&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;short&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="mh"&gt;0xff&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;out&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;经历了几番波折，终于成功利用了 ostream 提供的十六进制输出的功能实现了打印字符串十六进制的功能。其实细究起来，之所以那么绕，还是因为 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 本身在格式化输出控制方面太弱了。进一步的，C++ 里还有更好的工具做这件事吗？ &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::format&lt;/span&gt;&lt;/tt&gt; 看起来象是，但它依然不能正确处理我们上面遇到的两难境地。好在，另一个 boost 库给出了合适的答案: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::spirit::karma&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;
&lt;p&gt;Karma 是 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::spirit&lt;/span&gt;&lt;/tt&gt; 库的一部分。大家可能比较熟悉的是用 spirit 库做 parser 来解析字符串。而 spirit 通过 Karma 提供的功能就恰好相反，它是专门用来将 C++ 数据结构格式化为字符流的。我们恰好就需要它，下面就是用 karma 库重写的代码：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;typename&lt;/span&gt; &lt;span class="n"&gt;OutputIterator&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="kt"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;generate_raw&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;OutputIterator&lt;/span&gt; &lt;span class="n"&gt;sink&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;spirit&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;karma&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;spirit&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;karma&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;generate&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;generate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sink&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;get_raw_string_k&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;generate_raw&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;back_inserter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;runtime_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;parse error&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里面最主要就是利用了 karma 内置的一个输出模块 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;karam::hex&lt;/span&gt;&lt;/tt&gt; 来帮我们完成工作，而这个 &lt;tt class="docutils literal"&gt;hex&lt;/tt&gt; 是一个多态的生成器。它不象 &lt;tt class="docutils literal"&gt;ostream&lt;/tt&gt; 的类型重载，只能针对某些类型输出 hex 格式，而是针对所有类型都能输出 hex 格式，包括 &lt;tt class="docutils literal"&gt;char&lt;/tt&gt; 。还有一个优点，代码的表达力更强了，输出的格式完全在一行代码中体现：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// 输出格式为 &amp;quot;\x61\x62\x63&amp;quot;，方便直接贴到 python 或 C++ 的代码中&lt;/span&gt;
&lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果想要改变输出格式，只需要改这行代码即可，例如：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// 输出格式变为 &amp;quot;0x61 0x62 0x63 &amp;quot;&lt;/span&gt;
&lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;0x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;hex&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;\&amp;quot;&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;那么效率方面有没有任何性能损失呢？下面是一段测试代码，分别用两种算法转换相同的字符串:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;#include &amp;quot;boost/test/unit_test.hpp&amp;quot;&lt;/span&gt;
&lt;span class="cp"&gt;#include &amp;quot;boost/../libs/spirit/optimization/measure.hpp&amp;quot;&lt;/span&gt;
&lt;span class="cp"&gt;#include &amp;quot;string.hpp&amp;quot; &lt;/span&gt;&lt;span class="c1"&gt;// The function for test&lt;/span&gt;

&lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;hex output performance test data 中文&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;using_karma&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;benchmark&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;val&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;get_raw_string_c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;using_ostream&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;base&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;benchmark&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;val&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;get_raw_string&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="n"&gt;BOOST_AUTO_TEST_CASE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;TestStringPerformance&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;BOOST_SPIRIT_TEST_BENCHMARK&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;using_karma&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;using_ostream&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;);&lt;/span&gt;

    &lt;span class="n"&gt;BOOST_CHECK_NE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;live_code&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;下面是运行的结果，分别是两种算法需要的时间，值越小越好：&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="50%" /&gt;
&lt;col width="50%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;算法&lt;/th&gt;
&lt;th class="head"&gt;耗时(s)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;karma&lt;/td&gt;
&lt;td&gt;6.97&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;ostream&lt;/td&gt;
&lt;td&gt;14.24&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;可能出乎意料，大致来说 karma 比 ostream 快了一倍。这也与 spirit 官方给出的性能数据差不多。这里的函数返回值是通过 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::string&lt;/span&gt;&lt;/tt&gt; 值拷贝返回的，消耗了不少时间，如果纯从格式化输出来说，猜测 karma 的性能优势只会更大。&lt;a class="reference external" href="http://tinodidriksen.com/2010/02/07/cpp-convert-int-to-string-speed/"&gt;另一份测试&lt;/a&gt; 表明，karma 应该是 C/C++ 里面你能找到的速度最快的格式化字符流方案了。&lt;/p&gt;
&lt;p&gt;对于这么简单的功能来说，这篇文章已经显得太长了，庆幸的是，我们最终还是找到了一个表达力强，性能高的十六进制输出方案。人说好事难双，可 C++ 这门复杂的语言，却经常能找执行飞快又高度抽象的代码方案。只是有些过于复杂了 ...&lt;/p&gt;
</summary><category term="boost"></category><category term="c++"></category><category term="i18n"></category><category term="performance"></category><category term="spirit"></category></entry><entry><title>博客搬家</title><link href="http://zhuoqiang.me/blog-move.html" rel="alternate"></link><updated>2010-08-22T16:44:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-08-22:blog-move.html</id><summary type="html">&lt;p&gt;博客搬家拉！&lt;a class="reference external" href="http://blog.zhuoqiang.me"&gt;原来的域名&lt;/a&gt;绑定的是&lt;a class="reference external" href="http://72pines.com/"&gt;七十二松&lt;/a&gt;的博客服务，还会再保留一段时间，但不会更新了， 新博客域名为 &lt;a class="reference external" href="http://zhuoqiang.me"&gt;zhuoqiang.me&lt;/a&gt; 。我已经将所有老文章导入，这还得要谢谢七十二松导出全部文章和评论功能，非常的人性化。&lt;/p&gt;
&lt;p&gt;对七十二松的博客服务还是很满意的。毕竟对一个博客服务提供商来说，能免费提供稳定的空间，绑定域名，预设多种主题和插件，自由的导入导出，而且还没有广告，作为用户还能有什么奢求呢。只是，随着博客越写越多，越需要对博客的各方面做出修改和定制，七十二松平台的限制也越发明显：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;提供的主题有限，而且不能修改&lt;/li&gt;
&lt;li&gt;预设的插件偏少，不允许自行安装和修改插件。不能满足我对 Lisp 语言语法高亮的支持，也不支持直接在文章里嵌入 &lt;a class="reference external" href="http://zhuoqiang.me/make-raphael-path-draggable.html"&gt;Javascript 运行示例&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我的空间我做主，在 &lt;a class="reference external" href="http://ahei.info/blog-reborn.htm"&gt;ahei&lt;/a&gt; 的建议下，我也终于掏银子买空间架了一个独立的 WordPress 博客。自由虽然不免费（Freedom is not Free），但也贵不到哪里， &lt;a class="reference external" href="http://hugege.com/2010/08/13/42th-host/"&gt;胡戈戈&lt;/a&gt; 提供的 100 元一年的新手型空间对我的小博客来说已经足够了。再绑定上之前 GoDaddy 上 $9 买的的一级域名 &lt;tt class="docutils literal"&gt;zhuoqiang.me&lt;/tt&gt; ，一共才 200 元不到。这点小小的投资也算是个鞭策吧，希望今后能坚持记录自己的所学所思，别让这钱打了水漂。&lt;/p&gt;
&lt;p&gt;当然，能力越大担子也越重，周末两天就尽是折腾新的 WordPress 的主题和插件了，等折腾完了再来更新。&lt;/p&gt;
</summary><category term="blog"></category></entry><entry><title>折腾 Emacs</title><link href="http://zhuoqiang.me/torture-emacs.html" rel="alternate"></link><updated>2010-08-15T05:38:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-08-15:torture-emacs.html</id><summary type="html">&lt;p&gt;传说中神一样编辑器的 Emacs 向来以难学难用，喜欢折腾人著称。三天打渔两天晒网的我，居然心甘情愿地被它折腾了五，六年之久，期间苦乐不足为外人道也。不过以我的使用感觉，Emacs 更象是匹烈马：初时难以驾驭，可一旦征服，使用起来便得心应手，威力无穷。尽管被它折腾的不轻，但也因此学会了很多提高工作效率的小技巧。而在用 Emacs 编辑时更是可以做到心无旁骛，任由思路驰骋纵横在键盘间，达到一种“流”的状态。&lt;/p&gt;
&lt;p&gt;虽说如此，长久以来还是有很多小细节让自己在使用 Emacs 的时候很是不爽，最近一周稍有闲暇，本着磨刀不误砍柴工的精神，也来折腾了一下 Emacs ，居然被我搞定了几个困扰已久的配置。整理记录一下，希望能帮到遇到同样问题的朋友们。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id8"&gt;Emacs 中文字体配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id9"&gt;Emacs 字体大小的调整&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id10"&gt;添加删除注释&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id11"&gt;复制当前行&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id12"&gt;拷贝代码自动格式化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#emacs-windows" id="id13"&gt;Emacs 与 Windows 系统的整合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id14"&gt;Emacs 的配色&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Emacs 中文字体配置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这是最让我恼火的配置之一，在 Emacs 23 以前，由于底层不是 Unicode，经常会遇到中文乱码的问题。好在 Emacs 23 底层统一用 Unicode 重新实现了，现在不会再有乱码的问题，可字体的配置却仍然很麻烦，网上有很多例子和文档，但都或多或少有些问题，总是不够尽善尽美。&lt;/p&gt;
&lt;p&gt;最简单的字体设置方式是：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-default-font&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;-outline-Lucida Console-normal-normal-normal-mono-*-*-*-*-*-*-iso10646-1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;它的问题是只对初始的窗口（frame）有效，对于新窗口如 speedbar 或用快捷键 &lt;span class="kbd"&gt;ctrl-x&lt;/span&gt; &lt;span class="kbd"&gt;5&lt;/span&gt; &lt;span class="kbd"&gt;2&lt;/span&gt; 分出来的窗口无效。改成下面的设置方法，字体设置对初始窗口和后面的新窗口就都会生效了。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;setq&lt;/span&gt; &lt;span class="nv"&gt;default-frame-alist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Lucida Console 12&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再就是对中英文混排文本的支持，可以使用同时包含中文和英文的字体来解决。网上有人把中文和等宽英文字体合并为新的字体以方便编程使用。比如我以前配置里用的 &lt;tt class="docutils literal"&gt;微软雅黑Monaco&lt;/tt&gt; 字体就很不错&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;setq&lt;/span&gt; &lt;span class="nv"&gt;default-frame-alist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;微软雅黑Monaco 12&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种方法的缺点在于你没办法单独换英文字体或中文字体，要换只能新做一个字体整体换掉。而且网上做的字体里面，并没有包含斜体，样式不够丰富。其实 Emacs 本身就支持根据字符编码去找合适的字体，不过需要按编码详细的设置，让 Emacs 明白遇到汉字编码要用宋体，而不是 &lt;tt class="docutils literal"&gt;楷体&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;Lucida Console&lt;/tt&gt; 。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-fontset-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;frame-parameter&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                  &lt;span class="ss"&gt;&amp;#39;han&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-spec&lt;/span&gt; &lt;span class="nv"&gt;:family&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Microsoft Yahei&amp;quot;&lt;/span&gt;
                                  &lt;span class="nv"&gt;:size&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;除了 &lt;tt class="docutils literal"&gt;han&lt;/tt&gt; 以外，还有 &lt;tt class="docutils literal"&gt;kana&lt;/tt&gt;， &lt;tt class="docutils literal"&gt;symbol&lt;/tt&gt; ， &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;cjk-misc&lt;/span&gt;&lt;/tt&gt; ， &lt;tt class="docutils literal"&gt;bopomofo&lt;/tt&gt; 这些编码集也要一并设置好。可以用 elisp 的 &lt;tt class="docutils literal"&gt;dolist&lt;/tt&gt; 循环操作减少不必要的代码重复：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;dolist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;charset&lt;/span&gt; &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;kana&lt;/span&gt; &lt;span class="nv"&gt;han&lt;/span&gt; &lt;span class="nv"&gt;symbol&lt;/span&gt; &lt;span class="nv"&gt;cjk-misc&lt;/span&gt; &lt;span class="nv"&gt;bopomofo&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-fontset-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;frame-parameter&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                    &lt;span class="nv"&gt;charset&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-spec&lt;/span&gt; &lt;span class="nv"&gt;:family&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Microsoft Yahei&amp;quot;&lt;/span&gt;
                                       &lt;span class="nv"&gt;:size&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;切记不能图省事，直接把 Unicode 字体设成中文，否则在 Windows 上原来的英文字体设置就失效了。还有对英文字体的设置方法要改成下面这样才能和中文的配合，不然 Emacs 会乎略英文字体的设置（至少在 Windows 平台上是这样）所以最终版本是&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;;; Setting English Font&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-face-attribute&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;default&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="nv"&gt;:font&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Consolas 12&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;;; Chinese Font&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;dolist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;charset&lt;/span&gt; &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;kana&lt;/span&gt; &lt;span class="nv"&gt;han&lt;/span&gt; &lt;span class="nv"&gt;symbol&lt;/span&gt; &lt;span class="nv"&gt;cjk-misc&lt;/span&gt; &lt;span class="nv"&gt;bopomofo&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-fontset-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;frame-parameter&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                    &lt;span class="nv"&gt;charset&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-spec&lt;/span&gt; &lt;span class="nv"&gt;:family&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Microsoft Yahei&amp;quot;&lt;/span&gt;
                                       &lt;span class="nv"&gt;:size&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;字体的选择上，中文我比较喜欢微软雅黑，英文我选择等宽字体方便编程。一般常使用 Monaco 或者 Consolas。Monaco 是那种一见倾心型的，字体高挑修长，有种拉丁美人的性感。Consolas 是微软为新版 Visual Studio 专门打造的编程字体，虽然乍看没有 Monaco 那么惊艳，但相当耐看，如同小家碧玉，是个“居家过日子”的实用字体。听说 DejaVu Sans Mono 也不错，准备有时间试试看。&lt;/p&gt;
&lt;p&gt;这样 Emacs 的字体设置算是赶上其它的编辑器了。可 Emacs 作为神一般的存在，只是赶上其它编辑器这也太丢人。下面要挑战一下自我，让神器发挥它应有的威力：如何能够根据用户的喜好和操作系统的字体库来做最符合用户心意的字体设定呢？&lt;/p&gt;
&lt;p&gt;换言之，我想要的功能是：如果系统有雅黑字体，就请帮忙用雅黑，否则（如 Linux 上默认没有雅黑）就请用开源字体文泉驿微米黑。查了一下，网上没有现成的例子，只好挽起袖子，自己研究 elisp 动手写了一个设置字体的函数。&lt;/p&gt;
&lt;p&gt;首先，我们要能判断某个字体在系统中是否存在：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;qiang-font-existsp&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;null&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;x-list-fonts&lt;/span&gt; &lt;span class="nv"&gt;font&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
      &lt;span class="nv"&gt;nil&lt;/span&gt;
    &lt;span class="nv"&gt;t&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其次，要到用户预定义的字体列表中找出首个存在的字体：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defvar&lt;/span&gt; &lt;span class="nv"&gt;font-list&lt;/span&gt; &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Microsoft Yahei&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;文泉驿等宽微米黑&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;黑体&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;新宋体&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;宋体&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;require&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;cl&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;;; find-if is in common list package&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;find-if&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="ss"&gt;&amp;#39;qiang-font-existsp&lt;/span&gt; &lt;span class="nv"&gt;font-list&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;还要有个辅助函数，用来产生带上字体大小信息的字体描述文本：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;qiang-make-font-string&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-name&lt;/span&gt; &lt;span class="nv"&gt;font-size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;and &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;stringp&lt;/span&gt; &lt;span class="nv"&gt;font-size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;equal&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;:&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;string &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;elt&lt;/span&gt; &lt;span class="nv"&gt;font-size&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;format&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;%s%s&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;font-name&lt;/span&gt; &lt;span class="nv"&gt;font-size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;format&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;%s %s&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;font-name&lt;/span&gt; &lt;span class="nv"&gt;font-size&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里比较绕的地方是，如果传入的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;font-size&lt;/span&gt;&lt;/tt&gt; 是 &lt;tt class="docutils literal"&gt;:pixelsize=18&lt;/tt&gt; 这样的话，字体名称和它之间不能有空格。如果是普通的数字的话，例如 12 或“12”，需要有个空格分隔字体名称和字体大小。&lt;/p&gt;
&lt;p&gt;有了这些函数，下面出场的就是自动设置字体函数了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;qiang-set-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;english-fonts&lt;/span&gt;
                       &lt;span class="nv"&gt;english-font-size&lt;/span&gt;
                       &lt;span class="nv"&gt;chinese-fonts&lt;/span&gt;
                       &lt;span class="nv"&gt;&amp;amp;optional&lt;/span&gt; &lt;span class="nv"&gt;chinese-font-size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

  &lt;span class="s"&gt;&amp;quot;english-font-size could be set to \&amp;quot;:pixelsize=18\&amp;quot; or a integer.&lt;/span&gt;
&lt;span class="s"&gt;If set/leave chinese-font-size to nil, it will follow english-font-size&amp;quot;&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;require&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;cl&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;; for find if&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;en-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;qiang-make-font-string&lt;/span&gt;
                  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;find-if&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="ss"&gt;&amp;#39;qiang-font-existsp&lt;/span&gt; &lt;span class="nv"&gt;english-fonts&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                  &lt;span class="nv"&gt;english-font-size&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;zh-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-spec&lt;/span&gt; &lt;span class="nv"&gt;:family&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;find-if&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="ss"&gt;&amp;#39;qiang-font-existsp&lt;/span&gt; &lt;span class="nv"&gt;chinese-fonts&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                            &lt;span class="nv"&gt;:size&lt;/span&gt; &lt;span class="nv"&gt;chinese-font-size&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;

    &lt;span class="c1"&gt;;; Set the default English font&lt;/span&gt;
    &lt;span class="c1"&gt;;;&lt;/span&gt;
    &lt;span class="c1"&gt;;; The following 2 method cannot make the font settig work in new frames.&lt;/span&gt;
    &lt;span class="c1"&gt;;; (set-default-font &amp;quot;Consolas:pixelsize=18&amp;quot;)&lt;/span&gt;
    &lt;span class="c1"&gt;;; (add-to-list &amp;#39;default-frame-alist &amp;#39;(font . &amp;quot;Consolas:pixelsize=18&amp;quot;))&lt;/span&gt;
    &lt;span class="c1"&gt;;; We have to use set-face-attribute&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Set English Font to %s&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;en-font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-face-attribute&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;default&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="nv"&gt;:font&lt;/span&gt; &lt;span class="nv"&gt;en-font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c1"&gt;;; Set Chinese font&lt;/span&gt;
    &lt;span class="c1"&gt;;; Do not use &amp;#39;unicode charset, it will cause the English font setting invalid&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Set Chinese Font to %s&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;zh-font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;dolist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;charset&lt;/span&gt; &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;kana&lt;/span&gt; &lt;span class="nv"&gt;han&lt;/span&gt; &lt;span class="nv"&gt;symbol&lt;/span&gt; &lt;span class="nv"&gt;cjk-misc&lt;/span&gt; &lt;span class="nv"&gt;bopomofo&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;set-fontset-font&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;frame-parameter&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;font&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                        &lt;span class="nv"&gt;charset&lt;/span&gt; &lt;span class="nv"&gt;zh-font&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;利用这个函数，Emacs 字体设置就是小菜一碟了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;qiang-set-font&lt;/span&gt;
 &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Consolas&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Monaco&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;DejaVu Sans Mono&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Monospace&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Courier New&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;:pixelsize=18&amp;quot;&lt;/span&gt;
 &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Microsoft Yahei&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;文泉驿等宽微米黑&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;黑体&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;新宋体&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;宋体&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样设置，Emacs 会优先选用 Consolas + 雅黑的组合。如果雅黑没有装的话，就使用文泉驿等宽微米黑，依此类推。这份字体配置不用改动就能在不同的操作系统字体环境下使用，相信应该没有其它编辑器有这么变态的字体列表设置了吧。至此，Emacs 在字体设置这方面总算是体面地稍稍胜出了其它编辑器。把上面的三个函数加到配置文件里赶快看看效果吧。（或者直接使用 &lt;a class="reference external" href="http://zhuoqiang.me/personal-emacs-configuration.html"&gt;我的 Emacs 配置&lt;/a&gt; 包含了本文所有配置和后续更新）&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;Emacs 字体大小的调整&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在用 Emacs 做演示或代码审查的时候，需要调整字体大小，以前常为了这个手忙脚乱。最近才知道 Emacs 默认就有快捷键支持动态调整字体大小：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;放大字体 &lt;span class="kbd"&gt;ctrl x&lt;/span&gt; &lt;span class="kbd"&gt;ctrl +&lt;/span&gt; 或 &lt;span class="kbd"&gt;ctrl x&lt;/span&gt; &lt;span class="kbd"&gt;ctrl =&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;缩小字体 &lt;span class="kbd"&gt;ctrl x&lt;/span&gt; &lt;span class="kbd"&gt;ctrl -&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;重置字体 &lt;span class="kbd"&gt;ctrl x&lt;/span&gt; &lt;span class="kbd"&gt;ctrl 0&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更酷的是，如果要放大或缩小多次，在第二次直接按 &lt;span class="kbd"&gt;+&lt;/span&gt;， &lt;span class="kbd"&gt;-&lt;/span&gt;， &lt;span class="kbd"&gt;0&lt;/span&gt; 就可以了。比如，放大 3 次： &lt;span class="kbd"&gt;ctrl x&lt;/span&gt; &lt;span class="kbd"&gt;ctrl =&lt;/span&gt; &lt;span class="kbd"&gt;=&lt;/span&gt; &lt;span class="kbd"&gt;=&lt;/span&gt;。另外， &lt;span class="kbd"&gt;shift 鼠标左键&lt;/span&gt; 也能唤出调整字体大小的弹出菜单。&lt;/p&gt;
&lt;p&gt;不过，能不能象浏览器和 Visual Studio 2010 那样，用 &lt;span class="kbd"&gt;ctrl&lt;/span&gt; 加上鼠标滚轮操作来调整字体大小呢，毕竟大部分人已经习惯了这种方式。既然是无所不能的 Emacs，那当然没问题了，把下面的配置加入 .emacs 里再试试看&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;;; For Linux&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kbd&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;C-mouse-4&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;text-scale-increase&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kbd&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;C-mouse-5&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;text-scale-decrease&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;;; For Windows&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kbd&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;C-wheel-up&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;text-scale-increase&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kbd&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;C-wheel-down&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;text-scale-decrease&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;添加删除注释&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;写程序的要经常和注释打交道，注释和反注释一段代码是家常便饭。Emacs 虽然有这个功能，默认的配置却并不好用：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;注释/反注释默认没有绑定快捷键&lt;/li&gt;
&lt;li&gt;需要先选中一段区域才能调用注释功能，无法直接注释反注释当前行&lt;/li&gt;
&lt;li&gt;好在有一个 &lt;span class="kbd"&gt;alt ;&lt;/span&gt; 的快捷键，默认绑定了 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;comment-dwim&lt;/span&gt;&lt;/tt&gt; 能注释反注释当前激活的区域。如果没有激活区域，就在当前行末加注释&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span class="kbd"&gt;alt ;&lt;/span&gt; 默认绑定的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;comment-dwim&lt;/span&gt;&lt;/tt&gt; 已经很理想了，可还是不够 dwim（Do What I Mean）。能不能变成，如果没有激活的区域就注释反注释当前行，仅当在行尾的时候才在行尾加注释呢？下面的配置就是参考别人配置写的 “照我说的做”注释函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;qiang-comment-dwim-line&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;&amp;amp;optional&lt;/span&gt; &lt;span class="nv"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;Replacement for the comment-dwim command.&lt;/span&gt;
&lt;span class="s"&gt;If no region is selected and current line is not blank and&lt;/span&gt;
&lt;span class="s"&gt;we are not at the end of the line, then comment current line.&lt;/span&gt;
&lt;span class="s"&gt;Replaces default behaviour of comment-dwim,&lt;/span&gt;
&lt;span class="s"&gt;when it inserts comment at the end of the line. &amp;quot;&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;interactive&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;*P&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;comment-normalize-vars&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;and &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;not &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-active-p&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;not &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;looking-at&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;[ \t]*$&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;comment-or-uncomment-region&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-beginning-position&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-end-position&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;comment-dwim&lt;/span&gt; &lt;span class="nv"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;


&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;\M-;&amp;quot;&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;qiang-comment-dwim-line&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样一来，注释和反注释代码的操作只使用一个 &lt;span class="kbd"&gt;alt ;&lt;/span&gt; 键就全部搞定了，Emacs 会心领神会地“照我说的做”。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;复制当前行&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这是个经常要用到的操作，以前要么老老实实 Mark 当前行的行首和行尾，然后复制。整个按键流程是：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl a&lt;/span&gt; 光标到行首&lt;/li&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl shift space&lt;/span&gt; 设置标记&lt;/li&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl e&lt;/span&gt; 光标到行尾，如此这一行就被选为激活区域了&lt;/li&gt;
&lt;li&gt;&lt;span class="kbd"&gt;alt w&lt;/span&gt; 复制当前激活的区域&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;要么按我比较习惯的操作先剪切当前行，再撤消上一次的剪切操作&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl a&lt;/span&gt; 光标到行首&lt;/li&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl k&lt;/span&gt; 剪切至行屋，该行消失&lt;/li&gt;
&lt;li&gt;&lt;span class="kbd"&gt;ctrl /&lt;/span&gt; 撤消上一次的操作，该行重现&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;可以看到，方案二比方案一省一次按键，而且 &lt;span class="kbd"&gt;ctrl&lt;/span&gt; 键不用松开。不过如此基本的操作要按三个键还是太麻烦了，而且方案二会让文件变成被编辑过的状态。其实，可以发挥一下“按我说的做”的精神。为什么不把 &lt;span class="kbd"&gt;alt w&lt;/span&gt; 变的更聪明一些，当没有激活的区域时就复制当前的一整行呢？说做就做：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;;; Smart copy, if no region active, it simply copy the current whole line&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defadvice&lt;/span&gt; &lt;span class="nv"&gt;kill-line&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;before&lt;/span&gt; &lt;span class="nv"&gt;check-position&lt;/span&gt; &lt;span class="nv"&gt;activate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;member &lt;/span&gt;&lt;span class="nv"&gt;major-mode&lt;/span&gt;
              &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;emacs-lisp-mode&lt;/span&gt; &lt;span class="nv"&gt;scheme-mode&lt;/span&gt; &lt;span class="nv"&gt;lisp-mode&lt;/span&gt;
                                &lt;span class="nv"&gt;c-mode&lt;/span&gt; &lt;span class="nv"&gt;c++-mode&lt;/span&gt; &lt;span class="nv"&gt;objc-mode&lt;/span&gt; &lt;span class="nv"&gt;js-mode&lt;/span&gt;
                                &lt;span class="nv"&gt;latex-mode&lt;/span&gt; &lt;span class="nv"&gt;plain-tex-mode&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;and &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;eolp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;not &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;bolp&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;progn&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;forward-char&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                 &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;just-one-space&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                 &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;backward-char&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)))))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defadvice&lt;/span&gt; &lt;span class="nv"&gt;kill-ring-save&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;before&lt;/span&gt; &lt;span class="nv"&gt;slick-copy&lt;/span&gt; &lt;span class="nv"&gt;activate&lt;/span&gt; &lt;span class="nv"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;When called interactively with no active region, copy a single line instead.&amp;quot;&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;interactive&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="nv"&gt;mark-active&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-beginning&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-end&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
                 &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Copied line&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                 &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-beginning-position&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                       &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-beginning-position&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)))))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defadvice&lt;/span&gt; &lt;span class="nv"&gt;kill-region&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;before&lt;/span&gt; &lt;span class="nv"&gt;slick-cut&lt;/span&gt; &lt;span class="nv"&gt;activate&lt;/span&gt; &lt;span class="nv"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;When called interactively with no active region, kill a single line instead.&amp;quot;&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;interactive&lt;/span&gt;
   &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="nv"&gt;mark-active&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-beginning&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-end&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;list &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-beginning-position&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-beginning-position&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)))))&lt;/span&gt;

&lt;span class="c1"&gt;;; Copy line from point to the end, exclude the line break&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;qiang-copy-line&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;Copy lines (as many as prefix argument) in the kill ring&amp;quot;&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;interactive&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;p&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kill-ring-save&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;point&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;line-end-position&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="c1"&gt;;; (line-beginning-position (+ 1 arg)))&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;%d line%s copied&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;arg&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;if &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;= &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;s&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;global-set-key&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;kbd&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;M-k&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;qiang-copy-line&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面还多加了一个配置，就是把 &lt;span class="kbd"&gt;alt k&lt;/span&gt; 设成复制光标所在处到行尾。与 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;kill-line&lt;/span&gt;&lt;/tt&gt; 的 &lt;span class="kbd"&gt;ctrl k&lt;/span&gt; 对应。这样一来，如果是要拷贝一整行的话，只要将光标移动到该行任意位置，按下 &lt;span class="kbd"&gt;alt w&lt;/span&gt; 就行了。如果是复制某个位置到行尾的文字的话，就把光标移到起始位置处，按 &lt;span class="kbd"&gt;alt k&lt;/span&gt; 。比默认的操作简化了很多。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;拷贝代码自动格式化&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Emacs 里对代码格式化支持的非常好，不但可以在编辑的时候自动帮你格式化，还可以选中一块代码，按 &lt;span class="kbd"&gt;ctrl alt \ &lt;/span&gt; 对这块代码重新进行格式化。如果要粘贴一块代码的话，粘贴完了紧接着按 &lt;span class="kbd"&gt;ctrl alt \ &lt;/span&gt; 就可以把新加入的代码格式化好。可对于这种粘贴加上重新格式化的机械操作，Emacs 应该可以将它自动化才能配得上它的名气，把下面的代码加到配置文件里，你的 Emacs 就会拥有这种能力了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;dolist&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;command&lt;/span&gt; &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;yank&lt;/span&gt; &lt;span class="nv"&gt;yank-pop&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;eval&lt;/span&gt;
   &lt;span class="o"&gt;`&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defadvice,&lt;/span&gt; &lt;span class="nv"&gt;command&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;after&lt;/span&gt; &lt;span class="nv"&gt;indent-region&lt;/span&gt; &lt;span class="nv"&gt;activate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;and &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;not &lt;/span&gt;&lt;span class="nv"&gt;current-prefix-arg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;member &lt;/span&gt;&lt;span class="nv"&gt;major-mode&lt;/span&gt;
                   &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;emacs-lisp-mode&lt;/span&gt; &lt;span class="nv"&gt;lisp-mode&lt;/span&gt; &lt;span class="nv"&gt;clojure-mode&lt;/span&gt; &lt;span class="nv"&gt;scheme-mode&lt;/span&gt;
                                     &lt;span class="nv"&gt;haskell-mode&lt;/span&gt; &lt;span class="nv"&gt;ruby-mode&lt;/span&gt; &lt;span class="nv"&gt;rspec-mode&lt;/span&gt;
                                     &lt;span class="nv"&gt;python-mode&lt;/span&gt; &lt;span class="nv"&gt;c-mode&lt;/span&gt; &lt;span class="nv"&gt;c++-mode&lt;/span&gt; &lt;span class="nv"&gt;objc-mode&lt;/span&gt;
                                     &lt;span class="nv"&gt;latex-mode&lt;/span&gt; &lt;span class="nv"&gt;js-mode&lt;/span&gt; &lt;span class="nv"&gt;plain-tex-mode&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
           &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;mark-even-if-inactive&lt;/span&gt; &lt;span class="nv"&gt;transient-mark-mode&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
             &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;indent-region&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-beginning&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region-end&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;你可以加入或删除一些 mode 名称来定制上面的配置。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="emacs-windows"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;Emacs 与 Windows 系统的整合&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在注册表中加入下面的项，右键上下文菜单中就会多出 &lt;tt class="docutils literal"&gt;Emacs&lt;/tt&gt; ，这样你可以快速用 Emacs 编辑任意文件，而不用事先和一堆文件类型相关联：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Windows&lt;/span&gt; &lt;span class="n"&gt;Registry&lt;/span&gt; &lt;span class="n"&gt;Editor&lt;/span&gt; &lt;span class="n"&gt;Version&lt;/span&gt; &lt;span class="mf"&gt;5.00&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;HKEY_CLASSES_ROOT&lt;/span&gt;\&lt;span class="n"&gt;AllFilesystemObjects&lt;/span&gt;\&lt;span class="n"&gt;Shell&lt;/span&gt;\&lt;span class="n"&gt;Emacs&lt;/span&gt;\&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;D:&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;emacs&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;bin&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;emacsclientw.exe&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; -n -a &lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;D:&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;emacs&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;bin&lt;/span&gt;&lt;span class="se"&gt;\\&lt;/span&gt;&lt;span class="s"&gt;runemacs.exe&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;%1&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里调用 &lt;tt class="docutils literal"&gt;emacsclientw.exe&lt;/tt&gt; 是为了使用 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;server-mode&lt;/span&gt;&lt;/tt&gt; 来避免再打开一个 Emacs 实例。 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-n&lt;/span&gt;&lt;/tt&gt; 参数指明不需要等待 emacs server 编辑结束就直接返回， &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-a&lt;/span&gt;&lt;/tt&gt; 指明一个替代品：如果找不到 emacs server，那就运行 &lt;tt class="docutils literal"&gt;runemacs.exe&lt;/tt&gt; 启动一个 emacs 实例来编辑。不要忘了在 &lt;tt class="docutils literal"&gt;.emacs&lt;/tt&gt; 里加入&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;server-mode&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;来自动启动 emacs server。&lt;/p&gt;
&lt;p&gt;有些工具在使用外部工具时命令行不能带任何参数，遇到这种情况，只能写一个批处理文件把上面的命令包装一下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;D:\emacs\bin\emacsclientw.exe -n -a &lt;span class="s2"&gt;&amp;quot;D:\emacs\bin\runemacs.exe&amp;quot;&lt;/span&gt; %*
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果装了 Visual Studio，那么，在 Visual Studio 的菜单 &lt;tt class="docutils literal"&gt;Tools&lt;/tt&gt; 下面可以通过 &lt;tt class="docutils literal"&gt;External Tools&lt;/tt&gt; 加入一个自定义的外部工具。外部工具的命令可以使用上面定义的 &lt;tt class="docutils literal"&gt;emacsclientw.exe&lt;/tt&gt; ，参数那栏加上&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;-n -a &lt;span class="s2"&gt;&amp;quot;D:\emacs\bin\runemacs.exe&amp;quot;&lt;/span&gt; +$(CurLine) $(ItemPath)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;将这个外部工具设上一个方便的快捷键，比如我就设成 &lt;span class="kbd"&gt;alt f1&lt;/span&gt; ，这样每次用 Visual Studio 浏览代码时，如果看到想编辑的内容，直接 &lt;span class="kbd"&gt;alt f1&lt;/span&gt; 就可以把 emasc 呼出，光标会自动放在文件刚刚看的那行上面。编辑完了后再 &lt;span class="kbd"&gt;alt tab&lt;/span&gt; 就可以切会 Visual Studio 了。你可能还需要设置 Visual Studio 自动重新载入改过的文件，避免每次都弹出对话框让你确认是否重新载入。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id14"&gt;Emacs 的配色&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我以前的 Emacs 配色非常简单，黑底白字。用时间长了会腻，而且 Emacs 默认的代码高亮配色只能说相当的一般。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;setq&lt;/span&gt; &lt;span class="nv"&gt;default-frame-alist&lt;/span&gt;
      &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;cursor-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;purple&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cursor-type&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="nv"&gt;box&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;foreground-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;background-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这两天在网上搜 Emacs 相关配置的时候，发现了一个很漂亮的配色。一位网友发现 Mac 上 TextMate 的 blackboard 主题配色很养眼，于是就把这个配色方案写成了一个 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;color-theme&lt;/span&gt;&lt;/tt&gt; 移到了 emacs 上，效果相当赞。&lt;/p&gt;
&lt;p&gt;我在使用这个主题时做了三处调整&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;变量声明的颜色改为绿宝石色，与函数声明的颜色相区别&lt;/li&gt;
&lt;li&gt;背景底色由黑板色改为纯黑色，增加对比度&lt;/li&gt;
&lt;li&gt;当前行高亮色改为深蓝色，不让它太明显&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面是我调整后的主题：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;;; Blackboard Colour Theme for Emacs.&lt;/span&gt;
&lt;span class="c1"&gt;;;&lt;/span&gt;
&lt;span class="c1"&gt;;; Defines a colour scheme resembling that of the original TextMate Blackboard colour theme.&lt;/span&gt;
&lt;span class="c1"&gt;;; To use add the following to your .emacs file (requires the color-theme package):&lt;/span&gt;
&lt;span class="c1"&gt;;;&lt;/span&gt;
&lt;span class="c1"&gt;;; (require &amp;#39;color-theme)&lt;/span&gt;
&lt;span class="c1"&gt;;; (color-theme-initialize)&lt;/span&gt;
&lt;span class="c1"&gt;;; (load-file &amp;quot;~/.emacs.d/themes/color-theme-blackboard.el&amp;quot;)&lt;/span&gt;
&lt;span class="c1"&gt;;;&lt;/span&gt;
&lt;span class="c1"&gt;;; And then (color-theme-blackboard) to activate it.&lt;/span&gt;
&lt;span class="c1"&gt;;;&lt;/span&gt;
&lt;span class="c1"&gt;;; MIT License Copyright (c) 2008 JD Huntington &amp;lt;jdhuntington at gmail dot com&amp;gt;&lt;/span&gt;
&lt;span class="c1"&gt;;; Credits due to the excellent TextMate Blackboard theme&lt;/span&gt;
&lt;span class="c1"&gt;;;&lt;/span&gt;
&lt;span class="c1"&gt;;; All patches welcome&lt;/span&gt;

&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;defun&lt;/span&gt; &lt;span class="nv"&gt;color-theme-blackboard&lt;/span&gt; &lt;span class="p"&gt;()&lt;/span&gt;
  &lt;span class="s"&gt;&amp;quot;Color theme by JD Huntington, based off the TextMate Blackboard theme, created 2008-11-27&amp;quot;&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;interactive&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;color-theme-install&lt;/span&gt;
   &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;color-theme-blackboard&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;
      &lt;span class="c1"&gt;;; (background-color . &amp;quot;#0C1021&amp;quot;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;background-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;background-mode&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="nv"&gt;dark&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;border-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;cursor-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#A7A7A7&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;foreground-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#F8F8F8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;mouse-color&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;sienna1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
     &lt;span class="c1"&gt;;; (default ((t (:background &amp;quot;#0C1021&amp;quot; :foreground &amp;quot;#F8F8F8&amp;quot;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;default&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#F8F8F8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;blue&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;bold&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:bold&lt;/span&gt; &lt;span class="nv"&gt;t&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;bold-italic&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:bold&lt;/span&gt; &lt;span class="nv"&gt;t&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;border-glyph&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;buffers-tab&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#0C1021&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#F8F8F8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-builtin-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#F8F8F8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-comment-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:italic&lt;/span&gt; &lt;span class="nv"&gt;t&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#AEAEAE&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-constant-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#D8FA3C&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-doc-string-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;DarkOrange&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-function-name-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#FF6400&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-keyword-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#FBDE2D&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-preprocessor-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Aquamarine&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-reference-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;SlateBlue&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;

     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-regexp-grouping-backslash&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#E9C062&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-regexp-grouping-construct&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;

     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-string-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#61CE3C&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-type-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#8DA6CE&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="c1"&gt;;; (font-lock-variable-name-face ((t (:foreground &amp;quot;#FF6400&amp;quot;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-variable-name-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#40E0D0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;font-lock-warning-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:bold&lt;/span&gt; &lt;span class="nv"&gt;t&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Pink&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;gui-element&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#D4D0C8&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;region&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#253B76&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;mode-line&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;grey75&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="c1"&gt;;; (highlight ((t (:background &amp;quot;#222222&amp;quot;))))&lt;/span&gt;
     &lt;span class="c1"&gt;;; (highlight ((t (:background &amp;quot;#0C1021&amp;quot;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;highlight&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;#001&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;highline-face&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;SeaGreen&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;italic&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;left-margin&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;text-cursor&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;yellow&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;toolbar&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;underline&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;nil&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:underline&lt;/span&gt; &lt;span class="nv"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;zmacs-region&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="nf"&gt;t&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;:background&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;snow&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;:foreground&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;ble&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)))))))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用的话需要先安装 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;color-theme&lt;/span&gt;&lt;/tt&gt; 包，将上面的配色存为 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;color-theme-blackboard.el&lt;/span&gt;&lt;/tt&gt; 放在 emacs 的 load path 中，再加入下面的配置就好了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;require&lt;/span&gt; &lt;span class="ss"&gt;&amp;#39;color-theme&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;eval-after-load&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;color-theme&amp;quot;&lt;/span&gt;
  &lt;span class="o"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;progn&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;color-theme-initialize&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;color-theme-blackboard&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;来看看我配置的使用 Consolas + 雅黑 + blackboard-theme 的 Emacs：&lt;/p&gt;
&lt;img alt="|filename|/images/emacs.png" src="http://zhuoqiang.me/static/images/emacs.png" style="width: 90%;" /&gt;
&lt;p&gt;虽说 10 个人会配出 11 种不同的 emacs，不过我这个还算是芙蓉出水，落落大方吧。&lt;/p&gt;
&lt;p&gt;折腾到此结束，整容后的 emacs 更加的漂亮听话了。话说回来，emacs 实在是要与时俱进，改变一下难学难用的形象，最好将这些方便的操作设为默认配置。毕竟对最终用户来说这样的折腾也只能偶尔为之，是将心思花在配置这神一样的编辑器上面，自己早晚也要成为半仙。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="config"></category><category term="emacs"></category></entry><entry><title>死亡</title><link href="http://zhuoqiang.me/death.html" rel="alternate"></link><updated>2010-08-06T07:28:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-08-06:death.html</id><summary type="html">&lt;p&gt;鄙厌的 &lt;br /&gt;
盘旋的鹰 &lt;br /&gt;
白色天际的黑点 &lt;br /&gt;
飞驰而下 &lt;br /&gt;
瞬间 &lt;br /&gt;
充盈了天地 &lt;br /&gt;
把新鲜的腐肉 &lt;br /&gt;
一口口地啄去 &lt;br /&gt;
留下洁白的骨头 &lt;br /&gt;
散在大地 &lt;br /&gt;
迎接每一个明天 &lt;br /&gt;&lt;/p&gt;
</summary><category term="poem"></category></entry><entry><title>让 Raphael 的 Path 动起来</title><link href="http://zhuoqiang.me/make-raphael-path-draggable.html" rel="alternate"></link><updated>2010-08-02T23:23:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-08-02:make-raphael-path-draggable.html</id><summary type="html">&lt;p&gt;Raphaël 是一个很简单实用的 Javascript 矢量图形库。它抽象出一套 API 屏蔽了 SVG 和 VML 之间的差异，做到了对主流浏览器的支持，包括很不给力的 IE6（很可惜，并不支持手机 UC 浏览器）。&lt;/p&gt;
&lt;p&gt;Raphaël 对于交互事件也有一定的支持，比如常用的鼠标拖放操作等。可惜在官网上虽然有拖放操作的例子，但例子的写法只对 circle，rect 有效，对 path 却不起作用。经过一番实践，终于了解了 Raphaël 对于拖放支持的原理，找到了一个通用的拖放操作方法，能支持所有的矢量对象，也包括 path。&lt;/p&gt;
&lt;p&gt;官方例子之所以对 path 不起作用是因为：path 没有象 circle 里面的 &lt;tt class="docutils literal"&gt;cx&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;cy&lt;/tt&gt; 属性，要移动 path，只能使用 &lt;tt class="docutils literal"&gt;Path.translate()&lt;/tt&gt; 方法。还要注意的是，Path 必须要先 &lt;tt class="docutils literal"&gt;fill&lt;/tt&gt; 才能移动。&lt;/p&gt;
&lt;p&gt;仿照官网的例子，下面是一个 Path 移动的代码示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;Raphael&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;paper&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;300&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;260&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;M0 0L100 0L50 80Z&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

&lt;span class="nx"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;attr&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;
    &lt;span class="s2"&gt;&amp;quot;fill&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;green&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;opacity&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;0.8&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;

&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;attr&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;
        &lt;span class="nx"&gt;opacity&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="nx"&gt;move&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;dx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;dy&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;deltaX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;translate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;deltaX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="nx"&gt;up&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;attr&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;
            &lt;span class="nx"&gt;opacity&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;0.8&lt;/span&gt;
        &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="nx"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;drag&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;move&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;up&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a class="reference external" href="http://jsfiddle.net/zhuoqiang/CKsZQ/"&gt;运行效果&lt;/a&gt; 如下，请试着用鼠标拖动小三角形：&lt;/p&gt;
&lt;iframe style="width: 100%; height: 350px" src="http://jsfiddle.net/zhuoqiang/CKsZQ/embedded/result,js/" allowfullscreen="allowfullscreen" frameborder="0"&gt;&lt;/iframe&gt;&lt;p&gt;这个例子有几点要说明一下&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;回调函数 &lt;tt class="docutils literal"&gt;move&lt;/tt&gt; 的第一和第二个参数是鼠标当前所在位置距离初始鼠标位置的相对位移值。而不是距离上次 &lt;tt class="docutils literal"&gt;move&lt;/tt&gt; 回调时鼠标位置的位移&lt;/li&gt;
&lt;li&gt;我们在 &lt;tt class="docutils literal"&gt;start&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;move&lt;/tt&gt; 中不断更新相对位移值，并保存在 &lt;tt class="docutils literal"&gt;this.lastX&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;this.lastY&lt;/tt&gt; 中&lt;/li&gt;
&lt;li&gt;我们通过 &lt;tt class="docutils literal"&gt;this.translate()&lt;/tt&gt; 进行实际的移动操作&lt;/li&gt;
&lt;li&gt;开始就要设置 &lt;tt class="docutils literal"&gt;fill&lt;/tt&gt; 属性，否则就不能进行移动操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个例子不但能工作，而且因为所有的 Raphael 矢量对象都有 &lt;tt class="docutils literal"&gt;translate&lt;/tt&gt; 方法。所以它不仅对 path 有效，也对所有的 Raphael 矢量对象有效。那是不是能做出来类似 &lt;tt class="docutils literal"&gt;jQuery.ui&lt;/tt&gt; 里面的 &lt;tt class="docutils literal"&gt;draggble&lt;/tt&gt; 之类的函数呢。下面就是一个简单的扩展，为 Raphael 对象加入了 &lt;tt class="docutils literal"&gt;draggable&lt;/tt&gt; 方法&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;el&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;draggable&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;move&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;up&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="p"&gt;{};&lt;/span&gt;

        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;that&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;onMove&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;is&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;move&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;function&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;?&lt;/span&gt;
        &lt;span class="nx"&gt;move&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;distanceX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;distanceY&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;translate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;deltaX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;};&lt;/span&gt;

        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;onStart&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;is&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;start&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;function&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="nx"&gt;start&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="p"&gt;};&lt;/span&gt;

        &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;onMove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;distanceX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;distanceY&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;deltaX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;onMove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;distanceX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;distanceY&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;deltaY&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;paper&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;safari&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;};&lt;/span&gt;

        &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;onStart&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;lastY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="nx"&gt;that&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;_ui&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;onStart&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;y&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;};&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;drag&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;onMove&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;onStart&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;up&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="p"&gt;})(&lt;/span&gt;&lt;span class="nx"&gt;Raphael&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的一段代码，扩展了 Raphael 对象的方法，让它们拥有了类似 &lt;tt class="docutils literal"&gt;jquery.ui&lt;/tt&gt; 里 &lt;tt class="docutils literal"&gt;draggable&lt;/tt&gt; 的能力。下面是用利用这个扩展重写的拖放 Path 的例子&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;Raphael&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;paper&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;400&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;300&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;rect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;400&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;300&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;R&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;M0 0L100 0L50 80Z&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

&lt;span class="nx"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;attr&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;fill&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;green&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;opacity&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="nx"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;draggable&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到，只需要简单的调用 &lt;tt class="docutils literal"&gt;.draggable()&lt;/tt&gt; 就可以让对象被鼠标拖拽了。&lt;/p&gt;
</summary><category term="javascript"></category><category term="web"></category></entry><entry><title>Python 标准库 urllib2 的使用细节</title><link href="http://zhuoqiang.me/python-urllib2-usage.html" rel="alternate"></link><updated>2010-07-05T21:28:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-07-05:python-urllib2-usage.html</id><summary type="html">&lt;p&gt;Python 标准库中有很多实用的工具类，但是在具体使用时，标准库文档上对使用细节描述的并不清楚，比如 urllib2 这个 HTTP 客户端库。这里总结了一些 urllib2 的使用细节。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#proxy" id="id1"&gt;Proxy 的设置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#timeout" id="id2"&gt;Timeout 设置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http-request-header" id="id3"&gt;在 HTTP Request 中加入特定的 Header&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#redirect" id="id4"&gt;Redirect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#cookie" id="id5"&gt;Cookie&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http-put-delete" id="id6"&gt;使用 HTTP 的 PUT 和 DELETE 方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#http" id="id7"&gt;得到 HTTP 的返回码&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#debug-log" id="id8"&gt;Debug Log&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="proxy"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id1"&gt;Proxy 的设置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;urllib2 默认会使用环境变量 &lt;tt class="docutils literal"&gt;http_proxy&lt;/tt&gt; 来设置 HTTP Proxy。如果想在程序中明确控制 Proxy 而不受环境变量的影响，可以使用下面的方式&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;

&lt;span class="n"&gt;enable_proxy&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;
&lt;span class="n"&gt;proxy_handler&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ProxyHandler&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;http&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;http://some-proxy.com:8080&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="n"&gt;null_proxy_handler&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ProxyHandler&lt;/span&gt;&lt;span class="p"&gt;({})&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;enable_proxy&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;opener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;proxy_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;opener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;null_proxy_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;install_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opener&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里要注意的一个细节，使用 &lt;tt class="docutils literal"&gt;urllib2.install_opener()&lt;/tt&gt; 会设置 urllib2 的全局 &lt;tt class="docutils literal"&gt;opener&lt;/tt&gt; 。这样后面的使用会很方便，但不能做更细粒度的控制，比如想在程序中使用两个不同的 Proxy 设置等。比较好的做法是不使用 &lt;tt class="docutils literal"&gt;install_opener&lt;/tt&gt; 去更改全局的设置，而只是直接调用 &lt;tt class="docutils literal"&gt;opener&lt;/tt&gt; 的 &lt;tt class="docutils literal"&gt;open&lt;/tt&gt; 方法代替全局的 &lt;tt class="docutils literal"&gt;urlopen&lt;/tt&gt; 方法。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="timeout"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id2"&gt;Timeout 设置&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在老版 Python 中，urllib2 的 API 并没有暴露 Timeout 的设置，要设置 Timeout 值，只能更改 Socket 的全局 Timeout 值。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;socket&lt;/span&gt;

&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setdefaulttimeout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c"&gt;# 10 秒钟后超时&lt;/span&gt;
&lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setdefaulttimeout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c"&gt;# 另一种方式&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 Python 2.6 以后，超时可以通过 &lt;tt class="docutils literal"&gt;urllib2.urlopen()&lt;/tt&gt; 的 &lt;tt class="docutils literal"&gt;timeout&lt;/tt&gt; 参数直接设置。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://www.google.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="http-request-header"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id3"&gt;在 HTTP Request 中加入特定的 Header&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;要加入 header，需要使用 &lt;tt class="docutils literal"&gt;Request&lt;/tt&gt; 对象：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;

&lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_header&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;User-Agent&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fake-client&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对有些 header 要特别留意，服务器会针对这些 header 做检查&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;User-Agent&lt;/span&gt;&lt;/tt&gt; : 有些服务器或 Proxy 会通过该值来判断是否是浏览器发出的请求&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Content-Type&lt;/span&gt;&lt;/tt&gt; : 在使用 REST 接口时，服务器会检查该值，用来确定 HTTP Body 中的内容该怎样解析。常见的取值有：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;application/xml&lt;/tt&gt; ： 在 XML RPC，如 RESTful/SOAP 调用时使用&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;application/json&lt;/tt&gt; ： 在 JSON RPC 调用时使用&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;application/x-www-form-urlencoded&lt;/span&gt;&lt;/tt&gt; ： 浏览器提交 Web 表单时使用&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在使用服务器提供的 RESTful 或 SOAP 服务时， &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Content-Type&lt;/span&gt;&lt;/tt&gt; 设置错误会导致服务器拒绝服务&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="redirect"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id4"&gt;Redirect&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;urllib2 默认情况下会针对 HTTP 3XX 返回码自动进行 redirect 动作，无需人工配置。要检测是否发生了 redirect 动作，只要检查一下 &lt;tt class="docutils literal"&gt;Response&lt;/tt&gt; 的 URL 和 &lt;tt class="docutils literal"&gt;Request&lt;/tt&gt; 的 URL 是否一致就可以了。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://www.google.cn&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;redirected&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;geturl&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;http://www.google.cn&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果不想自动 redirect，除了使用更低层次的 httplib 库之外，还可以自定义 &lt;tt class="docutils literal"&gt;HTTPRedirectHandler&lt;/tt&gt; 类。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RedirectHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPRedirectHandler&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;http_error_301&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;http_error_302&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;pass&lt;/span&gt;

&lt;span class="n"&gt;opener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RedirectHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;opener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://www.google.cn&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="cookie"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;Cookie&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;urllib2 对 Cookie 的处理也是自动的。如果需要得到某个 Cookie 项的值，可以这么做：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;cookielib&lt;/span&gt;

&lt;span class="n"&gt;cookie&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cookielib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CookieJar&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;opener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPCookieProcessor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cookie&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;opener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://www.google.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;cookie&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;some_cookie_item_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="http-put-delete"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;使用 HTTP 的 PUT 和 DELETE 方法&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;urllib2 只支持 HTTP 的 &lt;tt class="docutils literal"&gt;GET&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;POST&lt;/tt&gt; 方法，如果要使用 HTTP &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 和 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; ，只能使用比较低层的 httplib 库。虽然如此，我们还是能通过下面的方式，使 urllib2 能够发出 &lt;tt class="docutils literal"&gt;PUT&lt;/tt&gt; 或 &lt;tt class="docutils literal"&gt;DELETE&lt;/tt&gt; 的请求：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;

&lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uri&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_method&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;PUT&amp;#39;&lt;/span&gt; &lt;span class="c"&gt;# or &amp;#39;DELETE&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种做法虽然属于 Hack 的方式，但实际使用起来也没什么问题。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="http"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;得到 HTTP 的返回码&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;对于 &lt;tt class="docutils literal"&gt;200 OK&lt;/tt&gt; 来说，只要使用 &lt;tt class="docutils literal"&gt;urlopen&lt;/tt&gt; 返回的 &lt;tt class="docutils literal"&gt;response&lt;/tt&gt; 对象的 &lt;tt class="docutils literal"&gt;getcode()&lt;/tt&gt; 方法就可以得到 HTTP 的返回码。但对其它返回码来说，urlopen 会抛出异常。这时候，就要检查异常对象的 &lt;tt class="docutils literal"&gt;code&lt;/tt&gt; 属性了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;
&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://restrict.web.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="debug-log"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;Debug Log&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;使用 urllib2 时，可以通过下面的方法把 debug Log 打开，这样收发包的内容就会在屏幕上打印出来，方便调试，有时可以省去抓包的工作&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;urllib2&lt;/span&gt;

&lt;span class="n"&gt;httpHandler&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;debuglevel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;httpsHandler&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HTTPSHandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;debuglevel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;opener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;httpHandler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;httpsHandler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;install_opener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opener&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;urllib2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urlopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://www.google.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</summary><category term="python"></category><category term="web"></category></entry><entry><title>密码传输问题</title><link href="http://zhuoqiang.me/password-transport.html" rel="alternate"></link><updated>2010-06-30T02:50:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-06-30:password-transport.html</id><summary type="html">&lt;p&gt;说了 &lt;a class="reference external" href="http://zhuoqiang.me/password-storage-and-python-example.html"&gt;密码的存储&lt;/a&gt; 问题，接下来再聊聊密码的传输问题。&lt;/p&gt;
&lt;p&gt;对于在线系统，密码的传输要经过下面几个步骤：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;用户在浏览器中输入原始密码：键盘 &lt;tt class="docutils literal"&gt;——&amp;gt;&lt;/tt&gt; 操作系统 &lt;tt class="docutils literal"&gt;——&amp;gt;&lt;/tt&gt; 浏览器内存&lt;/li&gt;
&lt;li&gt;程序对原始密码进行转换：内存中的原始密码 &lt;tt class="docutils literal"&gt;——&amp;gt;&lt;/tt&gt; 内存中的转换后的密码&lt;/li&gt;
&lt;li&gt;转换后的密码在线上传输：内存中转换后的密码 &lt;tt class="docutils literal"&gt;——&amp;gt;&lt;/tt&gt; 网络 &lt;tt class="docutils literal"&gt;——&amp;gt;&lt;/tt&gt; 系统&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这其中每一步都可能泄露原始密码，当然也有相应的保护措施。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id10"&gt;密码输入&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id11"&gt;密码转换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id12"&gt;密码在线传输&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id6" id="id13"&gt;常用服务分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id7" id="id14"&gt;小结&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id9" id="id15"&gt;其它&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id10"&gt;密码输入&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;千里之行始于足下，用户输入密码这第一步往往是最危险的。常用的攻击方法包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;偷看输入的密码&lt;/p&gt;
&lt;p&gt;在公共场合输入密码很容易被偷看，例如使用 ATM 机取款的时候。输入密码时密码明文用 &lt;tt class="docutils literal"&gt;*&lt;/tt&gt; 代替就是为了防止偷窥。但这样正常用户也不能直接用眼睛确认输入密码是否正确，通常在设置新密码时就要输入两遍来确保输入无误。iPhone 在这点做了改进，每输入一个密码字符先显示半秒钟的明文再转成 &lt;tt class="docutils literal"&gt;*&lt;/tt&gt; 显示，鉴于使用 iPhone 虚拟键盘输入时，按错键的概率还是比较高的，这个折中也是在可用性和安全性上做了妥协。还有些系统为了最大限度的防偷窥，在输入密码时屏幕没有任何输出，比如 Unix/Linux 的命令行登录界面。这样就连输入的密码长度都看不出来。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;用木马程序记录键盘输入&lt;/p&gt;
&lt;p&gt;现在比较流行的 QQ 或网络游戏的盗号就常用这种方式进行。安装杀毒软件来防盗号自不必说，还可以用屏幕软键盘输入密码，这样木马就记录不到键盘事件，只能通过分析鼠标点击和当时屏幕图象来破解密码。如果再进一步，软键盘的字符布局每次都随计产生，那就更加重了分析破解的难度。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;感染应用程序或使用钓鱼手法，直接得到内存中的密码值&lt;/p&gt;
&lt;p&gt;不管如何防范输入的过程，一旦密码到程序里，就会以明文的形式呈现在内存中，只要恶意软件模仿安全程序（或模仿网站的外观）直接套取密码就轻而易举。现在出现的假 ATM 机诈骗也是这种手法的衍生。还有一种，不是替换或模仿程序，而是用病毒感染原程序将内存中的值读到。要防范这种攻击，必须要对原程序的完整性和合法性进行验证，只有在验证通过后，才能进行正常的登录交互操作。这个验证可以用数字签名来实现。比如 Windows 7 中所有微软的可执行文件都带有微软的数字签名。在网站上则是 HTTPS 的验证。当然，这个验证过程还牵扯到人的判断，在社会工程学上，软件要配合一些强制的措施，才能保证人不会麻痹大意中招。比如浏览器在访问非信任机构签发的数字签名的 HTTPS 站点时，会警告并且阻止用户进行访问。Windows 7 现在所有的驱动程序也都必须要有微软的数字签名才能运行。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id11"&gt;密码转换&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;原始密码会经过一些转换，才能在线上传输。这跟密码的存储类似。直接传输密码明文是最不安全的。而用简单的可逆变换，或者固定密钥加密也只是增加了破解难度。最好是每次服务器随机产生一个密钥，送给客户端进行加密。&lt;/p&gt;
&lt;p&gt;如果使用 HTTPS，那所有通过 SSL 通道的信息都经过了随机密钥加密。自然也包括了密码。HTTPS 虽然安全，可它最大的问题是性能。连接初始时密钥的协商是通过非对称加密的体系进行的，这会造成连接较慢（密钥协商好后的数据加密是纯耗 CPU 的工作，在现在的硬件条件下，并不是瓶颈）。金融在线系统一般都使用 HTTPS ，但大部分在线应用出于性能的考虑，会选择使用 HTTP 交换随机密码的方式。&lt;/p&gt;
&lt;p&gt;随机密钥由服务器生成并发送给客户端。客户端用此密钥将密码加密，送给服务器。这里不要求加密方法是可逆的。一个较安全的做法是客户端使用 MD5 或 SHA-1 算法对密码进行不可逆转换，再用密钥加密送到 Server。现在已经有很多 Javascript 的加密库可以在浏览器端进行这样的转换工作。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id12"&gt;密码在线传输&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;如果只使用 HTTP 而不使用 HTTPS，那就算密码不被攻破，还是有可能发生重放攻击。当中间人截获了转换后的密码后，他不必知道密码明文就可以用转换后的密码通过服务器的认证。&lt;/p&gt;
&lt;p&gt;现在最新的研究是利用量子力学所揭示的粒子对的超距相关性来进行量子加密传输。可以类比古代密信的火漆封口，一旦信件被拆开，火漆肯定被破坏。收信人就会知道。量子加密很耗资源，是为了军事等绝密级别信息传输准备的技术。用于量子加密传输的信息也只会是密钥。一旦双方确认了彼此的密钥，就可以使用普通通道来传输加密后的密文了。看上去量子加密传输很象终极解决方案，可最近也传出了针对量子加密的成功攻击的 &lt;a class="reference external" href="http://netsecurity.51cto.com/art/201005/202299.htm"&gt;案例&lt;/a&gt; 。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id6"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id13"&gt;常用服务分析&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;这里用抓包方式分析一下常用的网络服务的密码传输，看看它们在安全性方面做的如何&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="33%" /&gt;
&lt;col width="44%" /&gt;
&lt;col width="22%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;网站&lt;/th&gt;
&lt;th class="head"&gt;密码传输方式&lt;/th&gt;
&lt;th class="head"&gt;安全性&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;bitbucket.org&lt;/td&gt;
&lt;td&gt;HTTPS 加密传输&lt;/td&gt;
&lt;td&gt;高&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;微软 live.com&lt;/td&gt;
&lt;td&gt;HTTPS 加密传输&lt;/td&gt;
&lt;td&gt;高&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;google.com&lt;/td&gt;
&lt;td&gt;HTTPS 加密传输&lt;/td&gt;
&lt;td&gt;高&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;开心网 kaixin001.com&lt;/td&gt;
&lt;td&gt;HTTP Javascript 加密传输&lt;/td&gt;
&lt;td&gt;中&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;西祠 xici.com&lt;/td&gt;
&lt;td&gt;HTTP Javascript 加密传输&lt;/td&gt;
&lt;td&gt;中&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;csdn.net&lt;/td&gt;
&lt;td&gt;HTTP Javascript 加密传输&lt;/td&gt;
&lt;td&gt;中&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;javaeye.com&lt;/td&gt;
&lt;td&gt;HTTP 明文传输&lt;/td&gt;
&lt;td&gt;低&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;天涯 tianya.cn&lt;/td&gt;
&lt;td&gt;HTTP 明文传输&lt;/td&gt;
&lt;td&gt;低&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;人人网 renren.com&lt;/td&gt;
&lt;td&gt;HTTP 明文传输&lt;/td&gt;
&lt;td&gt;低&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;对那些既不支持 HTTPS 又不经过客户端加密，而是直接使用 HTTP 明文传送密码的网站，建议不要使用常用的密码来注册，避免安全隐患。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id7"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id14"&gt;小结&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;密码的传输比 &lt;a class="reference external" href="http://zhuoqiang.me/password-storage-and-python-example.html"&gt;密码的存储&lt;/a&gt; 更加敏感和不安全，大致有三个层次的传输策略：&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;使用 HTTPS 加密传输，非常安全。HTTPS 对服务器性能要求高，也影响登录速度。一般用在高安全性的登录上面。Google 和微软的登录都强制使用 HTTPS 确保安全第一&lt;/li&gt;
&lt;li&gt;使用随机密钥对密码进行变换后再传输，相对安全。密码明文很安全，但仍可能发生重放攻击。这种方式是性能和安全性的折中。一般的服务使用足亦，例如国内的开心网&lt;/li&gt;
&lt;li&gt;不做任何修饰，直接将密码明文通过 HTTP 传输。这种方式实现起来非常简单，但却是对用户隐私和数据的不负责任。很可惜，国内几个著名网站都是采用这种简单方式。用户的应对之道就是不要在这些网站上使用常用的密码，例如你银行卡的密码。&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="id9"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id15"&gt;其它&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;密码在传输过程中的泄露的途径很多，你很可能完全没有意识到密码正被窃听。比如最近的一个新闻，骗子用软件对电话按键音进行音频分析，进而得到用户的密码。大概我们在用电话银行时都没有想到，按键的声音居然也是我们密码传输的一种载体吧。&lt;/p&gt;
&lt;p&gt;最近在使用浦发银行的 400 电话服务时，惊奇地发现当系统提示输入密码时，除了听到自己的按键音外，听筒里还有其它的按键音随机的响起。因为这些背景音的干扰，居然让人输入密码时有点手足无措（声音也是种 UI 界面，只是一直被忽略，其实它对用户的重要性一点也不比图形 UI 来的低）&lt;/p&gt;
&lt;p&gt;略一思考，这不正是防止电话按键音泄露银行密码的安全措施吗。浦发连这点都想到了，真是魔高一层道高一丈！&lt;/p&gt;
&lt;/div&gt;
</summary><category term="security"></category><category term="web"></category></entry><entry><title>“一”夫当关：boost::property_tree 的 i18n Bug</title><link href="http://zhuoqiang.me/i18n-bug-in-boost-property_tree.html" rel="alternate"></link><updated>2010-06-16T22:20:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-06-16:i18n-bug-in-boost-property_tree.html</id><summary type="html">&lt;p&gt;i18n 测试常要选用特殊字符。这些字符之所以特殊，全是拜这些字符的编码所赐，比如简单的“一”字。&lt;/p&gt;
&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id6"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id7"&gt;原因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id8"&gt;解&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id5" id="id9"&gt;启发&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;问题&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在做 i18n 测试时，发现程序无法正常解析含有中文的 XML 宽字节流（ &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::wistream&lt;/span&gt;&lt;/tt&gt; ）。分析后发现问题出在 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::property_tree&lt;/span&gt;&lt;/tt&gt; 的 &lt;a class="reference external" href="http://www.boost.org/doc/libs/1_43_0/doc/html/boost/property_tree/xml_parser/read_xml_id939969.html"&gt;read_xml&lt;/a&gt; 函数上。它在解析宽字节流时如果其中含有中文字符“一”，函数会抛出异常，提示在“一”字符处 XML 解析出错。下面的单元测试可以重现这个问题：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;#define BOOST_TEST_MODULE unit_test_for_i18n_case&lt;/span&gt;
&lt;span class="cp"&gt;#include &amp;lt;boost/test/unit_test.hpp&amp;gt;&lt;/span&gt;

&lt;span class="cp"&gt;#include &amp;lt;boost/property_tree/xml_parser.hpp&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;#include &amp;lt;sstream&amp;gt;&lt;/span&gt;

&lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="k"&gt;namespace&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="k"&gt;namespace&lt;/span&gt; &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="n"&gt;BOOST_AUTO_TEST_CASE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;test_i18n_xml_tag_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;wistringstream&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;L&amp;quot;&amp;lt;&lt;/span&gt;&lt;span class="se"&gt;\u4E00&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;abc&amp;lt;/&lt;/span&gt;&lt;span class="se"&gt;\u4E00&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// 一的 Unicode 值&lt;/span&gt;
    &lt;span class="n"&gt;property_tree&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;wptree&lt;/span&gt; &lt;span class="n"&gt;pt&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;BOOST_REQUIRE_NO_THROW&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;property_tree&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;read_xml&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;in&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pt&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
    &lt;span class="n"&gt;BOOST_CHECK&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;L&amp;quot;abc&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;pt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;wstring&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;L&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\u4E00&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;那么，这个“一”到底有何魔力呢？&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;原因&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;我们来看看“一”的 Unicode 编码： &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;L'\\u4E00'&lt;/span&gt;&lt;/tt&gt; ，注意到那个扎眼的 &lt;tt class="docutils literal"&gt;00&lt;/tt&gt; 了吗， 会不会程序将“一”当成了字符串的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;'\\x00'&lt;/span&gt;&lt;/tt&gt; 终结符呢？翻开 Boost 源代码，确实就如猜测的那样， &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::property_tree&lt;/span&gt;&lt;/tt&gt; 在这有一个 bug。&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;property_tree&lt;/tt&gt; 中包含一个简单的 XML 解析器，其中用查表法判断特殊字符，范围包括 255 个 ASCII 扩展字符。对值超过 255 的 Unicode 编码，代码错误地将字符 &lt;tt class="docutils literal"&gt;static_cast&lt;/tt&gt; 成 &lt;tt class="docutils literal"&gt;unsigned char&lt;/tt&gt; 再查表判断。在 &lt;tt class="docutils literal"&gt;rapidxml.hpp&lt;/tt&gt; 中：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// Detect attribute name character&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;attribute_name_pred&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Ch&lt;/span&gt; &lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;lookup_tables&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;::&lt;/span&gt;&lt;span class="n"&gt;lookup_attribute_name&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="k"&gt;static_cast&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;)];&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果被测试的是“一”字，那么经过 &lt;tt class="docutils literal"&gt;static_cast&lt;/tt&gt; ， &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;L'\\u4E00'&lt;/span&gt;&lt;/tt&gt; 就变成了 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;'\\x00'&lt;/span&gt;&lt;/tt&gt; ，一个合法的字符变成了非法的字符串结束符，不经意的类型转换造成了“一”夫当关的现象。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;解&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;直接的解是修正 &lt;tt class="docutils literal"&gt;property_tree&lt;/tt&gt; 中 &lt;tt class="docutils literal"&gt;rapidxml&lt;/tt&gt; 的 bug。对 Unicode 做特殊处理，对值超过 255 的 Unicode 把它当成普通的 ASCII 字母 &lt;tt class="docutils literal"&gt;'z'&lt;/tt&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;template&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Ch&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="kr"&gt;inline&lt;/span&gt; &lt;span class="kt"&gt;size_t&lt;/span&gt; &lt;span class="n"&gt;get_index&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;Ch&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// If not ASCII char, its semantic is same as plain &amp;#39;z&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;z&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再将原来使用 &lt;tt class="docutils literal"&gt;static_cast&lt;/tt&gt; 进行转换的地方都换成使用上面的 &lt;tt class="docutils literal"&gt;get_index&lt;/tt&gt; 函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// Detect attribute name character&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt; &lt;span class="n"&gt;attribute_name_pred&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;unsigned&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Ch&lt;/span&gt; &lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;lookup_tables&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;::&lt;/span&gt;&lt;span class="n"&gt;lookup_attribute_name&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;get_index&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;)];&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我已经给 Boost 提了这个 &lt;a class="reference external" href="https://svn.boost.org/trac/boost/ticket/4340"&gt;问题&lt;/a&gt; ，并且包含了这个 &lt;a class="reference external" href="https://svn.boost.org/trac/boost/attachment/ticket/4340/property_tree_xml_i18n_fix.patch"&gt;Patch&lt;/a&gt; 。新版本的 Boost 已经采纳，修复了该问题。&lt;/p&gt;
&lt;p&gt;如果不能修改 Boost 库，还有个解可以绕过这个问题：不使用宽字符版本的 &lt;tt class="docutils literal"&gt;read_xml&lt;/tt&gt; ，而是先将数据用 UTF-8 编码成窄字节，再直接使用窄字节版本的 &lt;tt class="docutils literal"&gt;read_xml&lt;/tt&gt; 。这个解依赖于 UTF-8 与 ASCII 编码兼容这个特性。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id5"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id9"&gt;启发&lt;/a&gt;&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;所有代码都有可能出问题，哪怕质量很高的 Boost 库&lt;/li&gt;
&lt;li&gt;隐式类型转换不好，显式类型转换同样要小心&lt;/li&gt;
&lt;li&gt;i18n 测试要特别注意编码中含 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;'\\x00'&lt;/span&gt;&lt;/tt&gt; 的宽字节字符，例如 &lt;tt class="docutils literal"&gt;ĀȀ̀Ѐ一帀开怀笀묀밀&lt;/tt&gt; 等，测试用例一定要包含这些特殊字符&lt;/li&gt;
&lt;li&gt;UTF-8 编码与 ASCII 兼容，这个特性让程序更容易迁移到 Unicode。也许正因此，wxWidget 3.0 将会使用 UTF-8 来同时支持 Unicode 和窄字符接口，统一原来的宽窄两套 API&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</summary><category term="boost"></category><category term="c++"></category><category term="i18n"></category></entry><entry><title>用户密码的存储与 Python 示例</title><link href="http://zhuoqiang.me/password-storage-and-python-example.html" rel="alternate"></link><updated>2010-06-13T02:31:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-06-13:password-storage-and-python-example.html</id><summary type="html">&lt;p&gt;在各种线上应用中，用户名密码是用户身份认证的关键，它的重要性不言而喻。一方面，作为保护用户敏感数据的钥匙来说，一旦被破解，系统将敞开大门完全不设防。另一方面，密码这把钥匙本身就是非常敏感的数据：大多数用户会在不同应用中使用近似甚至完全相同的密码。一旦某一个应用的密码被破解，很可能坏人就此掌握了用户的“万能钥匙”，这个用户的其它应用也相当危险了。&lt;/p&gt;
&lt;p&gt;这篇博文就重点讨论对于密码本身的存储的安全性考虑，而系统自身的安全性不在此文的范围之内。&lt;/p&gt;
&lt;p&gt;对于如此重要的用户密码，究竟该怎样在系统中存储呢？&lt;/p&gt;
&lt;p&gt;“君子不立危墙”，对于用户密码这个烫手山芋，一个极端的选择是系统完全不接触密码，用户的身份认证转交受信任的第三方来处理。例如 OpenID 这样的解决方案。系统向受信任的第三方求证用户身份的合法性，用户通过密码向第三方证明自己的身份。&lt;/p&gt;
&lt;p&gt;这样一来，也就不用绞尽脑汁保证密码的安全了。这个作法对用户来说还有个额外的好处：再也不用为每个应用注册帐号了，同一个 OpenID 就可以登录所有支持 OpenID 的系统。&lt;/p&gt;
&lt;p&gt;好虽好，可在今天这样一个裂土封国划地为营的网络战国时代，用户资源不但不能牢牢掌握在自己的手上，还要与别人分享，甚至要受制于人，这多少有点让人难以接受。（据称，现在全球有 27000 个 Web Site 支持 OpenID 登录，虽然还在持续增长中，但在茫茫“网海“中无疑还是属于小众）&lt;/p&gt;
&lt;p&gt;既然网络大同时代还没来临，大部分应用还是要自己负责用户的认证，那密码该如何存储呢？按照安全性由低到高，有这样几种选择：&lt;/p&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p class="first"&gt;密码明文直接存储在系统中&lt;/p&gt;
&lt;p&gt;这种方法下密码的安全性比系统本身还低，管理员能查看所有用户的密码明文。除非是做恶意网站故意套取用户密码，否则不要用这种方式&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;密码明文经过转换后再存储&lt;/p&gt;
&lt;p&gt;与直接存储明文的方式没有本质区别，任何知道或破解出转换方法的人都可以逆转换得到密码明文&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;密码经过对称加密后再存储&lt;/p&gt;
&lt;p&gt;密码明文的安全性等同于加密密钥本身的安全性。对称加密的密钥可同时用于加密与解密。一般它会直接出现在加密代码中，破解的可能性相当大。而且系统管理员很可能知道密钥，进而算出密码原文&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;密码经过非对称加密后再存储&lt;/p&gt;
&lt;p&gt;密码的安全性等同于私钥的安全性。密码明文经过公钥加密。要还原密码明文，必须要相应的私钥才行。因此只要保证私钥的安全，密码明文就安全。私钥可以由某个受信任的人或机构来掌管，身份验证只需要用公钥就可以了&lt;/p&gt;
&lt;p&gt;实际上，这也是 HTTPS/SSL 的理论基础。这里的关键是 &lt;strong&gt;私钥的安全&lt;/strong&gt; ，如果私钥泄露，那密码明文就危险了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上 4 种方法的共同特点是可以从存储的密码形式还原到密码明文。&lt;/p&gt;
&lt;p&gt;当你忘了用户密码后，网站可以很贴心地通过你注册的 email 提醒你原来的密码是什么，那它肯定就是用了上面的某种方法了。这时候你就得小心了：既然网站能知道密码明文，那网站的工作人员就有可能知道，攻入这个网站的黑客也有了还原你密码明文的可能。&lt;/p&gt;
&lt;p&gt;所以密码最好是以不可还原明文的方式来保存。通常利用哈希算法的单向性来保证明文以 &lt;strong&gt;不可还原的有损方式&lt;/strong&gt; 进行存储。&lt;/p&gt;
&lt;p&gt;这类方法的各个具体操作方式按安全性由低到高依次为：&lt;/p&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;p class="first"&gt;使用自己独创的哈希算法对密码进行哈希，存储哈希过的值&lt;/p&gt;
&lt;p&gt;哈希算法复杂，独创对理论要求很高。一般独创的哈希算法肯定没有公开经过时间检验的算法质量高，天才另算&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;使用 MD5 或 SHA-1 哈希算法&lt;/p&gt;
&lt;p&gt;MD5 和 SHA-1 已破解。虽不能还原明文，但很容易找到能生成相同哈希值的替代明文。而且这两个算法速度较快，暴力破解相对省时，建议不要使用它们。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;使用更安全的 SHA-256 等成熟算法&lt;/p&gt;
&lt;p&gt;更加复杂的算法增加了暴力破解的难度。但如果遇到简单密码，用彩虹字典的暴力破解法，很快就能得到密码原文&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;加入随机 salt 的哈希算法&lt;/p&gt;
&lt;p&gt;密码原文（或经过 hash 后的值）和随机生成的 salt 字符串混淆，然后再进行 hash，最后把 hash 值和 salt 值一起存储。验证密码的时候只要用 salt 再与密码原文做一次相同步骤的运算，比较结果与存储的 hash 值就可以了。这样一来哪怕是简单的密码，在进过 salt 混淆后产生的也是很不常见的字符串，根本不会出现在彩虹字典中。salt 越长暴力破解的难度越大&lt;/p&gt;
&lt;p&gt;具体的 hash 过程也可以进行若干次叠代，虽然 hash 叠代会增加碰撞率，但也增加暴力破解的资源消耗。就算真被破解了，黑客掌握的也只是这个随机 salt 混淆过的密码，用户原始密码依然安全，不用担心其它使用相同密码的应用。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;上面这几种方法都不可能得到密码的明文，就算是系统管理员也没办法。对于那些真的忘了密码的用户，网站只能提供重置密码的功能了。&lt;/p&gt;
&lt;p&gt;下面的 python 程序演示了如何使用 salt 加 hash 来单向转换密码明文&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;hashlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;sha256&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;hmac&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HMAC&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;encrypt_password&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Hash password on the fly.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;salt&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;salt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;urandom&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c"&gt;# 64 bits.&lt;/span&gt;

    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;salt&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;salt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;unicode&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;password&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;encode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;UTF-8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;password&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;xrange&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HMAC&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sha256&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;digest&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;salt&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里先随机生成 64 bits 的 salt，再选择 SHA-256 算法使用 &lt;tt class="docutils literal"&gt;HMAC&lt;/tt&gt; 对密码和 salt 进行 10 次叠代混淆，最后将 salt 和 hash 结果一起返回。&lt;/p&gt;
&lt;p&gt;使用的方法很简单：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;hashed&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;encrypt_password&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;secret password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;下面是验证函数，它直接使用 encrypt_password 来对密码进行相同的单向转换并比较&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;validate_password&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hashed&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;input_password&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;hashed&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;encrypt_password&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;input_password&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;hashed&lt;/span&gt;&lt;span class="p"&gt;[:&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;validate_password&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hashed&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;secret password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;虽然只有简短几行，但借助 python 标准库帮助，这已经是一个可用于生产环境的高安全密码加密验证算法了。&lt;/p&gt;
&lt;p&gt;总结一下用户密码的存储：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;上善不战而屈人之兵。如果可能不要存任何密码信息 让别人（OpenID）来帮你做事，避开这个问题&lt;/li&gt;
&lt;li&gt;如果非要自己认证，也只能存 &lt;strong&gt;不可逆的有损密码信息&lt;/strong&gt; 。通过单向 hash 和 salt 来保证只有用户知道密码明文&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;绝对不能存可还原密码原文的信息&lt;/strong&gt; 。如果因为种种原因一定要可还原密码原文，请使用非对称加密，并保管好私钥&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;说完了密码的存储，后面有空会接着聊聊 &lt;a class="reference external" href="http://zhuoqiang.me/password-transport.html"&gt;密码的传输&lt;/a&gt;&lt;/p&gt;
</summary><category term="security"></category><category term="python"></category><category term="web"></category></entry><entry><title>在 Pylons 中使用 MongoDB 的例子</title><link href="http://zhuoqiang.me/use-mongodb-in-pylons.html" rel="alternate"></link><updated>2010-06-01T23:21:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-06-01:use-mongodb-in-pylons.html</id><summary type="html">&lt;p&gt;Pylons 经过漫长的开发，终于放出了 1.0 版本。对于正规的产品开发来说，1.0 版本的意义很大，这表明 Pylons 的 API 终于稳定下来了。&lt;/p&gt;
&lt;p&gt;Pylons 虽是山寨 Rails 而生，但作为一个纯 Python 的 Web 框架，它有一个鲜明的特点：可定制性强。框架每一层都没重新发明轮子，而是尽量整合现有的 Python 库。在 MVC 的 Model 层，Pylons 默认支持 SQLAlchemy。现在 NoSQL 很火 MongoDB 很热。在 Pylons 中应用 MongoDB 也很简单。下面是一个简单的示例。&lt;/p&gt;
&lt;p&gt;在 &lt;tt class="docutils literal"&gt;PROJECT/model/__init__.py&lt;/tt&gt; 中定义 MongoDB 初始化函数和映射对象：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Session&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;schema&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming.orm&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;MappedClass&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming.orm&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;FieldProperty&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ForeignIdProperty&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;RelationProperty&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming.orm&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;ThreadLocalORMSession&lt;/span&gt;

&lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_single_model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;model_class&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;model_class&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__mongometa__&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Page&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MappedClass&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;__mongometa__&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;
        &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;pages&amp;#39;&lt;/span&gt;

    &lt;span class="n"&gt;_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;FieldProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;schema&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ObjectId&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;title&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;FieldProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;FieldProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;
    &lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ThreadLocalORMSession&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;doc_session&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Session&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;init_single_model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Page&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;MappedClass&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile_all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 &lt;tt class="docutils literal"&gt;PROJECT/config/environment.py&lt;/tt&gt; 中进行初始化：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;..model&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;init_model&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;ming.datastore&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;DataStore&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;load_environment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;global_conf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;app_conf&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="o"&gt;...&lt;/span&gt;

    &lt;span class="c"&gt;# Create the Mako TemplateLookup, with the default auto-escaping&lt;/span&gt;
    &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;pylons.app_globals&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;mako_lookup&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TemplateLookup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;directories&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;paths&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;templates&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
        &lt;span class="n"&gt;error_handler&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;handle_mako_error&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;module_directory&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app_conf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;cache_dir&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;templates&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="n"&gt;input_encoding&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;utf-8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;default_filters&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;escape&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
        &lt;span class="n"&gt;imports&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;from webhelpers.html import escape&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="c"&gt;# Setup the mongodb database engine&lt;/span&gt;
    &lt;span class="n"&gt;init_model&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;DataStore&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;database.uri&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]))&lt;/span&gt;

    &lt;span class="c"&gt;# CONFIGURATION OPTIONS HERE (note: all config options will override&lt;/span&gt;
    &lt;span class="c"&gt;# any Pylons config options)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;config&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后在 &lt;tt class="docutils literal"&gt;development.ini&lt;/tt&gt; 中加入 MongoDB 的配置项：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;[app:main]&lt;/span&gt;
&lt;span class="na"&gt;database.uri&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;mongodb://localhost:27017/test&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果需要在程序安装时初始化一些数据, 可以在 &lt;tt class="docutils literal"&gt;PROJECT/websetup.py&lt;/tt&gt; 中加入&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Setup the wukong application&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;logging&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pylons.test&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;.config.environment&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;load_environment&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;.&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;

&lt;span class="n"&gt;log&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;logging&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getLogger&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;__name__&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setup_app&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;vars&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Place any commands to setup wukong here&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="c"&gt;# Don&amp;#39;t reload the app if it was loaded under the testing environment&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;pylons&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;test&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pylonsapp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;load_environment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;global_conf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;local_conf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Adding demo data.&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;page&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Page&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;demo&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;This is for demo.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;model&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flush&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Successfully set up.&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里使用了 Ming 库来连接 MongoDB 并做简单的 ORM。Ming 库是对 PyMongo 的 ORM 包装库。它是 SourceForge 用 TurboGears 和 MongoDB 对网站进行重构的副产物。使用起来有点象 SQLAlchemy ORM 。在上面的示例中，也可以把 Ming 替换成 MongoKit 或其它 MongoDB 的 ORM 库，甚至直接用 PyMongo 也无不可。&lt;/p&gt;
&lt;p&gt;有种感觉，MongoDB 会火。&lt;/p&gt;
</summary><category term="database"></category><category term="python"></category><category term="web"></category></entry><entry><title>DllMain 中的死锁问题</title><link href="http://zhuoqiang.me/deadlock-in-dllmain.html" rel="alternate"></link><updated>2010-05-31T00:46:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-05-31:deadlock-in-dllmain.html</id><summary type="html">&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id5"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id6"&gt;原因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id7"&gt;解&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id8"&gt;教训&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;问题&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;某程序要在动态加载的 DLL 里创建线程，并希望 DLL 在被 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时能自动销毁线程，以实现安全退出。DLL 的实现代码可简写为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Worker&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="nl"&gt;public:&lt;/span&gt;
    &lt;span class="n"&gt;Worker&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;quit_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{}&lt;/span&gt;

    &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;Worker&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;Stop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Work&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="kr"&gt;thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
                &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
                    &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;Worker&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;DoWork&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;)));&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;Stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;quit_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
            &lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reset&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="nl"&gt;private:&lt;/span&gt;
    &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;DoWork&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;quit_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt; &lt;span class="n"&gt;quit_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;DoSomething&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;scoped_ptr&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;boost&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="kr"&gt;thread&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;thread_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="kt"&gt;bool&lt;/span&gt; &lt;span class="k"&gt;volatile&lt;/span&gt; &lt;span class="n"&gt;quit_&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="n"&gt;Worker&lt;/span&gt; &lt;span class="n"&gt;gWorker&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="kr"&gt;__declspec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dllexport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;StartThread&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;gWorker&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Work&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里使用了 C++ 的全局变量和 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;boost::thread&lt;/span&gt;&lt;/tt&gt; 库，并且没有显示定义 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 函数。这种情况下，C++ Runtime 会提供一份隐藏的 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt;，它会在 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时销毁全局变量和静态变量，比如 &lt;tt class="docutils literal"&gt;gWorker&lt;/tt&gt; 对象。 而 &lt;tt class="docutils literal"&gt;Worker&lt;/tt&gt; 类又用 RAII 手法在析构函数中通知并等待线程退出。这样就能保证在 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时 DLL 中创建的线程自动销毁了。该方法很简洁，也应该行的通。但在实际调用 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时，程序在 C++ Runtime 的 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 中发生死锁。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;原因&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;死锁最常见的原因就是多个线程彼此拥有了对方需要的资源，大家都在等对方释放资源好继续运行。从代码层面上来说，就是多个锁的获取顺序不一致：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// A 和 B 拿刀叉的顺序不一样，如果只有一副刀叉，他俩可能都得饿死&lt;/span&gt;
&lt;span class="n"&gt;Thread_A&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;lock_guard&lt;/span&gt; &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mutex_for_fork&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;lock_guard&lt;/span&gt; &lt;span class="nf"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mutex_for_knife&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;Thread_B&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;lock_guard&lt;/span&gt; &lt;span class="n"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mutex_for_knife&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;lock_guard&lt;/span&gt; &lt;span class="nf"&gt;lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mutex_for_fork&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;eat&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;太阳下面无新事， &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 死锁的原因也是一样。原来，微软为了保证多个动态库 load / unload 并发调用的多线程安全，在 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 上加了把 loader lock 全局锁：在 &lt;tt class="docutils literal"&gt;LoadLibrary&lt;/tt&gt; 时，为避免多个线程同时 load 同一个 DLL，系统会先获取 loader lock 锁再进行检查。只有当发现没有加载过该 DLL 时才真正加载这个 DLL 并调用它的 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; ，在这一切做完后再将 loader 锁释放。 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 的时候同样如此。唯有这样，才能保证并发 load/unload DLL 时不出乱子。&lt;/p&gt;
&lt;p&gt;问题来了，DLL 中任意一个线程（包括主线程和派生线程）的退出系统都会调用 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 进行通知。那如果 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 中的代码要是再与其它线程进行同步的话，这就相当于两把锁，极有可能产生死锁。具体到我们的例子，在 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时发生了什么呢&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;主线程中&lt;ol class="arabic"&gt;
&lt;li&gt;获取 loader lock，安全调用 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;通知 worker thread 退出&lt;/li&gt;
&lt;li&gt;使用 &lt;tt class="docutils literal"&gt;WaitForSingleObject&lt;/tt&gt; 等待 worker thread 退出&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;Worker 线程&lt;ol class="arabic"&gt;
&lt;li&gt;收到退出通知&lt;/li&gt;
&lt;li&gt;获取 loader lock，安全调用 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;线程退出&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;换句话说，主线程退出就是先拿了叉子（loader lock），再要拿刀（ &lt;tt class="docutils literal"&gt;WaitForSingleObject&lt;/tt&gt; ）。而工作线程退出就是要先拿叉子（loader lock）才能给你刀（唤醒 &lt;tt class="docutils literal"&gt;WaitForSingleObject&lt;/tt&gt; ）。死锁发生了！&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// 伪代码&lt;/span&gt;
&lt;span class="n"&gt;Main_Thread&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;Lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loader_lock&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;WaitForSingleObject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Worker_Thread&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;Worker_Thread&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;Lock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loader_lock&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;ThreadExit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Worker_Thread&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;微软充分预见到这个危险，在 &lt;cite&gt;Best Practices for Creating DLLs&lt;/cite&gt; 中就详细说明了 loader lock 以及 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 中的编码注意事项，包括禁止在 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 中进行线程同步。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;解&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;没有漂亮的解。建议不提供自动释放线程的功能。既然导出了创建工作线程的函数，那就再导出一个停止线程的函数。Client 要在 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 之前主动调用。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;__declspec&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dllexport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="n"&gt;StopThread&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;gWorker&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Stop&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果仍然希望提供自动清除线程这种安全的便利性，需要的改动是：在主线程 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 中不等待工作线程退出，而是等待工作线程进行必要的清理动作后发出通知再强行终止工作线程；同时，工作线程在通知发出后还要进行无限等待以避免过早退出后进入 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 导致死锁。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kt"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;gQuit&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="n"&gt;Event&lt;/span&gt; &lt;span class="n"&gt;gEvent&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;WorkerThread&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt; &lt;span class="n"&gt;quit_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;DoSomething&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;FinishJob&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;CleanUp&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;SetEvent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gEvent&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// 现在你可以强行终止我了&lt;/span&gt;

    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;// 等待强杀&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;Sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;DllMain&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;gQuit&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;WaitForSingleObject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gEvent&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;TerminateThread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gThreadHandler&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里不推荐这个方案。仅仅为了 client 调用方便就引入这么晦涩的逻辑，费效比低，也不利于代码维护。而且在强杀线程前一定要确认线程所用的资源都处于一致的状态，这个前置条件是颗定时炸弹，对代码维护人员是个考验。&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;教训&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;为了让代码简洁方便又安全，人们发明了很多东西。比如 C++ runtime 自动管理全局变量的生命周期；微软使用 loader lock 保证 DLL 并发加载的安全性；以及我们例子中希望在 &lt;tt class="docutils literal"&gt;FreeLibrary&lt;/tt&gt; 时自动释放工作线程。这些确实方便了代码，但同时，每一个简化都是有代价的：&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;C++ 全局变量初始化和释放的自动管理让调试变的困难，也让初始化和释放的顺序不可控&lt;/li&gt;
&lt;li&gt;微软的 loader lock 让 &lt;tt class="docutils literal"&gt;DllMain&lt;/tt&gt; 的编写多了一些潜规则和禁忌&lt;/li&gt;
&lt;li&gt;要正确实现 DLL 退出时自动释放工作线程的功能，这要化相当的精力，而且代码的可读性和可维护性都有潜在的问题&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;好设计必须充分权衡收益和代价。换言之，本就没有  &lt;cite&gt;好的&lt;/cite&gt; 设计，只有 &lt;cite&gt;合适的&lt;/cite&gt; 设计。&lt;/p&gt;
&lt;/div&gt;
</summary><category term="c++"></category><category term="concurrent"></category></entry><entry><title>setlocale 与 mbstowcs 的问题</title><link href="http://zhuoqiang.me/setlocale-and-mbstowcs-problem.html" rel="alternate"></link><updated>2010-05-21T00:41:00+08:00</updated><author><name>Qiang</name></author><id>tag:zhuoqiang.me,2010-05-21:setlocale-and-mbstowcs-problem.html</id><summary type="html">&lt;div class="contents local topic" id="contents"&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id1" id="id5"&gt;问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id2" id="id6"&gt;原因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id3" id="id7"&gt;解&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference internal" href="#id4" id="id8"&gt;引申&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id5"&gt;问题&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在 Windows XP 多语言简中环境下，用 VC2005 中的 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::fstream&lt;/span&gt;&lt;/tt&gt; 打开中文名文件，系统报错找不到此文件。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ifstream&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\xd6\xd0&lt;/span&gt;&lt;span class="s"&gt;.txt&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// GBK 编码的 &amp;quot;中.txt&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;cerr&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Cannot open file!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="c1"&gt;// Oops!&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id6"&gt;原因&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;在 VC2005 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::fstream&lt;/span&gt;&lt;/tt&gt; 的打开文件的函数实现里，传入的 &lt;tt class="docutils literal"&gt;char const*&lt;/tt&gt; 文件名作为多字节首先被 &lt;tt class="docutils literal"&gt;mbstowcs&lt;/tt&gt; 转换成宽字节后，再转发给 Unicode 版本的 API 进行实际的打开文件操作。见 &lt;tt class="docutils literal"&gt;fiopen.cpp&lt;/tt&gt; ：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;_MRTIMP2_NCEEPURE&lt;/span&gt; &lt;span class="kt"&gt;FILE&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;__CLRCALL_PURE_OR_CDECL&lt;/span&gt; &lt;span class="nf"&gt;_Fiopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;ios_base&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;openmode&lt;/span&gt; &lt;span class="n"&gt;mode&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;prot&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;    &lt;span class="c1"&gt;// open wide-named file with byte name&lt;/span&gt;
    &lt;span class="kt"&gt;wchar_t&lt;/span&gt; &lt;span class="n"&gt;wc_name&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;FILENAME_MAX&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mbstowcs_s&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;wc_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;FILENAME_MAX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;FILENAME_MAX&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;_Fiopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;wc_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;mode&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;prot&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;问题是， &lt;tt class="docutils literal"&gt;mbstowcs&lt;/tt&gt; 函数需要知道编码类型才能正确地将多字节文本转换成宽字节的 unicode，很可惜这个编码类型并没有体现在函数的参数列表里，而是隐含依赖全局的 locale 。更不幸的是，全局 locale 默认没有使用系统当前语言，而是设置为无用的 &lt;tt class="docutils literal"&gt;C&lt;/tt&gt; locale 。于是 GBK 编码的文件名在 &lt;tt class="docutils literal"&gt;C&lt;/tt&gt; locale 下转换出错，悲剧发生了…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id3"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id7"&gt;解&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;知道原因，解就很简单了。在直接或间接调用 &lt;tt class="docutils literal"&gt;mbstowcs&lt;/tt&gt; 函数前，先用 &lt;tt class="docutils literal"&gt;setlocale&lt;/tt&gt; 将全局 locale 设为当前系统默认的 locale&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;setlocale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LC_ALL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果在非中文系统上处理 GBK 编码，就需要明确指定中文 locale&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;setlocale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LC_ALL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;chs&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// chs 是 VC 里简中 locale 的名字&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;还有一种方法，直接使用宽字节版本的打开文件 API。之前的编码由自己转换好，避免系统语言环境设置的影响。在 VS2005 中 &lt;tt class="docutils literal"&gt;fstream&lt;/tt&gt; 有个扩展，可以直接打开宽字节文件名：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ifstream&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;L&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\u4E2D&lt;/span&gt;&lt;span class="s"&gt;.txt&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// UCS2 编码的“中.txt”&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="id4"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#id8"&gt;引申&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;API 隐藏依赖关系是不好的，这意谓着外部环境能通过潜规则来影响 API 的功能。这降低了 API 的复用性、可测性。运行时更容易出现意外错误。进一步设想，如果环境原来的 locale 是被其它代码块故意设置的，为了修正打开中文名文件的 bug 冒然修改全局 locale ，很可能会让依赖于原 locale 工作的代码出现 bug 。在这样的 API 设计下，如果要尽量避免顾此失彼的发生，我们可以在修改 locale 前保存当前的 locale 状态，用完后再将 locale 恢复。我们用 RAII 手法来封装这样的逻辑&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt;  &lt;span class="nc"&gt;scoped_locale&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="nl"&gt;public:&lt;/span&gt;
    &lt;span class="n"&gt;scoped_locale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;amp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;loc_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;_new_locale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loc_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_setted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;false&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;try&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;old_locale&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;setlocale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LC_CTYPE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_new_locale&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;c_str&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;

            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;old_locale&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="n"&gt;_old_locale&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;old_locale&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                &lt;span class="n"&gt;_setted&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
            &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(...)&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;scoped_locale&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;try&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_setted&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="kt"&gt;char&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;pre_locale&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;setlocale&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LC_CTYPE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_old_locale&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;c_str&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;

                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pre_locale&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="p"&gt;{&lt;/span&gt;
                    &lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pre_locale&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;_new_locale&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
                    &lt;span class="n"&gt;_setted&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;false&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                &lt;span class="p"&gt;}&lt;/span&gt;
            &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="p"&gt;(...)&lt;/span&gt;
        &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="nl"&gt;private:&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;_new_locale&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="n"&gt;_old_locale&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="kt"&gt;bool&lt;/span&gt; &lt;span class="n"&gt;_setted&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;原代码可以改为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;scoped_locale&lt;/span&gt; &lt;span class="n"&gt;change_locale_to&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ifstream&lt;/span&gt; &lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\xd6\xd0&lt;/span&gt;&lt;span class="s"&gt;.txt&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;// GBK 编码的“中.txt”&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;cerr&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Cannot open file!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="c1"&gt;// Oops!&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果是多线程环境，还需要查明 locale 的全局性是进程级别还是线程级别的。如果是进程级别，那甚至还会有潜在的进程间相互影响的风险。从这点上来看，C/C++ 标准库中 &lt;tt class="docutils literal"&gt;mbstowcs&lt;/tt&gt; 的设计是有瑕疵的。这也从反面体现了 Dependency Injection 思想的重要性。在 Win32 API 有个类似的函数 &lt;tt class="docutils literal"&gt;WideCharToMultiByte()&lt;/tt&gt; ，它的作用也是进行多字节到宽字节的编码转换，但在 API 设计上，它并不使用全局的 code page 而是要求用户将 code page 作为首个参数显示传入。这样就避免了 &lt;tt class="docutils literal"&gt;mbstowcs&lt;/tt&gt; 的问题。我们可以再将它封装一下，直接对 &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;std::string&lt;/span&gt;&lt;/tt&gt; 做编码转换&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;wstring&lt;/span&gt; &lt;span class="n"&gt;native_to_utf16&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;native_string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;UINT&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;codepage&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CP_ACP&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;DWORD&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;sizeNeeded&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MultiByteToWideChar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;codepage&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;native_string&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;c_str&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

    &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;vector&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="kt"&gt;wchar_t&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;buffer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sizeNeeded&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sc"&gt;L&amp;#39;\0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;MultiByteToWideChar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;codepage&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;native_string&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;c_str&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;buffer&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;buffer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;runtime_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;wrong convertion from native string to utf16&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;wstring&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;buffer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;begin&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;buffer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</summary><category term="c++"></category><category term="i18n"></category></entry></feed>